<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Terminal Corte Hierro</title>
  <!-- PATCH_VERSION: 2026-01-08 FIRESTORE_SYNC -->
  <style>
    :root{
      --bg0:#070a12; --bg1:#0b1430; --card:#0d1b38cc; --card2:#0a162fdd;
      --line:#ffffff1f; --txt:#eaf1ff; --muted:#9bb0d0; --accent:#35b6ff;
      --ok:#2bd671; --warn:#ffcc66; --bad:#ff5a7a;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --r2:22px; --pad:18px; --btnH:74px; --btnH2:64px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--txt); min-height:100vh;
      background:
        radial-gradient(900px 500px at 20% 0%, #19346a66, transparent 55%),
        radial-gradient(800px 500px at 85% 18%, #1b5b7a55, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .app{max-width:1100px;margin:0 auto;padding:18px 18px 36px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:10px 4px 18px}
    .title{display:flex;flex-direction:column;gap:6px}
    .title h1{margin:0;font-size:22px;letter-spacing:.2px}
    .title .sub{color:var(--muted);font-size:13px}
    .hdrRight{display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .badge{font-size:12px;color:#bfe6ff;border:1px solid #3bbcff55;padding:7px 10px;border-radius:999px;background:#061a2b88;white-space:nowrap}
    .tinyBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .tinyBtn{
      height:40px;border-radius:12px;border:1px solid #ffffff22;background:#0b2346;color:var(--txt);
      font-weight:900;font-size:13px;cursor:pointer;padding:0 12px;display:inline-flex;align-items:center;gap:8px;
    }
    .tinyBtn:active{transform:scale(.99)}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:var(--r2);box-shadow:var(--shadow);padding:var(--pad)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    @media (max-width:900px){.grid2,.grid3{grid-template-columns:1fr}.app{padding:14px}.hdrRight{align-items:flex-start}.tinyBtns{justify-content:flex-start}}
    .btn{
      height:var(--btnH); border-radius:18px; border:1px solid #ffffff22; background:#0b2346; color:var(--txt);
      font-size:20px; font-weight:700; letter-spacing:.3px; display:flex; align-items:center; justify-content:center; gap:10px;
      cursor:pointer; user-select:none; transition:transform .06s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
      box-shadow:0 10px 22px rgba(0,0,0,.25); padding:0 14px;
    }
    .btn:active{transform:scale(.985)}
    .btn.primary{background:linear-gradient(180deg,#0d3560,#0a2747);border-color:#49c2ff55}
    .btn.accent{background:linear-gradient(180deg,#0b4a73,#083252);border-color:#49c2ff88}
    .btn.good{background:linear-gradient(180deg,#0c4f33,#083220);border-color:#2bd67188}
    .btn.danger{background:linear-gradient(180deg,#5b1230,#3d0c20);border-color:#ff5a7a88}
    .btn.small{height:var(--btnH2);font-size:18px;border-radius:16px}
    .btn.ghost{background:transparent}
    .btn.disabled{opacity:.35;pointer-events:none}
    .kpi{display:flex;flex-direction:column;gap:5px;padding:14px;border-radius:16px;border:1px solid var(--line);background:#07162f88}
    .kpi .lbl{color:var(--muted);font-size:12px;letter-spacing:.4px;text-transform:uppercase}
    .kpi .val{font-size:22px;font-weight:800}
    .kpi .val.big{font-size:40px;line-height:1}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .sep{height:1px;background:var(--line);margin:14px 0}
    input, select{width:100%;height:56px;border-radius:14px;border:1px solid #ffffff22;background:#061a33;color:var(--txt);padding:0 14px;font-size:18px;outline:none}
    input::placeholder{color:#8ea3c422}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#061a2b88;border:1px solid #49c2ff44;color:#ccecff;font-size:13px}
    .tag{display:inline-flex;align-items:center;justify-content:center;height:28px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:800;letter-spacing:.4px}
    .tag.negro{background:#1c2c46;border:1px solid #ffffff22}
    .tag.galva{background:#0a3a3b;border:1px solid #2bd67155}
    .tag.zero{background:#4a0f23;border:1px solid #ff5a7a66}
    .tag.low{background:#4a3a0f;border:1px solid #ffcc6666}
    .list{display:flex;flex-direction:column;gap:12px;max-height:52vh;overflow:auto;padding-right:6px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:12px;border:1px solid var(--line);background:#07162f88;border-radius:16px;padding:14px}
    .item .left{display:flex;flex-direction:column;gap:6px;min-width:0}
    .item .name{font-weight:900;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .item .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .miniBtn{height:52px;min-width:140px;border-radius:14px;border:1px solid #ffffff22;background:#0b2346;color:var(--txt);font-weight:900;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;padding:0 14px}
    .miniBtn.sel{background:linear-gradient(180deg,#0b4a73,#083252);border-color:#49c2ff88}
    .miniBtn.disabled{opacity:.35;pointer-events:none}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#081a33ee;border:1px solid #49c2ff44;border-radius:16px;padding:12px 14px;display:none;align-items:center;gap:10px;box-shadow:var(--shadow);max-width:min(720px, calc(100vw - 20px));z-index:99}
    .toast.show{display:flex}
    .toast .msg{font-weight:800}
    .toast .undo{margin-left:auto;height:44px;border-radius:12px;border:1px solid #2bd67155;background:#062a1a;color:#d9ffe8;font-weight:900;cursor:pointer;padding:0 14px}
    .muted{color:var(--muted)}
    .opRow{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:14px;border:1px solid var(--line);background:#07162f88}
    .opRow .nm{font-weight:900;font-size:18px}
    .opRow .st{color:var(--muted);font-size:13px}
    .opActions{display:flex;gap:10px;flex-wrap:wrap}
    .opActions button{height:44px;border-radius:12px;border:1px solid #ffffff22;background:#0b2346;color:var(--txt);font-weight:900;cursor:pointer;padding:0 12px}
    .opActions button.danger{background:#3d0c20;border-color:#ff5a7a88}
    .histRow{display:grid;grid-template-columns: 140px 1fr 110px 120px;gap:10px;align-items:center}
    @media (max-width:900px){.histRow{grid-template-columns:1fr}.histRow .c1,.histRow .c2,.histRow .c3,.histRow .c4{width:100%}}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid #ffffff22;background:#061a2b88;font-weight:900}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">
      <h1>Terminal Corte Hierro</h1>
      <div class="sub">Terminal tablet conectado a Stock real (Firestore).</div>
    </div>
    <div class="hdrRight">
      <div class="tinyBtns">
        <button class="tinyBtn" id="btnOps">âš™ Operarios</button>
        <button class="tinyBtn" id="btnHist">ðŸ“‹ Historial</button>
      </div>
      <div class="badge" id="hdrBadge">Sin sesiÃ³n</div>
    </div>
  </header>
  <div id="stepWrap" class="card"></div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">
  <div class="msg" id="toastMsg">AcciÃ³n realizada</div>
  <button class="undo" id="undoBtn">Deshacer</button>
</div>

<!-- Firebase (Compat, sin bundlers) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
(() => {
  const OPS_KEY  = "tablet_ops_hierro_v3_clean";
  const HIST_KEY = "tablet_hist_hierro_v3_clean";
  const HIST_LIMIT = 500;

  // -------------------------
  // Stock real compartido (MISMA KEY LOCAL que stock.html)
  // -------------------------
  const STOCK_DB_KEY = "taller_stock_v3_data";

  // -------------------------
  // FIRESTORE: MISMO PROYECTO + MISMO DOC (taller_stock/main)
  // -------------------------
  const USE_FIRESTORE = true;
  const FIRESTORE_DOC_PATH = { col: "taller_stock", doc: "main" };

  const firebaseConfig = {
    apiKey: "AIzaSyDGIfICSG_KE6QzmKHj3CzgvYeHaUcgARo",
    authDomain: "gestion-taller-2a439.firebaseapp.com",
    projectId: "gestion-taller-2a439",
    storageBucket: "gestion-taller-2a439.firebasestorage.app",
    messagingSenderId: "498579673950",
    appId: "1:498579673950:web:eb626781a5b509957db5cf"
  };

  let fbApp=null, fbAuth=null, fbDb=null;
  let fsUnsub=null;
  let fsReady=false;

  function fbEnsure(){
    if(fbApp) return;
    fbApp = firebase.initializeApp(firebaseConfig);
    fbAuth = firebase.auth();
    fbDb   = firebase.firestore();
  }
  async function fsLoginHidden(){
    try{
      if(!fbAuth.currentUser){
        await fbAuth.signInAnonymously();
      }
    }catch(e){
      console.warn("Auth anÃ³nimo no disponible:", e);
    }
  }
  function fsDocRef(){
    return fbDb.collection(FIRESTORE_DOC_PATH.col).doc(FIRESTORE_DOC_PATH.doc);
  }

  async function fsLoadOnceToLocalStock(){
    const snap = await fsDocRef().get();
    if(!snap.exists) return {ok:false, msg:"No existe el doc en Firestore."};
    const data = snap.data() || {};
    if(!Array.isArray(data.materials) || !Array.isArray(data.movements)){
      return {ok:false, msg:"El doc Firestore no tiene materials/movements vÃ¡lidos."};
    }
    localStorage.setItem(STOCK_DB_KEY, JSON.stringify({
      materials: data.materials || [],
      movements: data.movements || [],
      categoryOrder: data.categoryOrder || []
    }));
    return {ok:true};
  }

  function fsStartRealtimeListener(){
    if(fsUnsub) fsUnsub();
    fsUnsub = fsDocRef().onSnapshot((snap)=>{
      if(!snap.exists) return;
      const data = snap.data() || {};
      if(!Array.isArray(data.materials) || !Array.isArray(data.movements)) return;

      // Cache local para que el terminal lea igual que stock.html
      localStorage.setItem(STOCK_DB_KEY, JSON.stringify({
        materials: data.materials || [],
        movements: data.movements || [],
        categoryOrder: data.categoryOrder || []
      }));

      // Refrescar UI si ya estamos navegando
      refreshMaterialsFromStock();
      setBadge();
      if(state.view === "main"){
        // No forzamos pantalla (para no molestar), pero si estamos en lista/consume, repintamos
        if(state.operator && state.finish && !state.activeMaterialId) screenMaterials();
        if(state.operator && state.finish && state.activeMaterialId) screenConsume();
      }
    }, (err)=>{
      console.warn("Firestore onSnapshot error:", err);
    });
  }

  // -------------------------
  // DB helpers (local cache)
  // -------------------------
  function loadStockDB(){
    try{
      const raw = localStorage.getItem(STOCK_DB_KEY);
      if(!raw) return null;
      const db = JSON.parse(raw);
      if(!db || !Array.isArray(db.materials) || !Array.isArray(db.movements)) return null;
      return db;
    }catch(e){ return null; }
  }

  function saveStockDB(db){
    localStorage.setItem(STOCK_DB_KEY, JSON.stringify(db));
  }

  function getStockFromDB(db, matId){
    return (db.movements||[]).filter(m=>m.matId===matId).reduce((a,m)=> (m.type==='in'? a + Number(m.qty||0) : a - Number(m.qty||0)), 0);
  }

  function isIronMaterial(m){
    const cat = String(m.cat||"").toLowerCase();
    return cat.includes("hierro") || cat.includes("perfil");
  }

  function detectFinish(m){
    const txt = (String(m.name||"") + " " + String(m.grp||"") + " " + String(m.cat||"")).toLowerCase();
    if(txt.includes("galva") || txt.includes("galvan")) return "GALVANIZADO";
    return "NEGRO";
  }

  // MATERIALS (vivo)
  let MATERIALS = [];

  function refreshMaterialsFromStock(){
    const db = loadStockDB();
    if(!db){
      MATERIALS = [];
      return {ok:false, reason:"No existe la base de datos de stock. Abre stock.html una vez para inicializarla."};
    }
    const mats = (db.materials||[]).filter(isIronMaterial);
    MATERIALS = mats.map(m=>{
      const finish = detectFinish(m);
      const stock = getStockFromDB(db, m.id);
      return {
        id: m.id,
        name: m.name,
        finish,
        stock,
        usageCount: 0,
        unit: m.unit || "br"
      };
    });
    return {ok:true};
  }

  // -------------------------
  // ESCRITURA REAL: aÃ±adir movement en Firestore (transaction)
  // -------------------------
  function genId(){
    return Math.random().toString(36).slice(2,11);
  }

  async function applyConsumeToStock(matId, qty){
    if(!USE_FIRESTORE || !fsReady){
      // fallback local (no recomendado)
      const db = loadStockDB();
      if(!db) return {ok:false, msg:"No se pudo cargar el stock local."};
      const current = getStockFromDB(db, matId);
      if(current < qty) return {ok:false, msg:"SIN STOCK: no se puede consumir."};
      const movementId = genId();
      db.movements.push({
        id: movementId,
        matId,
        type: "out",
        qty,
        date: new Date().toISOString(),
        source: "TABLET_HIERRO_LOCAL_FALLBACK",
        sessionId: state.sessionId || "SIN_SESION",
        operator: state.operator || ""
      });
      saveStockDB(db);
      return {ok:true, stockAfter: current-qty, movementId};
    }

    const ref = fsDocRef();
    const movementId = genId();
    try{
      const res = await fbDb.runTransaction(async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists) throw new Error("Firestore doc no existe.");
        const data = snap.data() || {};
        const materials = Array.isArray(data.materials) ? data.materials : [];
        const movements = Array.isArray(data.movements) ? data.movements : [];
        const categoryOrder = Array.isArray(data.categoryOrder) ? data.categoryOrder : [];

        // stock actual por movimientos
        const current = movements.filter(m=>m.matId===matId).reduce((a,m)=> (m.type==="in"? a + Number(m.qty||0) : a - Number(m.qty||0)), 0);
        if(current < qty){
          return {ok:false, msg:"SIN STOCK: no se puede consumir.", current};
        }

        const mv = {
          id: movementId,
          matId,
          type: "out",
          qty,
          date: new Date().toISOString(),
          source: "TABLET_HIERRO",
          device: (navigator.userAgent||""),
          sessionId: state.sessionId || "SIN_SESION",
          operator: state.operator || ""
        };

        movements.push(mv);

        tx.set(ref, {
          materials,
          movements,
          categoryOrder,
          updatedAt: new Date().toISOString()
        }, { merge:true });

        return {ok:true, stockAfter: current-qty, materials, movements, categoryOrder};
      });

      if(!res.ok) return res;

      // Actualiza cache local inmediatamente para que el terminal lo vea al instante
      localStorage.setItem(STOCK_DB_KEY, JSON.stringify({
        materials: res.materials || [],
        movements: res.movements || [],
        categoryOrder: res.categoryOrder || []
      }));

      return {ok:true, stockAfter: res.stockAfter, movementId};

    }catch(e){
      console.warn("No se pudo guardar movimiento en Firestore:", e);
      return {ok:false, msg:"No se pudo guardar en Firestore. Revisa conexiÃ³n/reglas."};
    }
  }

  async function undoConsumeByMovementId(movementId){
    if(!USE_FIRESTORE || !fsReady) return {ok:false, msg:"Firestore no listo."};
    const ref = fsDocRef();
    try{
      const out = await fbDb.runTransaction(async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists) throw new Error("Firestore doc no existe.");
        const data = snap.data() || {};
        const materials = Array.isArray(data.materials) ? data.materials : [];
        const movements = Array.isArray(data.movements) ? data.movements : [];
        const categoryOrder = Array.isArray(data.categoryOrder) ? data.categoryOrder : [];

        const idx = movements.findIndex(m=>m && m.id===movementId);
        if(idx === -1){
          return {ok:false, msg:"No se encontrÃ³ el movimiento para deshacer."};
        }
        movements.splice(idx,1);

        tx.set(ref, {
          materials,
          movements,
          categoryOrder,
          updatedAt: new Date().toISOString()
        }, { merge:true });

        return {ok:true, materials, movements, categoryOrder};
      });

      if(out.ok){
        localStorage.setItem(STOCK_DB_KEY, JSON.stringify({
          materials: out.materials || [],
          movements: out.movements || [],
          categoryOrder: out.categoryOrder || []
        }));
      }
      return out;
    }catch(e){
      console.warn("Undo Firestore fallÃ³:", e);
      return {ok:false, msg:"No se pudo deshacer en Firestore."};
    }
  }

  // -------------------------
  // State + UI
  // -------------------------
  const state = { finish:null, operator:null, activeMaterialId:null, lastAction:null, view:"main", sessionId:null };
  const $wrap = document.getElementById('stepWrap');
  const $badge = document.getElementById('hdrBadge');
  const byId = id => document.getElementById(id);

  const nowISO = () => new Date().toISOString();
  const fmt = (iso) => {
    const d = new Date(iso);
    return d.toLocaleString('es-ES', {hour12:false});
  };

  function newSessionId(){
    return 'S' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
  }

  // -------------------------
  // Operators store (LOCAL)
  // -------------------------
  function loadOps(){
    try{
      const raw = localStorage.getItem(OPS_KEY);
      if(!raw){
        const seed = [];
        localStorage.setItem(OPS_KEY, JSON.stringify(seed));
        return seed;
      }
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr) || !arr.length){
        const seed = [];
        localStorage.setItem(OPS_KEY, JSON.stringify(seed));
        return seed;
      }
      return arr.map(o=>({name:String(o.name||"").trim(), active:o.active!==false})).filter(o=>o.name);
    }catch(e){
      const seed = [];
      localStorage.setItem(OPS_KEY, JSON.stringify(seed));
      return seed;
    }
  }
  function saveOps(list){ localStorage.setItem(OPS_KEY, JSON.stringify(list)); }
  function getActiveOps(){ return loadOps().filter(o=>o.active); }

  // -------------------------
  // History store (LOCAL)
  // -------------------------
  function loadHist(){
    try{
      const raw = localStorage.getItem(HIST_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function saveHist(arr){
    localStorage.setItem(HIST_KEY, JSON.stringify(arr));
  }
  function addHist(entry){
    const arr = loadHist();
    arr.unshift(entry);
    if(arr.length > HIST_LIMIT) arr.length = HIST_LIMIT;
    saveHist(arr);
  }

  // -------------------------
  // UI helpers
  // -------------------------
  function setBadge(){
    const parts=[];
    if(state.finish) parts.push(state.finish);
    if(state.operator) parts.push(state.operator);
    if(state.activeMaterialId){
      const m=MATERIALS.find(x=>x.id===state.activeMaterialId);
      if(m) parts.push("Activo: "+m.name);
    }
    $badge.textContent = parts.length ? parts.join(" Â· ") : "Sin sesiÃ³n";
  }

  function toast(msg, canUndo){
    const t=byId('toast');
    byId('toastMsg').textContent=msg;
    byId('undoBtn').style.display = canUndo ? 'inline-flex':'none';
    t.classList.add('show');
    clearTimeout(toast._tmr);
    toast._tmr=setTimeout(()=>t.classList.remove('show'),8000);
  }

  function detectLowTag(stock){
    if(stock<=0) return ['zero','SIN STOCK'];
    if(stock<=2) return ['low','BAJO'];
    return [null,null];
  }

  function sortMaterials(arr){
    return [...arr].sort((a,b)=>{
      if(b.usageCount!==a.usageCount) return b.usageCount-a.usageCount;
      return a.name.localeCompare(b.name,'es');
    });
  }

  function materialTag(m){
    const cls = m.finish==="NEGRO" ? "negro" : "galva";
    return `<span class="tag ${cls}">${m.finish}</span>`;
  }

  function goBackMain(){
    if(!state.finish) screenFinish();
    else if(!state.operator) screenOperator();
    else if(!state.activeMaterialId) screenMaterials();
    else screenConsume();
  }

  // -------------------------
  // Screens
  // -------------------------
  function screenFinish(){
    refreshMaterialsFromStock();
    state.view="main";
    setBadge();
    $wrap.innerHTML = `
      <div class="row" style="gap:14px">
        <div>
          <div class="pill">Paso 1 Â· Seleccionar tipo de corte</div>
          <div style="margin-top:10px;font-size:28px;font-weight:900">Â¿QuÃ© vas a cortar?</div>
          <div class="hint">Selecciona primero NEGRO o GALVANIZADO. Luego elegirÃ¡s operario y material.</div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="grid2">
        <button class="btn primary" id="btnNegro">HIERRO NEGRO</button>
        <button class="btn good" id="btnGalva">HIERRO GALVANIZADO</button>
      </div>
      <div class="sep"></div>
      <div class="muted">Stock compartido por Firestore Â· Historial local (Ãºltimos ${HIST_LIMIT}).</div>
    `;
    byId('btnNegro').onclick = () => { state.finish="NEGRO"; state.operator=null; state.sessionId=null; state.activeMaterialId=null; screenOperator(); };
    byId('btnGalva').onclick = () => { state.finish="GALVANIZADO"; state.operator=null; state.sessionId=null; state.activeMaterialId=null; screenOperator(); };
  }

  function screenOperator(){
    state.view="main";
    setBadge();
    const ops = getActiveOps().map(o=>`<button class="btn small accent" data-op="${o.name}">${o.name}</button>`).join('');
    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">Paso 2 Â· Operario</div>
          <div style="margin-top:10px;font-size:26px;font-weight:900">Â¿QuiÃ©n estÃ¡ cortando?</div>
          <div class="hint">Pulsa tu nombre. Si es una ayuda puntual, usa "Ocasional".</div>
        </div>
        <button class="btn small ghost" id="backFinish">â¬… Volver</button>
      </div>
      <div class="sep"></div>
      <div class="grid3">${ops || `<div class="muted">No hay operarios. Ve a âš™ Operarios para aÃ±adirlos (lista local en este dispositivo).</div>`}
        <button class="btn small danger" id="btnOcc">OCASIONAL</button>
      </div>
      <div class="sep"></div>
      <div id="occBox" style="display:none">
        <div style="font-weight:900;margin-bottom:10px">Nombre del operario ocasional (obligatorio)</div>
        <div class="grid2">
          <input id="occName" placeholder="Escribe el nombre..."/>
          <button class="btn small primary" id="occOk">Confirmar</button>
        </div>
        <div class="hint">Se registrarÃ¡ este nombre en el historial.</div>
      </div>
    `;
    byId('backFinish').onclick = () => screenFinish();
    [...$wrap.querySelectorAll('[data-op]')].forEach(b=> b.onclick = ()=>{ state.operator=b.getAttribute('data-op'); state.sessionId=newSessionId(); screenMaterials(); });
    byId('btnOcc').onclick = ()=>{ byId('occBox').style.display='block'; byId('occName').focus(); };
    byId('occOk').onclick = ()=>{
      const v=(byId('occName').value||'').trim();
      if(!v){ toast("Debes escribir un nombre para 'Ocasional'.",false); return; }
      state.operator=v; state.sessionId=newSessionId(); screenMaterials();
    };
  }

  function screenMaterials(){
    const r = refreshMaterialsFromStock();
    if(!r.ok){
      state.view='main'; setBadge();
      $wrap.innerHTML = `<div class="row"><div><div class="pill">Stock no disponible</div><div style="margin-top:10px;font-size:26px;font-weight:900">No se puede leer el Stock</div><div class="hint">${escapeHtml(r.reason)}
<br>SoluciÃ³n: abre <b>stock.html</b> (mismo navegador) o revisa sincronizaciÃ³n Firestore.</div></div></div>`;
      return;
    }

    state.view="main";
    setBadge();
    const mats = sortMaterials(MATERIALS.filter(m=>m.finish===state.finish));
    const rows = mats.map(m=>{
      const [cls,lbl]=detectLowTag(m.stock);
      const warnTag = cls ? `<span class="tag ${cls}">${lbl}</span>`:'';
      const disabled = m.stock<=0 ? 'disabled':'';
      return `
        <div class="item">
          <div class="left">
            <div class="name">${m.name}</div>
            <div class="meta">
              ${materialTag(m)}
              ${warnTag}
            </div>
          </div>
          <div class="right">
            <div class="kpi" style="min-width:160px">
              <div class="lbl">Stock</div>
              <div class="val">${m.stock} ${escapeHtml(m.unit||"br")}</div>
            </div>
            <button class="miniBtn sel ${disabled}" data-mat="${m.id}">Seleccionar</button>
          </div>
        </div>
      `;
    }).join('');
    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">Paso 3 Â· Material (${state.finish})</div>
          <div style="margin-top:10px;font-size:26px;font-weight:900">Selecciona el material</div>
          <div class="hint">Los sin stock se muestran pero no se pueden seleccionar.</div>
        </div>
        <div class="row" style="gap:10px">
          <button class="btn small ghost" id="backOp">â¬… Operario</button>
          <button class="btn small ghost" id="chgFinish">â†º Cambiar tipo</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="list">${rows || `<div class="muted">No hay materiales en este tipo.</div>`}</div>
    `;
    byId('backOp').onclick = ()=>screenOperator();
    byId('chgFinish').onclick = ()=>screenFinish();
    [...$wrap.querySelectorAll('[data-mat]')].forEach(b=>{
      b.onclick = ()=>{
        const id=b.getAttribute('data-mat');
        const m=MATERIALS.find(x=>x.id===id);
        if(!m || m.stock<=0){ toast("Sin stock: no se puede seleccionar.",false); return; }
        state.activeMaterialId=id; screenConsume();
      };
    });
  }

  function screenConsume(){
    state.view="main";
    setBadge();
    const m=MATERIALS.find(x=>x.id===state.activeMaterialId);
    if(!m){ screenMaterials(); return; }
    const canUse = m.stock>0;
    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">Activo Â· ${state.finish}</div>
          <div style="margin-top:10px;font-size:28px;font-weight:1000">${m.name}</div>
          <div class="hint">Operario: <b>${state.operator}</b> Â· Fecha: ${new Date().toLocaleString('es-ES', {hour12:false})}</div>
        </div>
        <div class="row" style="gap:10px">
          <button class="btn small ghost" id="chgMat">Cambiar material</button>
          <button class="btn small ghost" id="chgFinish2">Cambiar tipo</button>
          <button class="btn small danger" id="logout">Cerrar sesiÃ³n</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="grid3">
        <div class="kpi"><div class="lbl">Tipo</div><div class="val">${m.finish}</div></div>
        <div class="kpi"><div class="lbl">Stock actual</div><div class="val big">${m.stock}</div><div class="muted">barras</div></div>
        <div class="kpi"><div class="lbl">Sync</div><div class="val">${USE_FIRESTORE && fsReady ? "Firestore OK" : "Local"}</div></div>
      </div>
      <div class="sep"></div>
      <div class="grid2">
        <button class="btn ${canUse ? 'accent':'disabled'}" id="useOne">USAR 1 BARRA</button>
        <button class="btn small ghost" id="info">Ver resumen</button>
      </div>
      <div class="hint">Cada pulsaciÃ³n queda registrada en ðŸ“‹ Historial (mÃ¡x. ${HIST_LIMIT}) y descuenta en Stock (Firestore).</div>
    `;
    byId('chgMat').onclick = ()=>screenMaterials();
    byId('chgFinish2').onclick = ()=>screenFinish();
    byId('logout').onclick = ()=>{ state.operator=null; state.sessionId=null; state.activeMaterialId=null; screenOperator(); };
    byId('info').onclick = ()=>toast(`Activo: ${m.name} Â· Stock: ${m.stock}`,false);

    let lock=false;
    byId('useOne').onclick = async ()=>{
      if(lock) return;
      if(m.stock<=0){ toast("SIN STOCK: no se puede consumir.",false); return; }
      lock=true; setTimeout(()=>lock=false,850);

      const beforeStock = m.stock;

      // 1) escribir en Firestore (movement out)
      const res = await applyConsumeToStock(m.id, 1);
      if(!res.ok){
        toast(res.msg||"No se pudo descontar.", false);
        return;
      }

      // 2) refrescar desde cache (ya actualizado) / snapshot
      refreshMaterialsFromStock();
      const mm = MATERIALS.find(x=>x.id===m.id);
      if(mm) m.stock = mm.stock;

      // 3) guardar lastAction para undo real (por movementId)
      state.lastAction = { matId:m.id, movementId: res.movementId, stockBefore: beforeStock };

      // 4) history local (solo registro UI)
      addHist({
        ts: nowISO(),
        operator: state.operator,
        finish: m.finish,
        materialId: m.id,
        materialName: m.name,
        delta: -1,
        stockBefore: beforeStock,
        stockAfter: res.stockAfter,
        device: "TERMINAL_HIERRO",
        sessionId: state.sessionId || "SIN_SESION",
        movementId: res.movementId
      });

      toast(`Descontada 1 barra (${res.stockAfter} restantes).`, true);
      screenConsume();
    };
  }

  // -------------------------
  // Operarios
  // -------------------------
  function screenOps(){
    state.view="ops";
    setBadge();
    const ops = loadOps();
    const rows = ops.map((o,i)=>`
      <div class="opRow">
        <div>
          <div class="nm">${o.name}</div>
          <div class="st">${o.active ? "Activo" : "Inactivo"}</div>
        </div>
        <div class="opActions">
          <button data-tgl="${i}">${o.active ? "Desactivar" : "Activar"}</button>
          <button class="danger" data-del="${i}">Eliminar</button>
        </div>
      </div>
    `).join("");
    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">âš™ GestiÃ³n de operarios (local)</div>
          <div style="margin-top:10px;font-size:24px;font-weight:900">AÃ±adir, activar/desactivar o eliminar</div>
          <div class="hint">Lista local por dispositivo. (Si quieres, lo sincronizamos a Firestore en un siguiente paso.)</div>
        </div>
        <button class="btn small ghost" id="backMain">â¬… Volver</button>
      </div>
      <div class="sep"></div>
      <div class="grid2">
        <input id="newOp" placeholder="Nuevo operario (nombre)"/>
        <button class="btn small primary" id="addOp">AÃ±adir</button>
      </div>
      <div class="sep"></div>
      <div class="list" style="max-height:48vh">${rows || `<div class="muted">No hay operarios.</div>`}</div>
      <div class="sep"></div>
      <button class="btn small danger" id="resetOps">Vaciar lista</button>
    `;
    byId('backMain').onclick = () => goBackMain();
    byId('addOp').onclick = () => {
      const v = (byId('newOp').value||"").trim();
      if(!v){ toast("Escribe un nombre.", false); return; }
      const cur = loadOps();
      if(cur.some(x=>x.name.toLowerCase()===v.toLowerCase())){
        toast("Ya existe un operario con ese nombre.", false); return;
      }
      cur.push({name:v, active:true});
      saveOps(cur);
      toast("Operario aÃ±adido.", false);
      screenOps();
    };
    $wrap.querySelectorAll("[data-tgl]").forEach(btn=>{
      btn.onclick = () => {
        const idx = parseInt(btn.getAttribute("data-tgl"),10);
        const cur = loadOps();
        if(!cur[idx]) return;
        cur[idx].active = !cur[idx].active;
        saveOps(cur);
        toast(cur[idx].active ? "Operario activado." : "Operario desactivado.", false);
        screenOps();
      };
    });
    $wrap.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = () => {
        const idx = parseInt(btn.getAttribute("data-del"),10);
        const cur = loadOps();
        if(!cur[idx]) return;
        const name = cur[idx].name;
        if(!confirm(`Eliminar operario "${name}"?`)) return;
        cur.splice(idx,1);
        saveOps(cur);
        toast("Operario eliminado.", false);
        screenOps();
      };
    });
    byId('resetOps').onclick = () => {
      if(!confirm("Restaurar la lista de operarios por defecto?")) return;
      saveOps([]);
      toast("Operarios limpiados.", false);
      screenOps();
    };
  }

  // -------------------------
  // Historial
  // -------------------------
  function screenHist(){
    state.view="hist";
    setBadge();
    const hist = loadHist();

    const ops = Array.from(new Set(hist.map(h=>h.operator))).sort((a,b)=>a.localeCompare(b,'es'));
    const opOptions = ['<option value="">(Todos)</option>'].concat(ops.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`)).join('');

    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">ðŸ“‹ Historial (Ãºltimos ${HIST_LIMIT})</div>
          <div style="margin-top:10px;font-size:24px;font-weight:900">Registro de consumos</div>
          <div class="hint">Este historial es local. El stock real se descuenta en Firestore.</div>
        </div>
        <button class="btn small ghost" id="backMain">â¬… Volver</button>
      </div>

      <div class="sep"></div>

      <div class="grid3">
        <div class="kpi">
          <div class="lbl">Registros</div>
          <div class="val">${hist.length}</div>
        </div>
        <div class="kpi">
          <div class="lbl">Ãšltimo registro</div>
          <div class="val">${hist[0] ? fmt(hist[0].ts) : "-"}</div>
        </div>
        <div class="kpi">
          <div class="lbl">LÃ­mite</div>
          <div class="val">${HIST_LIMIT}</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="grid3">
        <div>
          <div class="hint" style="margin:0 0 8px">Operario</div>
          <select id="fOp">${opOptions}</select>
        </div>
        <div>
          <div class="hint" style="margin:0 0 8px">Tipo</div>
          <select id="fFin">
            <option value="">(Todos)</option>
            <option value="NEGRO">NEGRO</option>
            <option value="GALVANIZADO">GALVANIZADO</option>
          </select>
        </div>
        <div>
          <div class="hint" style="margin:0 0 8px">Buscar material</div>
          <input id="fTxt" placeholder="Ej: tubo 40x40"/>
        </div>
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <button class="btn small primary" id="btnExport">Exportar JSON</button>
        <button class="btn small danger" id="btnClear">Borrar historial</button>
      </div>

      <div class="sep"></div>

      <div id="histList" class="list" style="max-height:46vh"></div>
    `;

    byId('backMain').onclick = () => goBackMain();
    byId('btnExport').onclick = () => exportHist();
    byId('btnClear').onclick = () => {
      if(!confirm("Borrar todo el historial local?")) return;
      saveHist([]);
      toast("Historial borrado.", false);
      screenHist();
    };

    const render = () => {
      const op = byId('fOp').value;
      const fin = byId('fFin').value;
      const txt = (byId('fTxt').value||"").trim().toLowerCase();

      const filtered = hist.filter(h=>{
        if(op && h.operator !== op) return false;
        if(fin && h.finish !== fin) return false;
        if(txt && !(String(h.materialName||"").toLowerCase().includes(txt))) return false;
        return true;
      });

      const map = new Map();
      filtered.forEach(h=>{
        const key = [h.operator, h.sessionId||"SIN_SESION", h.finish, h.materialId].join("||");
        if(!map.has(key)){
          map.set(key, {
            operator: h.operator,
            sessionId: h.sessionId||"SIN_SESION",
            finish: h.finish,
            materialId: h.materialId,
            materialName: h.materialName,
            total: 0,
            firstTs: h.ts,
            lastTs: h.ts,
            stockStart: h.stockBefore,
            stockEnd: h.stockAfter
          });
        }
        const g = map.get(key);
        g.total += (h.delta||0);
        if(h.ts < g.firstTs){
          g.firstTs = h.ts;
          g.stockStart = h.stockBefore;
        }
        if(h.ts > g.lastTs){
          g.lastTs = h.ts;
          g.stockEnd = h.stockAfter;
        }
      });

      const groups = Array.from(map.values()).sort((a,b)=> (b.lastTs||"").localeCompare(a.lastTs||""));

      byId('histList').innerHTML = groups.map(g=>{
        const finCls = g.finish==="NEGRO" ? "negro" : "galva";
        const totalAbs = Math.abs(g.total);
        return `
          <div class="item">
            <div class="left">
              <div class="name">${escapeHtml(g.materialName)}</div>
              <div class="meta">
                <span class="tag ${finCls}">${escapeHtml(g.finish)}</span>
                <span class="chip">${escapeHtml(g.operator)}</span>
                <span class="muted">SesiÃ³n: ${escapeHtml(g.sessionId)}</span>
                <span class="muted">${fmt(g.firstTs)} â†’ ${fmt(g.lastTs)}</span>
              </div>
            </div>
            <div class="right">
              <div class="kpi" style="min-width:170px">
                <div class="lbl">Barras usadas</div>
                <div class="val">-${totalAbs}</div>
              </div>
              <div class="kpi" style="min-width:200px">
                <div class="lbl">Stock (segÃºn registro)</div>
                <div class="val">${g.stockStart} â†’ <b>${g.stockEnd}</b></div>
              </div>
            </div>
          </div>
        `;
      }).join("") || `<div class="muted">No hay resultados con estos filtros.</div>`;
    };

    ["fOp","fFin","fTxt"].forEach(id=>{
      byId(id).addEventListener("input", render);
      byId(id).addEventListener("change", render);
    });

    render();
  }

  function exportHist(){
    const hist = loadHist();
    const blob = new Blob([JSON.stringify(hist, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "historial_cortes_hierro.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
    toast("ExportaciÃ³n iniciada.", false);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  }

  // -------------------------
  // Undo (DESHACE EN FIRESTORE + QUITA HIST LOCAL)
  // -------------------------
  byId('undoBtn').onclick = async ()=>{
    const la=state.lastAction; if(!la) return;
    if(!la.movementId){
      toast("No hay movimiento para deshacer.", false);
      return;
    }

    const res = await undoConsumeByMovementId(la.movementId);
    if(!res.ok){
      toast(res.msg || "No se pudo deshacer en Firestore.", false);
      return;
    }

    // quitar primer historial si coincide con movementId
    const hist = loadHist();
    if(hist[0] && hist[0].movementId === la.movementId){
      hist.shift();
      saveHist(hist);
    }

    state.lastAction=null;

    refreshMaterialsFromStock();
    toast("AcciÃ³n deshecha (stock restaurado).",false);
    goBackMain();
  };

  // Header buttons
  document.getElementById("btnOps").onclick  = () => screenOps();
  document.getElementById("btnHist").onclick = () => screenHist();

  // Start
  (async () => {
    try{
      if(USE_FIRESTORE){
        fbEnsure();
        await fsLoginHidden();
        const r = await fsLoadOnceToLocalStock();
        if(!r.ok){
          console.warn("Carga Firestore inicial fallÃ³:", r.msg);
        }
        fsReady = true;
        fsStartRealtimeListener();
      }
    }catch(e){
      console.warn("Init Firestore fallÃ³:", e);
      fsReady = false;
    }

    screenFinish();
  })();

})();
</script>
</body>
</html>
