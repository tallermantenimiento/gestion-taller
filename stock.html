<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock Taller v7.2 - AutoSync Firestore</title>
  <!-- PATCH_VERSION: 2026-01-08 STOCK_AUTOSYNC_FIRESTORE -->
  <style>
    :root{
      --bg0:#070a12; --bg1:#0b1430; --card:#0d1b38cc; --card2:#0a162fdd;
      --line:#ffffff1f; --txt:#eaf1ff; --muted:#9bb0d0; --accent:#35b6ff;
      --ok:#2bd671; --warn:#ffcc66; --bad:#ff5a7a;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --r2:22px; --pad:18px; --btnH:74px; --btnH2:64px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--txt); min-height:100vh;
      background:
        radial-gradient(900px 500px at 20% 0%, #19346a66, transparent 55%),
        radial-gradient(800px 500px at 85% 18%, #1b5b7a55, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .app{max-width:1100px;margin:0 auto;padding:18px 18px 36px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:10px 4px 18px}
    .title{display:flex;flex-direction:column;gap:6px}
    .title h1{margin:0;font-size:22px;letter-spacing:.2px}
    .title .sub{color:var(--muted);font-size:13px}
    .hdrRight{display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .badge{font-size:12px;color:#bfe6ff;border:1px solid #3bbcff55;padding:7px 10px;border-radius:999px;background:#061a2b88;white-space:nowrap}
    .tinyBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .tinyBtn{
      height:40px;border-radius:12px;border:1px solid #ffffff22;background:#0b2346;color:var(--txt);
      font-weight:900;font-size:13px;cursor:pointer;padding:0 12px;display:inline-flex;align-items:center;gap:8px;
    }
    .tinyBtn:active{transform:scale(.99)}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:var(--r2);box-shadow:var(--shadow);padding:var(--pad)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    @media (max-width:900px){.grid2,.grid3{grid-template-columns:1fr}.app{padding:14px}.hdrRight{align-items:flex-start}.tinyBtns{justify-content:flex-start}}
    .btn{
      height:var(--btnH); border-radius:18px; border:1px solid #ffffff22; background:#0b2346; color:var(--txt);
      font-size:20px; font-weight:700; letter-spacing:.3px; display:flex; align-items:center; justify-content:center; gap:10px;
      cursor:pointer; user-select:none; transition:transform .06s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
      box-shadow:0 10px 22px rgba(0,0,0,.25); padding:0 14px;
    }
    .btn:active{transform:scale(.985)}
    .btn.primary{background:linear-gradient(180deg,#0d3560,#0a2747);border-color:#49c2ff55}
    .btn.accent{background:linear-gradient(180deg,#0b4a73,#083252);border-color:#49c2ff88}
    .btn.good{background:linear-gradient(180deg,#0c4f33,#083220);border-color:#2bd67188}
    .btn.danger{background:linear-gradient(180deg,#5b1230,#3d0c20);border-color:#ff5a7a88}
    .btn.small{height:var(--btnH2);font-size:18px;border-radius:16px}
    .btn.ghost{background:transparent}
    .btn.disabled{opacity:.35;pointer-events:none}
    .kpi{display:flex;flex-direction:column;gap:5px;padding:14px;border-radius:16px;border:1px solid var(--line);background:#07162f88}
    .kpi .lbl{color:var(--muted);font-size:12px;letter-spacing:.4px;text-transform:uppercase}
    .kpi .val{font-size:22px;font-weight:800}
    .kpi .val.big{font-size:40px;line-height:1}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .sep{height:1px;background:var(--line);margin:14px 0}
    input, select{width:100%;height:56px;border-radius:14px;border:1px solid #ffffff22;background:#061a33;color:var(--txt);padding:0 14px;font-size:18px;outline:none}
    input::placeholder{color:#8ea3c422}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#061a2b88;border:1px solid #49c2ff44;color:#ccecff;font-size:13px}
    .tag{display:inline-flex;align-items:center;justify-content:center;height:28px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:800;letter-spacing:.4px}
    .tag.negro{background:#1c2c46;border:1px solid #ffffff22}
    .tag.galva{background:#0a3a3b;border:1px solid #2bd67155}
    .tag.zero{background:#4a0f23;border:1px solid #ff5a7a66}
    .tag.low{background:#4a3a0f;border:1px solid #ffcc6666}
    .list{display:flex;flex-direction:column;gap:12px;max-height:52vh;overflow:auto;padding-right:6px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:12px;border:1px solid var(--line);background:#07162f88;border-radius:16px;padding:14px}
    .item .left{display:flex;flex-direction:column;gap:6px;min-width:0}
    .item .name{font-weight:900;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .item .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .miniBtn{height:52px;min-width:140px;border-radius:14px;border:1px solid #ffffff22;background:#0b2346;color:var(--txt);font-weight:900;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;padding:0 14px}
    .miniBtn.sel{background:linear-gradient(180deg,#0b4a73,#083252);border-color:#49c2ff88}
    .miniBtn.disabled{opacity:.35;pointer-events:none}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#081a33ee;border:1px solid #49c2ff44;border-radius:16px;padding:12px 14px;display:none;align-items:center;gap:10px;box-shadow:var(--shadow);max-width:min(720px, calc(100vw - 20px));z-index:99}
    .toast.show{display:flex}
    .toast .msg{font-weight:800}
    .toast .undo{margin-left:auto;height:44px;border-radius:12px;border:1px solid #2bd67155;background:#062a1a;color:#d9ffe8;font-weight:900;cursor:pointer;padding:0 14px}
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid #ffffff22;background:#061a2b88;font-weight:900}
  </style>
</head>
<body>

<div class="app">
  <header>
    <div class="title">
      <h1>Stock Taller v7.2</h1>
      <div class="sub">AutoSync con Firestore (sin botón).</div>
    </div>
    <div class="hdrRight">
      <div class="tinyBtns">
        <button class="tinyBtn" id="btnExport">⬇ Exportar</button>
        <button class="tinyBtn" id="btnImport">⬆ Importar</button>
      </div>
      <div class="badge" id="hdrBadge">Cargando...</div>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <div class="pill">Stock</div>
        <div class="hint">Este stock se guarda en localStorage y se sincroniza automáticamente con Firestore.</div>
      </div>
    </div>
    <div class="sep"></div>

    <!-- Aquí va tu UI de stock (árbol, grid, etc.) tal como en el archivo base -->
    <div id="tree"></div>
    <div id="summary"></div>
    <div id="grid"></div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">
  <div class="msg" id="toastMsg">Acción realizada</div>
  <button class="undo" id="undoBtn">Deshacer</button>
</div>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/** STOCK TALLER v7.2 + AUTOSYNC FIRESTORE
 *  - Mantiene DB local (localStorage) como cache
 *  - Se sincroniza SOLO (sin botón) con Firestore
 *
 *  NOTA: ya está pegado tu firebaseConfig real aquí abajo.
 */

// ====== CONFIG ======
const USE_FIRESTORE = true;
const FIRESTORE_DOC_PATH = { col: "taller_stock", doc: "main" };

const firebaseConfig = {
  apiKey: "AIzaSyDGIfICSG_KE6QzmKHj3CzgvYeHaUcgARo",
  authDomain: "gestion-taller-2a439.firebaseapp.com",
  projectId: "gestion-taller-2a439",
  storageBucket: "gestion-taller-2a439.firebasestorage.app",
  messagingSenderId: "498579673950",
  appId: "1:498579673950:web:eb626781a5b509957db5cf"
};

// ====== DB LOCAL ======
const DB_KEY="taller_stock_v3_data";
let materials=[], movements=[], categoryOrder=[];
let currentFilter={cat:null,grp:null,status:null};

// ====== FIRESTORE HELPERS ======
let fbApp=null, fbAuth=null, fbDb=null;
let fsUnsub=null;
let fsReady=false;
let ignoreNextLocalSave=false;
let pendingSaveTimer=null;

const $=id=>document.getElementById(id);
const uuid=()=>Math.random().toString(36).substr(2,9);

function toast(msg){
  const t=$('toast');
  $('toastMsg').textContent=msg;
  $('undoBtn').style.display='none';
  t.classList.add('show');
  clearTimeout(toast._tmr);
  toast._tmr=setTimeout(()=>t.classList.remove('show'),4000);
}

function setBadge(txt){ $('hdrBadge').textContent = txt; }

function fbEnsure(){
  if(fbApp) return;
  fbApp = firebase.initializeApp(firebaseConfig);
  fbAuth = firebase.auth();
  fbDb   = firebase.firestore();
}

async function fsLoginHidden(){
  await fbAuth.signInAnonymously();
}

function fsDocRef(){
  return fbDb.collection(FIRESTORE_DOC_PATH.col).doc(FIRESTORE_DOC_PATH.doc);
}

async function fsLoadOnceToLocal(){
  const snap = await fsDocRef().get();
  if(!snap.exists) return false;
  const data = snap.data() || {};
  if(!data.materials || !data.movements) return false;

  ignoreNextLocalSave = true;
  localStorage.setItem(DB_KEY, JSON.stringify({
    materials: data.materials || [],
    movements: data.movements || [],
    categoryOrder: data.categoryOrder || []
  }));
  ignoreNextLocalSave = false;

  materials = data.materials || [];
  movements = data.movements || [];
  categoryOrder = data.categoryOrder || [];
  return true;
}

function fsStartRealtimeListener(){
  if(fsUnsub) fsUnsub();
  fsUnsub = fsDocRef().onSnapshot((snap)=>{
    if(!snap.exists) return;
    const data = snap.data() || {};
    if(!data.materials || !data.movements) return;

    ignoreNextLocalSave = true;
    localStorage.setItem(DB_KEY, JSON.stringify({
      materials: data.materials || [],
      movements: data.movements || [],
      categoryOrder: data.categoryOrder || []
    }));
    ignoreNextLocalSave = false;

    materials = data.materials || [];
    movements = data.movements || [];
    categoryOrder = data.categoryOrder || [];

    renderAll();
    setBadge("Sincronizado");
  }, (err)=>{
    console.warn("Firestore onSnapshot error:", err);
    setBadge("Error Firestore");
  });
}

function scheduleFsSave(){
  if(!USE_FIRESTORE || !fsReady) return;
  if(ignoreNextLocalSave) return;

  clearTimeout(pendingSaveTimer);
  pendingSaveTimer = setTimeout(async ()=>{
    try{
      const payload = { materials, movements, categoryOrder, updatedAt: new Date().toISOString() };
      await fsDocRef().set(payload, { merge: true });
      setBadge("Sincronizado");
    }catch(e){
      console.warn("No se pudo guardar en Firestore:", e);
      setBadge("Sin conexión");
    }
  }, 450);
}

function saveData(){
  localStorage.setItem(DB_KEY, JSON.stringify({materials,movements,categoryOrder}));
  scheduleFsSave();
}

function loadLocal(){
  const d=localStorage.getItem(DB_KEY);
  if(!d) return;
  try{
    const p=JSON.parse(d);
    materials=p.materials||[];
    movements=p.movements||[];
    categoryOrder=p.categoryOrder||[];
  }catch(e){
    materials=[]; movements=[]; categoryOrder=[];
  }
}

// ====== UI mínima (placeholder) ======
function renderTree(){ $('tree').innerHTML = `<div class="muted">Árbol categorías (tu UI original va aquí)</div>`; }
function renderSummary(){ $('summary').innerHTML = `<div class="muted">Resumen (tu UI original va aquí)</div>`; }
function renderGrid(){ $('grid').innerHTML = `<div class="muted">Grid (tu UI original va aquí)</div>`; }
function renderAll(){ renderTree(); renderSummary(); renderGrid(); }

// ====== INIT ======
async function initWithSync(){
  setBadge("Cargando...");
  loadLocal();
  renderAll();

  if(USE_FIRESTORE){
    try{
      fbEnsure();
      await fsLoginHidden();
      const ok = await fsLoadOnceToLocal();
      fsReady = true;
      fsStartRealtimeListener();

      if(!ok){
        // Si no existe aún en Firestore, subimos lo local (o semilla mínima)
        if(!materials.length){
          materials=[
            {id:uuid(),cat:"Soldadura, Corte y Desbaste",grp:"Discos",name:"Disco 115mm",unit:"ud",min:10},
            {id:uuid(),cat:"Soldadura, Corte y Desbaste",grp:"Electrodos",name:"Electrodo 2.5mm",unit:"caja",min:2},
            {id:uuid(),cat:"Hierro",grp:"Tubos",name:"Tubo 40x40",unit:"br",min:5}
          ];
          movements=[];
        }
        await fsDocRef().set({ materials, movements, categoryOrder, createdAt: new Date().toISOString() }, { merge: true });
      }

      setBadge("Sincronizado");
    }catch(e){
      console.warn("Firestore no disponible, seguimos en local:", e);
      fsReady = false;
      setBadge("Modo local");
    }
  }else{
    setBadge("Modo local");
  }
}

initWithSync();
</script>
</body>
</html>
