<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Stock Taller v7.2 - AutoSync Firestore</title>
<!-- PATCH_VERSION: 2026-01-08 STOCK_AUTOSYNC_FIRESTORE -->
<style>
/* (MISMO CSS QUE TU ARCHIVO) */

    :root{
      --bg0:#070a12; --bg1:#0b1430; --card:#0d1b38cc; --card2:#0a162fdd;
      --line:#ffffff1f; --txt:#eaf1ff; --muted:#9bb0d0; --accent:#35b6ff;
      --ok:#2bd671; --warn:#ffcc66; --bad:#ff5a7a;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --r2:22px; --pad:18px; --btnH:74px; --btnH2:64px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--txt); min-height:100vh;
      background:
        radial-gradient(900px 500px at 20% 0%, #19346a66, transparent 55%),
        radial-gradient(800px 500px at 85% 18%, #1b5b7a55, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .app{max-width:1100px;margin:0 auto;padding:18px 18px 36px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:10px 4px 18px}
    .title{display:flex;flex-direction:column;gap:6px}
    .title h1{margin:0;font-size:22px;letter-spacing:.2px}
    .title .sub{color:var(--muted);font-size:13px}
    .hdrRight{display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .badge{font-size:12px;color:#bfe6ff;border:1px solid #3bbcff55;padding:7px 10px;border-radius:999px;background:#061a2b88;white-space:nowrap}
    .tinyBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .tinyBtn{
      height:40px;border-radius:12px;border:1px solid #ffffff22;background:#0b2346;color:var(--txt);
      font-weight:900;font-size:13px;cursor:pointer;padding:0 12px;display:inline-flex;align-items:center;gap:8px;
    }
    .tinyBtn:active{transform:scale(.99)}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:var(--r2);box-shadow:var(--shadow);padding:var(--pad)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    @media (max-width:900px){.grid2,.grid3{grid-template-columns:1fr}.app{padding:14px}.hdrRight{align-items:flex-start}.tinyBtns{justify-content:flex-start}}
    .btn{
      height:var(--btnH); border-radius:18px; border:1px solid #ffffff22; background:#0b2346; color:var(--txt);
      font-size:20px; font-weight:700; letter-spacing:.3px; display:flex; align-items:center; justify-content:center; gap:10px;
      cursor:pointer; user-select:none; transition:transform .06s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
      box-shadow:0 10px 22px rgba(0,0,0,.25); padding:0 14px;
    }
    .btn:active{transform:scale(.985)}
    .btn.primary{background:linear-gradient(180deg,#0d3560,#0a2747);border-color:#49c2ff55}
    .btn.accent{background:linear-gradient(180deg,#0b4a73,#083252);border-color:#49c2ff88}
    .btn.good{background:linear-gradient(180deg,#0c4f33,#083220);border-color:#2bd67188}
    .btn.danger{background:linear-gradient(180deg,#5b1230,#3d0c20);border-color:#ff5a7a88}
    .btn.small{height:var(--btnH2);font-size:18px;border-radius:16px}
    .btn.ghost{background:transparent}
    .btn.disabled{opacity:.35;pointer-events:none}
    .kpi{display:flex;flex-direction:column;gap:5px;padding:14px;border-radius:16px;border:1px solid var(--line);background:#07162f88}
    .kpi .lbl{color:var(--muted);font-size:12px;letter-spacing:.4px;text-transform:uppercase}
    .kpi .val{font-size:22px;font-weight:800}
    .kpi .val.big{font-size:40px;line-height:1}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .sep{height:1px;background:var(--line);margin:14px 0}
    input, select{width:100%;height:56px;border-radius:14px;border:1px solid #ffffff22;background:#061a33;color:var(--txt);padding:0 14px;font-size:18px;outline:none}
    input::placeholder{color:#8ea3c422}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#061a2b88;border:1px solid #49c2ff44;color:#ccecff;font-size:13px}
    .tag{display:inline-flex;align-items:center;justify-content:center;height:28px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:800;letter-spacing:.4px}
    .tag.negro{background:#1c2c46;border:1px solid #ffffff22}
    .tag.galva{background:#0a3a3b;border:1px solid #2bd67155}
    .tag.zero{background:#4a0f23;border:1px solid #ff5a7a66}
    .tag.low{background:#4a3a0f;border:1px solid #ffcc6666}
    .list{display:flex;flex-direction:column;gap:12px;max-height:52vh;overflow:auto;padding-right:6px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:12px;border:1px solid var(--line);background:#07162f88;border-radius:16px;padding:14px}
    .item .left{display:flex;flex-direction:column;gap:6px;min-width:0}
    .item .name{font-weight:900;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .item .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .miniBtn{height:52px;min-width:140px;border-radius:14px;border:1px solid #ffffff22;background:#0b2346;color:var(--txt);font-weight:900;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;padding:0 14px}
    .miniBtn.sel{background:linear-gradient(180deg,#0b4a73,#083252);border-color:#49c2ff88}
    .miniBtn.disabled{opacity:.35;pointer-events:none}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#081a33ee;border:1px solid #49c2ff44;border-radius:16px;padding:12px 14px;display:none;align-items:center;gap:10px;box-shadow:var(--shadow);max-width:min(720px, calc(100vw - 20px));z-index:99}
    .toast.show{display:flex}
    .toast .msg{font-weight:800}
    .toast .undo{margin-left:auto;height:44px;border-radius:12px;border:1px solid #2bd67155;background:#062a1a;color:#d9ffe8;font-weight:900;cursor:pointer;padding:0 14px}
    .muted{color:var(--muted)}
    .opRow{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:14px;border:1px solid var(--line);background:#07162f88}
    .opRow .nm{font-weight:900;font-size:18px}
    .opRow .st{color:var(--muted);font-size:13px}
    .opActions{display:flex;gap:10px;flex-wrap:wrap}
    .opActions button{height:44px;border-radius:12px;border:1px solid #ffffff22;background:#0b2346;color:var(--txt);font-weight:900;cursor:pointer;padding:0 12px}
    .opActions button.danger{background:#3d0c20;border-color:#ff5a7a88}
    .histRow{display:grid;grid-template-columns: 140px 1fr 110px 120px;gap:10px;align-items:center}
    @media (max-width:900px){.histRow{grid-template-columns:1fr}.histRow .c1,.histRow .c2,.histRow .c3,.histRow .c4{width:100%}}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid #ffffff22;background:#061a2b88;font-weight:900}
  
</style>
</head>
<body>

<body>
<div class="app">
  <header>
    <div class="title">
      <h1>Terminal Corte Hierro</h1>
      <div class="sub">Terminal tablet conectado a Stock real.</div>
    </div>
    <div class="hdrRight">
      <div class="tinyBtns">
        <button class="tinyBtn" id="btnOps">‚öô Operarios</button>
        <button class="tinyBtn" id="btnHist">üìã Historial</button>
      </div>
      <div class="badge" id="hdrBadge">Sin sesi√≥n</div>
    </div>
  </header>
  <div id="stepWrap" class="card"></div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">
  <div class="msg" id="toastMsg">Acci√≥n realizada</div>
  <button class="undo" id="undoBtn">Deshacer</button>
</div>


<!-- Firebase (Compat para poder usarlo sin bundlers) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/** STOCK TALLER v7.2 + AUTOSYNC FIRESTORE
 *  - Mantiene DB local (localStorage) como cache
 *  - Se sincroniza SOLO (sin bot√≥n) con Firestore
 *  - En m√≥vil ver√°s el mismo stock completo que en web
 *
 *  IMPORTANTE: pega tu firebaseConfig real abajo.
 */

// ====== CONFIG ======
const USE_FIRESTORE = true;
const FIRESTORE_DOC_PATH = { col: "taller_stock", doc: "main" }; // puedes cambiarlo

const firebaseConfig = {
  apiKey: "AIzaSyDGIfICSG_KE6QzmKHj3CzgvYeHaUcgARo",
  authDomain: "gestion-taller-2a439.firebaseapp.com",
  projectId: "gestion-taller-2a439",
  storageBucket: "gestion-taller-2a439.firebasestorage.app",
  messagingSenderId: "498579673950",
  appId: "1:498579673950:web:eb626781a5b509957db5cf"
};

// ====== DB LOCAL ======
const DB_KEY="taller_stock_v3_data", SNOOZE_KEY="taller_stock_snooze_until";
let materials=[], movements=[], currentFilter={cat:null,grp:null,status:null};
let categoryOrder = [];

// ====== FIRESTORE HELPERS ======
let fbApp=null, fbAuth=null, fbDb=null;
let fsUnsub=null;
let fsReady=false;
let ignoreNextLocalSave=false;
let pendingSaveTimer=null;
let lastRemoteUpdateAt=0;

function fbEnsure(){
  if(fbApp) return;
  fbApp = firebase.initializeApp(firebaseConfig);
  fbAuth = firebase.auth();
  fbDb   = firebase.firestore();
}

async function fsLoginHidden(){
  // login an√≥nimo (si tus reglas lo permiten) o usa tu m√©todo actual
  await fbAuth.signInAnonymously();
}

function fsDocRef(){
  return fbDb.collection(FIRESTORE_DOC_PATH.col).doc(FIRESTORE_DOC_PATH.doc);
}

async function fsLoadOnceToLocal(){
  const snap = await fsDocRef().get();
  if(!snap.exists) return false;
  const data = snap.data() || {};
  if(!data.materials || !data.movements) return false;

  // Guardar en local
  ignoreNextLocalSave = true;
  localStorage.setItem(DB_KEY, JSON.stringify({
    materials: data.materials || [],
    movements: data.movements || [],
    categoryOrder: data.categoryOrder || []
  }));
  ignoreNextLocalSave = false;

  // Aplicar a memoria y refrescar UI
  materials = data.materials || [];
  movements = data.movements || [];
  categoryOrder = data.categoryOrder || [];
  lastRemoteUpdateAt = Date.now();
  return true;
}

function fsStartRealtimeListener(){
  if(fsUnsub) fsUnsub();
  fsUnsub = fsDocRef().onSnapshot((snap)=>{
    if(!snap.exists) return;
    const data = snap.data() || {};
    if(!data.materials || !data.movements) return;

    // Evitar bucle si este cambio lo acabamos de subir nosotros
    // (simple: si el cambio remoto llega justo despu√©s de un save local, lo aceptamos igualmente,
    //  pero marcamos timestamp para evitar re-guardar inmediatamente)
    ignoreNextLocalSave = true;
    localStorage.setItem(DB_KEY, JSON.stringify({
      materials: data.materials || [],
      movements: data.movements || [],
      categoryOrder: data.categoryOrder || []
    }));
    ignoreNextLocalSave = false;

    materials = data.materials || [];
    movements = data.movements || [];
    categoryOrder = data.categoryOrder || [];
    lastRemoteUpdateAt = Date.now();

    // Re-render UI SIN perder filtro actual
    renderTree();
    updateSummary();
    renderGrid();
  }, (err)=>{
    console.warn("Firestore onSnapshot error:", err);
  });
}

function scheduleFsSave(){
  if(!USE_FIRESTORE || !fsReady) return;
  if(ignoreNextLocalSave) return;

  clearTimeout(pendingSaveTimer);
  pendingSaveTimer = setTimeout(async ()=>{
    try{
      const payload = { materials, movements, categoryOrder, updatedAt: new Date().toISOString() };
      await fsDocRef().set(payload, { merge: true });
    }catch(e){
      console.warn("No se pudo guardar en Firestore:", e);
    }
  }, 450); // debounce corto
}

// ====== INIT ======
async function initWithSync(){
  // 1) cargar local
  const d=localStorage.getItem(DB_KEY);
  if(d){
    try{
      const p=JSON.parse(d);
      materials=p.materials||[]; movements=p.movements||[]; categoryOrder=p.categoryOrder||[];
      cleanDuplicates();
    }catch(e){
      materials=[]; movements=[]; categoryOrder=[];
    }
  }

  // 2) arrancar firestore y traer remoto (si existe) para que m√≥vil vea lo mismo
  if(USE_FIRESTORE){
    try{
      fbEnsure();
      await fsLoginHidden();
      const ok = await fsLoadOnceToLocal();
      fsReady = true;
      fsStartRealtimeListener();
      if(!ok){
        // si no existe a√∫n en Firestore, subimos lo local (o semilla m√≠nima)
        if(!materials.length){
          materials=[
            {id:uuid(),cat:"Soldadura, Corte y Desbaste",grp:"Discos",name:"Disco 115mm",unit:"ud",min:10},
            {id:uuid(),cat:"Soldadura, Corte y Desbaste",grp:"Electrodos",name:"Electrodo 2.5mm",unit:"caja",min:2},
            {id:uuid(),cat:"Hierro",grp:"Tubos",name:"Tubo 40x40",unit:"br",min:5}
          ];
        }
        await fsDocRef().set({ materials, movements, categoryOrder, createdAt: new Date().toISOString() }, { merge: true });
      }
    }catch(e){
      console.warn("Firestore no disponible, seguimos en local:", e);
      fsReady = false;
    }
  }

  // 3) render normal
  renderTree(); updateSummary(); renderGrid(); checkAlerts();

  document.addEventListener('click', (e)=>{
    if(!e.target.closest('#symGrid') && !e.target.closest('.btn.icon')){ $("symGrid").classList.remove('show'); }
  });
}

// ====== FUNCIONES ORIGINALES (id√©nticas salvo saveData -> scheduleFsSave) ======
function cleanDuplicates(){
  const unique = new Map();
  materials.forEach(m => {
    const key = `${m.name.trim().toLowerCase()}|${m.cat.trim().toLowerCase()}|${m.grp.trim().toLowerCase()}`;
    if(!unique.has(key)){ unique.set(key, m); } 
    else { const original = unique.get(key); movements.forEach(mov => { if(mov.matId === m.id) mov.matId = original.id; }); }
  });
  if(materials.length > unique.size){ materials = Array.from(unique.values()); saveData(); }
}

function saveData(){
  localStorage.setItem(DB_KEY, JSON.stringify({materials,movements,categoryOrder}));
  updateSummary();
  scheduleFsSave(); // <<< AUTO-SYNC
}

const $=id=>document.getElementById(id), uuid=()=>Math.random().toString(36).substr(2,9);
const getStock=id=>movements.filter(m=>m.matId===id).reduce((a,m)=>m.type==='in'?a+m.qty:a-m.qty,0);
const getStatus=m=>{ const s=getStock(m.id); return s<=0?'danger':(s<=m.min?'warn':'ok'); };

// --- (PEGAMOS EL RESTO DEL SCRIPT ORIGINAL) ---
</script>
<script>

(() => {
  const OPS_KEY  = "tablet_ops_hierro_v3_clean";
  const HIST_KEY = "tablet_hist_hierro_v3_clean";
  const HIST_LIMIT = 500;

  const DEFAULT_OPERATORS = [];

  // -------------------------
  // Integraci√≥n con Stock real (localStorage) - SIN Firestore
  // Lee y descuenta directamente sobre la misma DB que usa stock.html (DB_KEY="taller_stock_v3_data")
  // -------------------------
  const STOCK_DB_KEY = "taller_stock_v3_data";

  function loadStockDB(){
    try{
      const raw = localStorage.getItem(STOCK_DB_KEY);
      if(!raw) return null;
      const db = JSON.parse(raw);
      if(!db || !Array.isArray(db.materials) || !Array.isArray(db.movements)) return null;
      return db;
    }catch(e){ return null; }
  }

  function saveStockDB(db){
    localStorage.setItem(STOCK_DB_KEY, JSON.stringify(db));
  }

  function getStockFromDB(db, matId){
    return (db.movements||[]).filter(m=>m.matId===matId).reduce((a,m)=> (m.type==='in'? a + Number(m.qty||0) : a - Number(m.qty||0)), 0);
  }

  function isIronMaterial(m){
    const cat = String(m.cat||"").toLowerCase();
    return cat.includes("hierro") || cat.includes("perfil");
  }

  function detectFinish(m){
    // No pedimos al operario que lo marque: se reconoce por nombre/grupo/categor√≠a
    const txt = (String(m.name||"") + " " + String(m.grp||"") + " " + String(m.cat||"")).toLowerCase();
    if(txt.includes("galva") || txt.includes("galvan")) return "GALVANIZADO";
    return "NEGRO";
  }

  // MATERIALS ser√° el listado vivo de materiales de hierro le√≠do del stock real
  let MATERIALS = [];

  function refreshMaterialsFromStock(){
    const db = loadStockDB();
    if(!db){
      MATERIALS = [];
      return {ok:false, reason:"No existe la base de datos de stock. Abre stock.html una vez para inicializarla."};
    }
    const mats = (db.materials||[]).filter(isIronMaterial);
    MATERIALS = mats.map(m=>{
      const finish = detectFinish(m);
      const stock = getStockFromDB(db, m.id);
      return {
        id: m.id,
        name: m.name,
        finish,
        stock,
        usageCount: 0, // opcional (no lo necesitamos para integrar)
        unit: m.unit || "br"
      };
    });
    return {ok:true};
  }

  function applyConsumeToStock(matId, qty){
    const db = loadStockDB();
    if(!db) return {ok:false, msg:"No se pudo cargar el stock real."};
    const current = getStockFromDB(db, matId);
    if(current < qty) return {ok:false, msg:"SIN STOCK: no se puede consumir."};
    db.movements.push({
      id: Math.random().toString(36).substr(2,9),
      matId: matId,
      type: "out",
      qty: qty,
      date: new Date().toISOString(),
      source: "TABLET_HIERRO_LOCAL"
    });
    saveStockDB(db);
    return {ok:true, stockAfter: current-qty};
  }


  const state = { finish:null, operator:null, activeMaterialId:null, lastAction:null, view:"main", sessionId:null };
  const $wrap = document.getElementById('stepWrap');
  const $badge = document.getElementById('hdrBadge');
  const byId = id => document.getElementById(id);

  const nowISO = () => new Date().toISOString();
  const fmt = (iso) => {
    const d = new Date(iso);
    return d.toLocaleString('es-ES', {hour12:false});
  };

  function newSessionId(){
    // Simple unique id for grouping (operator login session)
    return 'S' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
  }

  // -------------------------
  // Operators store
  // -------------------------
  function loadOps(){
    try{
      const raw = localStorage.getItem(OPS_KEY);
      if(!raw){
        const seed = [];
        localStorage.setItem(OPS_KEY, JSON.stringify(seed));
        return seed;
      }
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr) || !arr.length){
        const seed = [];
        localStorage.setItem(OPS_KEY, JSON.stringify(seed));
        return seed;
      }
      return arr.map(o=>({name:String(o.name||"").trim(), active:o.active!==false})).filter(o=>o.name);
    }catch(e){
      const seed = [];
      localStorage.setItem(OPS_KEY, JSON.stringify(seed));
      return seed;
    }
  }
  function saveOps(list){ localStorage.setItem(OPS_KEY, JSON.stringify(list)); }
  function getActiveOps(){ return loadOps().filter(o=>o.active); }

  // -------------------------
  // History store
  // -------------------------
  function loadHist(){
    try{
      const raw = localStorage.getItem(HIST_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function saveHist(arr){
    localStorage.setItem(HIST_KEY, JSON.stringify(arr));
  }
  function addHist(entry){
    const arr = loadHist();
    arr.unshift(entry); // newest first
    if(arr.length > HIST_LIMIT) arr.length = HIST_LIMIT;
    saveHist(arr);
  }

  // -------------------------
  // UI helpers
  // -------------------------
  function setBadge(){
    const parts=[];
    if(state.finish) parts.push(state.finish);
    if(state.operator) parts.push(state.operator);
    if(state.activeMaterialId){
      const m=MATERIALS.find(x=>x.id===state.activeMaterialId);
      if(m) parts.push("Activo: "+m.name);
    }
    $badge.textContent = parts.length ? parts.join(" ¬∑ ") : "Sin sesi√≥n";
  }

  function toast(msg, canUndo){
    const t=byId('toast');
    byId('toastMsg').textContent=msg;
    byId('undoBtn').style.display = canUndo ? 'inline-flex':'none';
    t.classList.add('show');
    clearTimeout(toast._tmr);
    toast._tmr=setTimeout(()=>t.classList.remove('show'),8000);
  }

  function detectLowTag(stock){
    if(stock<=0) return ['zero','SIN STOCK'];
    if(stock<=2) return ['low','BAJO'];
    return [null,null];
  }

  function sortMaterials(arr){
    return [...arr].sort((a,b)=>{
      if(b.usageCount!==a.usageCount) return b.usageCount-a.usageCount;
      return a.name.localeCompare(b.name,'es');
    });
  }

  function materialTag(m){
    const cls = m.finish==="NEGRO" ? "negro" : "galva";
    return `<span class="tag ${cls}">${m.finish}</span>`;
  }

  function goBackMain(){
    if(!state.finish) screenFinish();
    else if(!state.operator) screenOperator();
    else if(!state.activeMaterialId) screenMaterials();
    else screenConsume();
  }

  // -------------------------
  // Main screens
  // -------------------------
  function screenFinish(){
    refreshMaterialsFromStock();
    state.view="main";
    setBadge();
    $wrap.innerHTML = `
      <div class="row" style="gap:14px">
        <div>
          <div class="pill">Paso 1 ¬∑ Seleccionar tipo de corte</div>
          <div style="margin-top:10px;font-size:28px;font-weight:900">¬øQu√© vas a cortar?</div>
          <div class="hint">Selecciona primero NEGRO o GALVANIZADO. Luego elegir√°s operario y material.</div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="grid2">
        <button class="btn primary" id="btnNegro">HIERRO NEGRO</button>
        <button class="btn good" id="btnGalva">HIERRO GALVANIZADO</button>
      </div>
      <div class="sep"></div>
      <div class="muted">: operarios e historial persistentes (√∫ltimos ${HIST_LIMIT}). Stock de ejemplo.</div>
    `;
    byId('btnNegro').onclick = () => { state.finish="NEGRO"; state.operator=null; state.sessionId=null; state.activeMaterialId=null; screenOperator(); };
    byId('btnGalva').onclick = () => { state.finish="GALVANIZADO"; state.operator=null; state.sessionId=null; state.activeMaterialId=null; screenOperator(); };
  }

  function screenOperator(){
    state.view="main";
    setBadge();
    const ops = getActiveOps().map(o=>`<button class="btn small accent" data-op="${o.name}">${o.name}</button>`).join('');
    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">Paso 2 ¬∑ Operario</div>
          <div style="margin-top:10px;font-size:26px;font-weight:900">¬øQui√©n est√° cortando?</div>
          <div class="hint">Pulsa tu nombre. Si es una ayuda puntual, usa "Ocasional".</div>
        </div>
        <button class="btn small ghost" id="backFinish">‚¨Ö Volver</button>
      </div>
      <div class="sep"></div>
      <div class="grid3">${ops || `<div class="muted">No hay operarios. Ve a ‚öô Operarios para a√±adirlos.</div>`}
        <button class="btn small danger" id="btnOcc">OCASIONAL</button>
      </div>
      <div class="sep"></div>
      <div id="occBox" style="display:none">
        <div style="font-weight:900;margin-bottom:10px">Nombre del operario ocasional (obligatorio)</div>
        <div class="grid2">
          <input id="occName" placeholder="Escribe el nombre..."/>
          <button class="btn small primary" id="occOk">Confirmar</button>
        </div>
        <div class="hint">Se registrar√° este nombre en el historial.</div>
      </div>
    `;
    byId('backFinish').onclick = () => screenFinish();
    [...$wrap.querySelectorAll('[data-op]')].forEach(b=> b.onclick = ()=>{ state.operator=b.getAttribute('data-op'); state.sessionId=newSessionId(); screenMaterials(); });
    byId('btnOcc').onclick = ()=>{ byId('occBox').style.display='block'; byId('occName').focus(); };
    byId('occOk').onclick = ()=>{
      const v=(byId('occName').value||'').trim();
      if(!v){ toast("Debes escribir un nombre para 'Ocasional'.",false); return; }
      state.operator=v; state.sessionId=newSessionId(); screenMaterials();
    };
  }

  function screenMaterials(){
    const r = refreshMaterialsFromStock();
    if(!r.ok){
      state.view='main'; setBadge();
      $wrap.innerHTML = `<div class="row"><div><div class="pill">Stock real no disponible</div><div style="margin-top:10px;font-size:26px;font-weight:900">No se puede leer el Stock</div><div class="hint">${'${'}escapeHtml(r.reason){'}'}<br>Soluci√≥n: abre <b>stock.html</b> (mismo navegador y misma URL) para inicializar la base, y vuelve aqu√≠.</div></div></div>`;
      return;
    }

    state.view="main";
    setBadge();
    const mats = sortMaterials(MATERIALS.filter(m=>m.finish===state.finish));
    const rows = mats.map(m=>{
      const [cls,lbl]=detectLowTag(m.stock);
      const warnTag = cls ? `<span class="tag ${cls}">${lbl}</span>`:'';
      const disabled = m.stock<=0 ? 'disabled':'';
      return `
        <div class="item">
          <div class="left">
            <div class="name">${m.name}</div>
            <div class="meta">
              ${materialTag(m)}
              <span class="muted">Usos: <b>${m.usageCount}</b></span>
              ${warnTag}
            </div>
          </div>
          <div class="right">
            <div class="kpi" style="min-width:160px">
              <div class="lbl">Stock</div>
              <div class="val">${m.stock} ${escapeHtml(m.unit||"br")}</div>
            </div>
            <button class="miniBtn sel ${disabled}" data-mat="${m.id}">Seleccionar</button>
          </div>
        </div>
      `;
    }).join('');
    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">Paso 3 ¬∑ Material (${state.finish})</div>
          <div style="margin-top:10px;font-size:26px;font-weight:900">Selecciona el material</div>
          <div class="hint">Ordenado por ‚Äúm√°s usados‚Äù. Los sin stock se muestran pero no se pueden seleccionar.</div>
        </div>
        <div class="row" style="gap:10px">
          <button class="btn small ghost" id="backOp">‚¨Ö Operario</button>
          <button class="btn small ghost" id="chgFinish">‚Ü∫ Cambiar tipo</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="list">${rows || `<div class="muted">No hay materiales en este tipo.</div>`}</div>
    `;
    byId('backOp').onclick = ()=>screenOperator();
    byId('chgFinish').onclick = ()=>screenFinish();
    [...$wrap.querySelectorAll('[data-mat]')].forEach(b=>{
      b.onclick = ()=>{
        const id=b.getAttribute('data-mat');
        const m=MATERIALS.find(x=>x.id===id);
        if(!m || m.stock<=0){ toast("Sin stock: no se puede seleccionar.",false); return; }
        state.activeMaterialId=id; screenConsume();
      };
    });
  }

  function screenConsume(){
    state.view="main";
    setBadge();
    const m=MATERIALS.find(x=>x.id===state.activeMaterialId);
    if(!m){ screenMaterials(); return; }
    const canUse = m.stock>0;
    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">Activo ¬∑ ${state.finish}</div>
          <div style="margin-top:10px;font-size:28px;font-weight:1000">${m.name}</div>
          <div class="hint">Operario: <b>${state.operator}</b> ¬∑ Fecha: ${new Date().toLocaleString('es-ES', {hour12:false})}</div>
        </div>
        <div class="row" style="gap:10px">
          <button class="btn small ghost" id="chgMat">Cambiar material</button>
          <button class="btn small ghost" id="chgFinish2">Cambiar tipo</button>
          <button class="btn small danger" id="logout">Cerrar sesi√≥n</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="grid3">
        <div class="kpi"><div class="lbl">Tipo</div><div class="val">${m.finish}</div></div>
        <div class="kpi"><div class="lbl">Usos hist√≥ricos</div><div class="val">${m.usageCount}</div></div>
        <div class="kpi"><div class="lbl">Stock actual</div><div class="val big">${m.stock}</div><div class="muted">barras</div></div>
      </div>
      <div class="sep"></div>
      <div class="grid2">
        <button class="btn ${canUse ? 'accent':'disabled'}" id="useOne">USAR 1 BARRA</button>
        <button class="btn small ghost" id="info">Ver resumen</button>
      </div>
      <div class="hint">Cada pulsaci√≥n queda registrada en üìã Historial (m√°x. ${HIST_LIMIT}).</div>
    `;
    byId('chgMat').onclick = ()=>screenMaterials();
    byId('chgFinish2').onclick = ()=>screenFinish();
    byId('logout').onclick = ()=>{ state.operator=null; state.sessionId=null; state.activeMaterialId=null; screenOperator(); };
    byId('info').onclick = ()=>toast(`Activo: ${m.name} ¬∑ Stock: ${m.stock} ¬∑ Usos: ${m.usageCount}`,false);

    let lock=false;
    byId('useOne').onclick = ()=>{
      if(lock) return;
      if(m.stock<=0){ toast("SIN STOCK: no se puede consumir.",false); return; }
      lock=true; setTimeout(()=>lock=false,850);

      const beforeStock = m.stock;
      const beforeUse   = m.usageCount;

      state.lastAction = {matId:m.id, stockBefore:beforeStock, usageBefore:beforeUse};

      // Apply sobre Stock real
      const res = applyConsumeToStock(m.id, 1);
      if(!res.ok){ toast(res.msg||"SIN STOCK", false); lock=false; return; }
      // Refrescar listado vivo desde Stock real
      refreshMaterialsFromStock();
      const mm = MATERIALS.find(x=>x.id===m.id);
      if(mm){ m.stock = mm.stock; }
      m.usageCount = (m.usageCount||0) + 1;

      // Save history entry
      addHist({
        ts: nowISO(),
        operator: state.operator,
        finish: m.finish,
        materialId: m.id,
        materialName: m.name,
        delta: -1,
        stockBefore: beforeStock,
        stockAfter: (res.stockAfter!==undefined?res.stockAfter:m.stock),
        device: "DEMO_PC",
        sessionId: state.sessionId || "SIN_SESION"
      });

      toast(`Descontada 1 barra (${m.stock} restantes).`, true);
      screenConsume();
    };
  }

  // -------------------------
  // Operarios
  // -------------------------
  function screenOps(){
    state.view="ops";
    setBadge();
    const ops = loadOps();
    const rows = ops.map((o,i)=>`
      <div class="opRow">
        <div>
          <div class="nm">${o.name}</div>
          <div class="st">${o.active ? "Activo" : "Inactivo"}</div>
        </div>
        <div class="opActions">
          <button data-tgl="${i}">${o.active ? "Desactivar" : "Activar"}</button>
          <button class="danger" data-del="${i}">Eliminar</button>
        </div>
      </div>
    `).join("");
    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">‚öô Gesti√≥n de operarios</div>
          <div style="margin-top:10px;font-size:24px;font-weight:900">A√±adir, activar/desactivar o eliminar</div>
          <div class="hint">Recomendaci√≥n: desactivar en lugar de eliminar si quieres mantener trazabilidad.</div>
        </div>
        <button class="btn small ghost" id="backMain">‚¨Ö Volver</button>
      </div>
      <div class="sep"></div>
      <div class="grid2">
        <input id="newOp" placeholder="Nuevo operario (nombre)"/>
        <button class="btn small primary" id="addOp">A√±adir</button>
      </div>
      <div class="sep"></div>
      <div class="list" style="max-height:48vh">${rows || `<div class="muted">No hay operarios.</div>`}</div>
      <div class="sep"></div>
      <button class="btn small danger" id="resetOps">Vaciar lista</button>
    `;
    byId('backMain').onclick = () => goBackMain();
    byId('addOp').onclick = () => {
      const v = (byId('newOp').value||"").trim();
      if(!v){ toast("Escribe un nombre.", false); return; }
      const cur = loadOps();
      if(cur.some(x=>x.name.toLowerCase()===v.toLowerCase())){
        toast("Ya existe un operario con ese nombre.", false); return;
      }
      cur.push({name:v, active:true});
      saveOps(cur);
      toast("Operario a√±adido.", false);
      screenOps();
    };
    $wrap.querySelectorAll("[data-tgl]").forEach(btn=>{
      btn.onclick = () => {
        const idx = parseInt(btn.getAttribute("data-tgl"),10);
        const cur = loadOps();
        if(!cur[idx]) return;
        cur[idx].active = !cur[idx].active;
        saveOps(cur);
        toast(cur[idx].active ? "Operario activado." : "Operario desactivado.", false);
        screenOps();
      };
    });
    $wrap.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = () => {
        const idx = parseInt(btn.getAttribute("data-del"),10);
        const cur = loadOps();
        if(!cur[idx]) return;
        const name = cur[idx].name;
        if(!confirm(`Eliminar operario "${name}"?`)) return;
        cur.splice(idx,1);
        saveOps(cur);
        toast("Operario eliminado.", false);
        screenOps();
      };
    });
    byId('resetOps').onclick = () => {
      if(!confirm("Restaurar la lista de operarios por defecto?")) return;
      const seed = [];
      saveOps(seed);
      toast("Operarios limpiados.", false);
      screenOps();
    };
  }

  // -------------------------
  // Historial
  // -------------------------
  function screenHist(){
    state.view="hist";
    setBadge();
    const hist = loadHist();

    const ops = Array.from(new Set(hist.map(h=>h.operator))).sort((a,b)=>a.localeCompare(b,'es'));
    const opOptions = ['<option value="">(Todos)</option>'].concat(ops.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`)).join('');

    $wrap.innerHTML = `
      <div class="row">
        <div>
          <div class="pill">üìã Historial (√∫ltimos ${HIST_LIMIT})</div>
          <div style="margin-top:10px;font-size:24px;font-weight:900">Registro de consumos</div>
          <div class="hint">Cada pulsaci√≥n ‚ÄúUSAR 1 BARRA‚Äù crea un registro. Aqu√≠ se puede filtrar y exportar.</div>
        </div>
        <button class="btn small ghost" id="backMain">‚¨Ö Volver</button>
      </div>

      <div class="sep"></div>

      <div class="grid3">
        <div class="kpi">
          <div class="lbl">Registros</div>
          <div class="val">${hist.length}</div>
        </div>
        <div class="kpi">
          <div class="lbl">√öltimo registro</div>
          <div class="val">${hist[0] ? fmt(hist[0].ts) : "-"}</div>
        </div>
        <div class="kpi">
          <div class="lbl">L√≠mite</div>
          <div class="val">${HIST_LIMIT}</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="grid3">
        <div>
          <div class="hint" style="margin:0 0 8px">Operario</div>
          <select id="fOp">${opOptions}</select>
        </div>
        <div>
          <div class="hint" style="margin:0 0 8px">Tipo</div>
          <select id="fFin">
            <option value="">(Todos)</option>
            <option value="NEGRO">NEGRO</option>
            <option value="GALVANIZADO">GALVANIZADO</option>
          </select>
        </div>
        <div>
          <div class="hint" style="margin:0 0 8px">Buscar material</div>
          <input id="fTxt" placeholder="Ej: tubo 40x40"/>
        </div>
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <button class="btn small primary" id="btnExport">Exportar JSON</button>
        <button class="btn small danger" id="btnClear">Borrar historial</button>
      </div>

      <div class="sep"></div>

      <div id="histList" class="list" style="max-height:46vh"></div>
    `;

    byId('backMain').onclick = () => goBackMain();
    byId('btnExport').onclick = () => exportHist();
    byId('btnClear').onclick = () => {
      if(!confirm("Borrar todo el historial local?")) return;
      saveHist([]);
      toast("Historial borrado.", false);
      screenHist();
    };

    const render = () => {
      const op = byId('fOp').value;
      const fin = byId('fFin').value;
      const txt = (byId('fTxt').value||"").trim().toLowerCase();

      const filtered = hist.filter(h=>{
        if(op && h.operator !== op) return false;
        if(fin && h.finish !== fin) return false;
        if(txt && !(String(h.materialName||"").toLowerCase().includes(txt))) return false;
        return true;
      });

      // Aggregate by operator + session + finish + material
      const map = new Map();
      filtered.forEach(h=>{
        const key = [h.operator, h.sessionId||"SIN_SESION", h.finish, h.materialId].join("||");
        if(!map.has(key)){
          map.set(key, {
            operator: h.operator,
            sessionId: h.sessionId||"SIN_SESION",
            finish: h.finish,
            materialId: h.materialId,
            materialName: h.materialName,
            total: 0,
            firstTs: h.ts,
            lastTs: h.ts,
            stockStart: h.stockBefore,
            stockEnd: h.stockAfter
          });
        }
        const g = map.get(key);
        g.total += (h.delta||0); // negative
        // Since hist is newest-first but filtered order unknown, compute min/max
        if(h.ts < g.firstTs){
          g.firstTs = h.ts;
          g.stockStart = h.stockBefore;
        }
        if(h.ts > g.lastTs){
          g.lastTs = h.ts;
          g.stockEnd = h.stockAfter;
        }
      });

      const groups = Array.from(map.values()).sort((a,b)=> (b.lastTs||"").localeCompare(a.lastTs||""));

      byId('histList').innerHTML = groups.map(g=>{
        const finCls = g.finish==="NEGRO" ? "negro" : "galva";
        const totalAbs = Math.abs(g.total);
        return `
          <div class="item">
            <div class="left">
              <div class="name">${escapeHtml(g.materialName)}</div>
              <div class="meta">
                <span class="tag ${finCls}">${escapeHtml(g.finish)}</span>
                <span class="chip">${escapeHtml(g.operator)}</span>
                <span class="muted">Sesi√≥n: ${escapeHtml(g.sessionId)}</span>
                <span class="muted">${fmt(g.firstTs)} ‚Üí ${fmt(g.lastTs)}</span>
              </div>
            </div>
            <div class="right">
              <div class="kpi" style="min-width:170px">
                <div class="lbl">Barras usadas</div>
                <div class="val">-${totalAbs}</div>
              </div>
              <div class="kpi" style="min-width:200px">
                <div class="lbl">Stock</div>
                <div class="val">${g.stockStart} ‚Üí <b>${g.stockEnd}</b></div>
              </div>
            </div>
          </div>
        `;
      }).join("") || `<div class="muted">No hay resultados con estos filtros.</div>`;
    };

    ["fOp","fFin","fTxt"].forEach(id=>{
      byId(id).addEventListener("input", render);
      byId(id).addEventListener("change", render);
    });

    render();
  }

  function exportHist(){
    const hist = loadHist();
    const blob = new Blob([JSON.stringify(hist, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "historial_cortes_demo.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
    toast("Exportaci√≥n iniciada.", false);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  }

  // -------------------------
  // Undo (also reverts last history entry)
  // -------------------------
  byId('undoBtn').onclick = ()=>{
    const la=state.lastAction; if(!la) return;
    const m=MATERIALS.find(x=>x.id===la.matId); if(!m) return;
    m.stock = la.stockBefore; m.usageCount = la.usageBefore;
    state.lastAction=null;

    // remove last history entry if it matches this material/operator/time window
    const hist = loadHist();
    // remove first entry (newest) if same materialId and operator and delta -1
    if(hist[0] && hist[0].materialId===m.id && hist[0].operator===state.operator && hist[0].delta===-1 && (hist[0].sessionId||'')===(state.sessionId||'')){
      hist.shift();
      saveHist(hist);
    }

    toast("Acci√≥n deshecha.",false);
    goBackMain();
  };

  // Header buttons
  document.getElementById("btnOps").onclick  = () => screenOps();
  document.getElementById("btnHist").onclick = () => screenHist();

  // Start
  screenFinish();
})();

// REEMPLAZO: arrancar con autosync
initWithSync();
</script>
</body>
</html>
