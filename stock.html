<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Stock Taller v7.2 - AutoSync Firestore</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;color:#eaf1ff;background:#07142e}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .card{background:#0b2346;border:1px solid #ffffff22;border-radius:18px;padding:18px}
    h1{margin:0 0 6px}
    .muted{opacity:.8}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#061a2b88;border:1px solid #49c2ff44;color:#ccecff;font-size:13px}
    .sep{height:1px;background:#ffffff22;margin:14px 0}
    button{height:46px;border-radius:12px;border:1px solid #ffffff22;background:#0b2f5d;color:#fff;font-weight:800;cursor:pointer;padding:0 14px;margin-right:10px}
    pre{white-space:pre-wrap;background:#061a33;border:1px solid #ffffff22;border-radius:12px;padding:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="pill">Stock Taller v7.2 · AutoSync con Firestore</div>
    <h1 style="margin-top:10px">Stock Taller</h1>
    <div class="muted">Este archivo es el stock. Si aquí te salía el terminal, era porque el contenido estaba mal pegado.</div>
    <div class="sep"></div>
    <button id="btnSync">Forzar sync (prueba)</button>
    <button id="btnView">Ver DB local</button>
    <div class="sep"></div>
    <div id="log" class="muted">Listo.</div>
    <div class="sep"></div>
    <pre id="dump" style="display:none"></pre>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* CONFIG REAL (YA METIDA) */
const USE_FIRESTORE = true;
const FIRESTORE_DOC_PATH = { col: "taller_stock", doc: "main" };
const DB_KEY="taller_stock_v3_data";

const firebaseConfig = {
  apiKey: "AIzaSyDGIfICSG_KE6QzmKHj3CzgvYeHaUcgARo",
  authDomain: "gestion-taller-2a439.firebaseapp.com",
  projectId: "gestion-taller-2a439",
  storageBucket: "gestion-taller-2a439.firebasestorage.app",
  messagingSenderId: "498579673950",
  appId: "1:498579673950:web:eb626781a5b509957db5cf"
};

let app=null, auth=null, db=null;

function log(t){ document.getElementById("log").textContent=t; console.log(t); }

function loadLocal(){
  try{
    const raw=localStorage.getItem(DB_KEY);
    if(!raw) return {materials:[],movements:[],categoryOrder:[]};
    return JSON.parse(raw);
  }catch(e){ return {materials:[],movements:[],categoryOrder:[]}; }
}
function saveLocal(data){
  localStorage.setItem(DB_KEY, JSON.stringify(data));
}

function ensureFirebase(){
  if(app) return;
  app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db   = firebase.firestore();
}
function ref(){
  return db.collection(FIRESTORE_DOC_PATH.col).doc(FIRESTORE_DOC_PATH.doc);
}

async function login(){
  await auth.signInAnonymously();
}

async function pullOnce(){
  const snap = await ref().get();
  if(!snap.exists){ log("No existe documento en Firestore aún."); return false; }
  const data = snap.data()||{};
  if(!data.materials || !data.movements){ log("Firestore no tiene materials/movements."); return false; }
  saveLocal({materials:data.materials||[],movements:data.movements||[],categoryOrder:data.categoryOrder||[]});
  log("OK: descargado Firestore → localStorage");
  return true;
}

async function pushLocal(){
  const data = loadLocal();
  await ref().set({...data, updatedAt:new Date().toISOString()},{merge:true});
  log("OK: subido localStorage → Firestore");
}

async function init(){
  if(!USE_FIRESTORE){ log("Modo local."); return; }
  try{
    ensureFirebase();
    await login();
    const ok = await pullOnce();
    if(!ok){
      // si Firestore está vacío, subimos lo que haya local
      await pushLocal();
    }
  }catch(e){
    log("ERROR Firestore: "+(e?.message||e));
  }
}

document.getElementById("btnSync").onclick = async ()=>{
  await init();
};
document.getElementById("btnView").onclick = ()=>{
  const d = loadLocal();
  const p = document.getElementById("dump");
  p.style.display="block";
  p.textContent = JSON.stringify(d,null,2);
};

init();
</script>
</body>
</html>
