<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Stock Taller v7.2 - Acciones R√°pidas</title>
<style>
  /* --- ESTILOS PANTALLA --- */
  :root{
    --bg:#0b1220; --panel:#0f172a; --card:#111c33;
    --text:#e6edf7; --muted:#9fb0c8; --border:rgba(255,255,255,.08);
    --accent:#38bdf8; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:16px;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0; font-family: system-ui, -apple-system, sans-serif;
    background: radial-gradient(1200px 600px at 20% 0%, rgba(56,189,248,.10), transparent 60%),
                radial-gradient(900px 500px at 80% 20%, rgba(34,197,94,.08), transparent 55%), var(--bg);
    color:var(--text); min-height:100vh; display: flex; flex-direction: column;
  }
  .wrap{ max-width:1400px; margin:0 auto; padding:20px; flex: 1; width: 100%; }
  
  /* UI Components */
  header{ display:flex; justify-content:space-between; gap:16px; padding:18px; border:1px solid var(--border); border-radius:var(--radius); background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); box-shadow: var(--shadow); margin-bottom: 20px; }
  .brand h1{ margin:0; font-size:22px; letter-spacing:.5px; } .brand p{ margin:6px 0 0; color:var(--muted); font-size:13px; }
  .btn{ border:1px solid var(--border); background: rgba(255,255,255,.04); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; font-size:13px; display:inline-flex; gap:8px; align-items:center; transition: .15s ease; user-select:none; }
  .btn:hover{ transform: translateY(-1px); border-color: rgba(56,189,248,.35); background: rgba(56,189,248,.08); }
  .btn:disabled{ opacity:0.5; cursor:not-allowed; transform:none; }
  .btn.primary{ background: rgba(56,189,248,.18); border-color: rgba(56,189,248,.35); color: #7dd3fc; }
  .btn.danger{ background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.35); color: #fca5a5; }
  .btn.warn{ background:rgba(245,158,11,.16); border:1px solid rgba(245,158,11,.25); color:#fbbf24; }
  .btn.warn:hover{ filter:brightness(1.08); }

  .btn.ghost{ background: transparent; border-color:transparent; } .btn.ghost:hover{ background: rgba(255,255,255,.05); border-color: var(--border); }
  .btn.icon{ width: 36px; height: 36px; justify-content:center; padding:0; }

  .summary{ display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom: 20px; }
  .pill{ border:1px solid var(--border); background: rgba(255,255,255,.02); border-radius:14px; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; cursor: pointer; transition: transform .15s, background .15s; }
  .pill:hover{ background: rgba(255,255,255,.06); transform: translateY(-2px); }
  .pill.active-filter{ border-color: var(--accent); background: rgba(56,189,248,.1); }
  .pill .val{ font-size:20px; font-weight:800; } .pill .lbl{ font-size:12px; color:var(--muted); display:flex; align-items:center; gap:6px; }
  .dot{ width:8px; height:8px; border-radius:50%; background:currentColor; }

  .layout{ display:grid; grid-template-columns: 280px 1fr; gap:20px; align-items: start; }
  @media (max-width: 900px){ .layout{ grid-template-columns: 1fr; } }

  .sidebar{ background: rgba(15,23,42,.6); border:1px solid var(--border); border-radius:18px; padding:16px; position:sticky; top:20px; max-height: calc(100vh - 40px); overflow-y:auto; }
  .sb-head{ font-size:12px; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-bottom:12px; font-weight:800; }
  
  /* Tree & Drag */
  .tree-cat{ margin-bottom:4px; transition: transform 0.2s, opacity 0.2s; }
  .tree-cat.dragging-cat { opacity: 0.3; }
  .tree-cat.drag-over-cat { border-top: 2px solid var(--accent); }

  .tree-cat-row{ width:100%; text-align:left; background:transparent; border:1px solid transparent; color:var(--text); padding:8px 10px; font-weight:700; font-size:14px; cursor:grab; border-radius:10px; display:flex; justify-content:space-between; align-items:center; transition: background .15s; }
  .tree-cat-row:active{ cursor: grabbing; }
  .tree-cat-row:hover{ background:rgba(255,255,255,.03); border-color:rgba(255,255,255,.05); }
  .tree-cat-row.open-state{ background:rgba(255,255,255,.02); } 
  .tree-cat-content{ display:flex; align-items:center; gap:8px; flex:1; pointer-events: none; }
  .tree-arrow{ display:inline-block; font-size:16px; opacity:.5; transition: transform .2s ease; }
  .tree-cat.open .tree-arrow{ transform: rotate(90deg); opacity:1; color:var(--accent); }

  .row-actions{ display:flex; gap:6px; opacity:0; transition:.2s; align-items:center; pointer-events: auto; }
  .tree-cat-row:hover .row-actions, .tree-group-row:hover .row-actions { opacity:1; }
  .act-icon{ font-size:14px; padding:4px; border-radius:4px; transition:.2s; display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; cursor:pointer; }
  .act-icon:hover{ transform:scale(1.2); }
  .act-icon.edit{ color:var(--accent); } .act-icon.edit:hover{ background:rgba(56,189,248,.15); }
  .act-icon.del{ color:var(--danger); } .act-icon.del:hover{ background:rgba(239,68,68,.15); }
  .act-icon.print{ color: #fff; opacity:0.8; margin-left: 8px; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 8px; width: 32px; }
  .act-icon.print:hover{ opacity:1; color:#4ade80; text-shadow: 0 0 10px rgba(74,222,128,0.5); }

  .tree-group-list{ padding-left:14px; margin-top:4px; margin-bottom:8px; display:none; border-left: 1px solid rgba(255,255,255,.08); margin-left: 14px; }
  .tree-cat.open .tree-group-list{ display:block; animation: slideDown .15s ease-out; }
  @keyframes slideDown{ from{opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }

  .tree-group-row{ width:100%; text-align:left; background:transparent; border:none; color:var(--muted); padding:6px 10px; font-size:13px; cursor:pointer; border-radius:6px; margin-bottom: 2px; display:flex; justify-content:space-between; align-items:center; }
  .tree-group-row:hover{ color:var(--text); background:rgba(255,255,255,.02); }
  .tree-group-row.active{ color:var(--accent); background:rgba(56,189,248,.08); font-weight:700; }
  .tree-sub-all{ font-style: italic; border-bottom: 1px solid rgba(255,255,255,.03); margin-bottom: 4px; padding-bottom: 8px; opacity:.9; }

  /* Grid */
  .toolbar{ display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
  .search-box{ flex:1; display:flex; align-items:center; gap:10px; background: rgba(0,0,0,.2); border:1px solid var(--border); padding:0 14px; border-radius:12px; height:42px; }
  .search-box input{ background:transparent; border:none; color:var(--text); width:100%; outline:none; font-size:14px; }
  .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px; }

  .card{ background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01)); border:1px solid var(--border); border-radius:16px; padding:16px; display:flex; flex-direction:column; justify-content:space-between; transition: transform .2s ease, border-color .2s; cursor: grab; }
  .card:active{ cursor: grabbing; } .card:hover{ border-color: rgba(255,255,255,.15); transform:translateY(-2px); }
  .card.dragging { opacity: 0.4; border: 2px dashed var(--accent); transform: scale(0.95); }
  .card.drag-over { border-top: 3px solid var(--accent); transform: translateY(4px); }
  
  .card-top{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; pointer-events:none; }
  .card-titles h3{ margin:0 0 4px; font-size:16px; line-height:1.3; } .card-titles span{ font-size:11px; color:var(--muted); background:rgba(255,255,255,.05); padding:2px 6px; border-radius:6px; }
  .stock-badge{ font-size:11px; font-weight:800; padding:4px 8px; border-radius:20px; border:1px solid transparent; }
  .st-ok{ color:#4ade80; background:rgba(34,197,94,.1); border-color:rgba(34,197,94,.2); }
  .st-warn{ color:#fbbf24; background:rgba(245,158,11,.1); border-color:rgba(245,158,11,.2); }
  .st-danger{ color:#f87171; background:rgba(239,68,68,.1); border-color:rgba(239,68,68,.2); }
  
  /* CAMBIO: qty-box ahora es interactiva para abrir el modal si se quiere */
  .qty-box{ background: rgba(0,0,0,.3); border-radius:12px; padding:12px; display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:12px; border:1px solid rgba(255,255,255,.05); cursor: pointer; transition: background .2s; pointer-events: auto; }
  .qty-box:hover{ background: rgba(0,0,0,.5); border-color: var(--accent); }

  .qty-val{ font-size:28px; font-weight:900; line-height:1; } .qty-unit{ font-size:13px; color:var(--muted); font-weight:600; margin-left:4px; } .qty-min{ text-align:right; font-size:11px; color:var(--muted); opacity:.7; }
  .actions{ display:flex; gap:8px; pointer-events:auto; }
  .btn-act{ flex:1; height:34px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text); cursor:pointer; font-weight:700; transition:.1s; display:flex; align-items:center; justify-content:center; }
  
  /* CAMBIO: Colores m√°s vivos en hover para botones de acci√≥n r√°pida */
  .btn-act:active { transform: scale(0.95); }
  .btn-act:hover{ background:rgba(255,255,255,.08); } 
  .btn-act.add:hover{ border-color:rgba(34,197,94,.4); background:rgba(34,197,94,.1); color:#4ade80; } 
  .btn-act.sub:hover{ border-color:rgba(239,68,68,.4); background:rgba(239,68,68,.1); color:#f87171; }
  
  .clean-slate{ grid-column: 1 / -1; text-align:center; padding: 60px 20px; color: var(--muted); border: 1px dashed var(--border); border-radius: 20px; background: rgba(255,255,255,.01); } .clean-slate h2{ color:var(--text); margin-top:0; }

  /* Panels & Modals */
  #alertPanel{ position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-150%); background: rgba(15,23,42,0.95); border: 1px solid var(--warn); box-shadow: 0 10px 40px rgba(0,0,0,0.5); backdrop-filter: blur(10px); border-radius: 16px; padding: 16px 20px; width: min(450px, 90vw); z-index: 500; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); display:flex; flex-direction:column; gap:12px; }
  #alertPanel.show{ transform:translateX(-50%) translateY(0); }
  .ap-header{ display:flex; align-items:center; gap:12px; color: #fbbf24; font-weight:bold; font-size:15px; } .ap-icon{ font-size:24px; }
  .ap-body{ background: rgba(255,255,255,0.05); border-radius:10px; padding:10px 12px; display:flex; align-items:center; gap:10px; justify-content:space-between; }
  .ap-label{ font-size:12px; color:var(--muted); font-weight:600; } .ap-input{ width:60px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:#fff; padding:6px; border-radius:6px; text-align:center; font-weight:bold; outline:none; }
  .ap-footer{ display:flex; gap:10px; margin-top:4px; }
  .ap-btn{ flex:1; padding:8px; border-radius:8px; border:none; cursor:pointer; font-weight:700; font-size:12px; }
  .ap-btn.snooze{ background:rgba(255,255,255,0.1); color:var(--text); border:1px solid var(--border); } .ap-btn.snooze:hover{ background:rgba(255,255,255,0.15); }
  .ap-btn.dismiss{ background:var(--warn); color:#000; } .ap-btn.dismiss:hover{ filter:brightness(1.1); }

  .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:100; } .backdrop.show{ display:flex; }
  .modal{ width:min(500px, 90%); background:#0f172a; border:1px solid var(--border); border-radius:20px; padding:20px; box-shadow:var(--shadow); animation: slideUp .2s ease-out; }
  @keyframes slideUp{ from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
  .form-group{ margin-bottom:16px; } .form-group label{ display:block; font-size:12px; font-weight:700; color:var(--muted); margin-bottom:6px; }
  .input-row{ display:flex; gap:8px; } .form-control{ width:100%; background:rgba(0,0,0,.3); border:1px solid var(--border); color:var(--text); padding:10px; border-radius:10px; outline:none; font-family:inherit; } .form-control:focus{ border-color:var(--accent); }
  select.form-control{ appearance:none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239fb0c8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat:no-repeat; background-position:right 10px center; background-size:16px; }

  /* SYMBOL MENU */
  .sym-menu { position: absolute; right: 0; top: 45px; z-index: 200; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 8px; display: none; grid-template-columns: repeat(4, 1fr); gap: 4px; box-shadow: var(--shadow); width: 180px; }
  .sym-menu.show { display: grid; animation: fadeIn .1s; }
  .sym-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 8px 0; text-align: center; cursor: pointer; font-size: 14px; font-weight: bold; user-select: none; transition: .1s; }
  .sym-btn:hover { background: var(--accent); color: #000; border-color:var(--accent); }

  #toast{ position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(50px); background:#1e293b; border:1px solid var(--accent); color:#fff; padding:10px 20px; border-radius:30px; font-size:13px; font-weight:600; opacity:0; pointer-events:none; transition: all .3s; z-index:200; } #toast.visible{ opacity:1; transform:translateX(-50%) translateY(0); }

  /* --- ESTILOS DE IMPRESI√ìN --- */
  #printArea { display: none; }
  @media print {
    .wrap, #alertPanel, .backdrop, #toast { display: none !important; }
    body { background: white; margin: 0; padding: 0; color: #000; }
    #printArea { display: block; width: 100%; padding: 8mm 12mm; font-family: 'Courier New', Courier, monospace; }
    .p-header { display:flex; justify-content:space-between; align-items:flex-end; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
    .p-title h1 { font-size: 26px; font-weight: 900; margin:0; text-transform: uppercase; letter-spacing: -1px; }
    .p-title h2 { font-size: 14px; color: #444; margin:0; text-transform: uppercase; font-weight:bold; }
    .p-checks { display:flex; gap: 20px; margin-top: 5px; }
    .p-chk { display:flex; align-items:center; gap: 6px; font-size: 12px; font-weight: bold; border:1px solid #666; padding: 2px 8px; }
    .p-box { width: 12px; height: 12px; border: 1px solid #000; display:inline-block; }
    .p-subtitle { font-size: 10px; color: #666; margin-top:5px; font-style: italic; }
    .p-meta { text-align: right; font-size: 12px; line-height: 1.6; }
    .p-line { border-bottom: 1px solid #000; display: inline-block; width: 120px; }
    .p-section-title { background: #000; color: #fff; padding: 4px 8px; font-size: 12px; font-weight: bold; text-transform: uppercase; margin-top: 20px; margin-bottom: 5px; page-break-after: avoid; }
    .p-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
    .p-row { border-bottom: 1px solid #999; page-break-inside: avoid; height: auto; min-height: 36px; }
    .p-row:nth-child(even) { background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; }
    .p-cell-name { padding: 2px 4px; font-weight: bold; font-size: 12px; width: 12%; vertical-align: middle; border-right: 1px solid #999; white-space: normal; overflow: visible; word-break: break-word; line-height: 1.1; }
    .p-cell-name span { display: block; font-weight: normal; font-size: 9px; color: #555; margin-top: 2px; font-style: italic; }
    .p-cell-grid { padding: 2px 4px; display: flex; flex-wrap: nowrap; gap: 1px; width: 100%; height: 100%; align-items: center; }
    .p-cb { flex: 1; height: 26px; min-width: 15px; border: 1px solid #555; display: flex; align-items: flex-start; justify-content: center; padding-top: 2px; font-size: 10px; font-weight: 700; color: #555; background: #fff; }
    .p-cb:nth-child(5n) { margin-right: 6px; border-right: 2px solid #333; }
    .p-cb:last-child { margin-right: 0; }
    .p-cell-tot { width: 50px; border-left: 2px solid #000; vertical-align: top; text-align: center; padding-top: 4px; }
    .tot-label { display:block; font-size: 8px; color: #555; margin-bottom: 12px; font-weight:bold; letter-spacing:1px; }
    .tot-line { display:block; border-bottom: 1px solid #ccc; width: 80%; margin:0 auto; }
    .p-footer { margin-top: 30px; border: 2px solid #000; height: 80px; display: flex; page-break-inside: avoid; }
    .p-f-col:first-child { flex: 1; border-right: 1px solid #000; padding: 5px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
    .p-f-col:last-child { flex: 0 0 15%; border:none; padding: 5px; font-size: 10px; font-weight: bold; text-transform: uppercase; text-align: center; display: flex; flex-direction: column; justify-content: flex-end; }
  }
</style>

<script type="module" src="cloud_sync.js"></script>
</head>
<body>
<div style="position:fixed; top:16px; left:16px; z-index:9999;"><button onclick="window.location.href='index.html'" style="padding:8px 14px;background:#0ea5e9;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">‚¨Ö Volver al men√∫</button></div>

<div class="wrap">
  <header>
    <div class="brand">
      <h1>Gesti√≥n Stock Taller</h1>
      <p>Control de materiales</p>
    </div>
    <div class="actions">
      <button class="btn primary" onclick="openMaterialModal()"><span>Ôºã</span> Nuevo Material</button>
    </div>
  </header>

  <div class="summary">
    <div class="pill" onclick="filterByStatus(null)" id="pillTotal" title="Ver todos"><div class="lbl"><span class="dot" style="color:var(--accent)"></span> Inventario</div><div class="val" id="sumTotal">0</div></div>
    <div class="pill" onclick="filterByStatus('ok')" id="pillOk" title="Ver stock correcto"><div class="lbl"><span class="dot" style="color:var(--ok)"></span> OK</div><div class="val" id="sumOk">0</div></div>
    <div class="pill" onclick="filterByStatus('warn')" id="pillWarn" title="Ver stock bajo"><div class="lbl"><span class="dot" style="color:var(--warn)"></span> Bajo</div><div class="val" id="sumLow">0</div></div>
    <div class="pill" onclick="filterByStatus('danger')" id="pillZero" title="Ver agotados"><div class="lbl"><span class="dot" style="color:var(--danger)"></span> Agotado</div><div class="val" id="sumZero">0</div></div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="sb-head">Categor√≠as</div>
      <div id="categoryTree"></div>
    </aside>

    <main>
      <div class="toolbar">
        <div class="search-box"><span>üîé</span><input type="text" id="searchInput" placeholder="Buscar material..." autocomplete="off"></div>
      </div>
      <div id="grid" class="grid"></div>
    </main>
  </div>
</div>

<div id="printArea"></div>

<div id="alertPanel">
  <div class="ap-header"><span class="ap-icon">‚ö†</span><span id="alertMsg">Problemas de stock</span></div>
  <div class="ap-body"><span class="ap-label">Recordar aviso en:</span><div style="display:flex;align-items:center;gap:8px;"><input type="number" id="snoozeDays" class="ap-input" value="1" min="1"><span class="ap-label">d√≠as</span></div></div>
  <div class="ap-footer"><button class="ap-btn snooze" onclick="snoozeAlert()">‚è∞ Posponer</button><button class="ap-btn dismiss" onclick="dismissAlert()">OK, Cerrar</button></div>
</div>

<div class="backdrop" id="modalMaterial">
  <div class="modal">
    <h2 id="modalTitle" style="margin-top:0">Nuevo Material</h2>
    <div class="form-group">
      <label>Categor√≠a</label>
      <div class="input-row"><select id="inpCatSelect" class="form-control" onchange="syncCat(this)"></select><button class="btn icon" onclick="promptNew('cat')">Ôºã</button></div>
    </div>
    <div class="form-group">
      <label>Grupo</label>
      <div class="input-row"><select id="inpGrpSelect" class="form-control"></select><button class="btn icon" onclick="promptNew('grp')">Ôºã</button></div>
    </div>
    
    <div class="form-group">
      <label>Nombre</label>
      <div class="input-row" style="position:relative">
        <input id="inpName" class="form-control" placeholder="Ej: Tubo 40x40" />
        <button class="btn icon" onclick="toggleSym()" title="S√≠mbolos">Œ©</button>
        <div id="symGrid" class="sym-menu">
          <div class="sym-btn" onclick="ins('√∏')">√∏</div><div class="sym-btn" onclick="ins('x')">x</div><div class="sym-btn" onclick="ins('mm')">mm</div><div class="sym-btn" onclick="ins('cm')">cm</div>
          <div class="sym-btn" onclick="ins('m')">m</div><div class="sym-btn" onclick="ins('kg')">kg</div><div class="sym-btn" onclick="ins('¬∞')">¬∞</div><div class="sym-btn" onclick="ins('&quot;')">"</div>
          <div class="sym-btn" onclick="ins('¬Ω')">¬Ω</div><div class="sym-btn" onclick="ins('¬º')">¬º</div><div class="sym-btn" onclick="ins('¬æ')">¬æ</div><div class="sym-btn" onclick="ins('#')">#</div>
        </div>
      </div>
    </div>

    <div class="input-row"><div class="form-group" style="flex:1"><label>Unidad</label><input id="inpUnit" class="form-control" placeholder="ud" /></div><div class="form-group" style="flex:1"><label>M√≠nimo</label><input id="inpMin" type="number" class="form-control" placeholder="5" /></div></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:20px;">
      <button class="btn danger" id="btnDeleteMat" style="display:none" onclick="deleteMaterial()">üóë Eliminar</button>
      <button class="btn warn" id="btnResetQty" style="display:none" onclick="resetMaterialToZero()">‚Ü∫ Reiniciar a 0</button>
      <div style="display:flex;gap:10px;margin-left:auto;"><button class="btn ghost" onclick="closeModal('modalMaterial')">Cancelar</button><button class="btn primary" id="btnSaveMat" onclick="saveMaterial()">Guardar</button></div>
    </div>
  </div>
</div>

<div class="backdrop" id="modalMove">
  <div class="modal" style="width:350px">
    <h2 id="moveTitle" style="margin-top:0">Ajuste Manual</h2>
    <p id="moveSub" style="color:var(--muted); font-size:13px; margin-top:-10px; margin-bottom:20px;"></p>
    <div class="form-group"><label>Cantidad a sumar/restar</label><input id="moveQty" type="number" class="form-control" style="font-size:24px;font-weight:bold;text-align:center;" autofocus /></div>
    <div style="display:flex;justify-content:space-between;margin-top:20px;"><button class="btn ghost" onclick="closeModal('modalMove')">Cancelar</button><button class="btn primary" id="btnConfirmMove">Confirmar</button></div>
  </div>
</div>

<div id="toast"></div>

<!-- Firebase (Compat, sin bundlers) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/** GESTI√ìN STOCK TALLER V7.2 + AUTOSYNC FIRESTORE (sin cambiar tu UI)
 *  - localStorage sigue siendo la cache local (DB_KEY)
 *  - al abrir: intenta descargar Firestore -> localStorage
 *  - escucha cambios remotos (onSnapshot) y repinta sin romper filtros/busqueda
 *  - cada cambio local hace auto-guardado (debounce) a Firestore
 */

// ====== CONFIG FIRESTORE ======
const USE_FIRESTORE = true;
const FIRESTORE_DOC_PATH = { col: "taller_stock", doc: "main" }; // puedes cambiarlo si quieres

const firebaseConfig = {
  apiKey: "AIzaSyDGIfICSG_KE6QzmKHj3CzgvYeHaUcgARo",
  authDomain: "gestion-taller-2a439.firebaseapp.com",
  projectId: "gestion-taller-2a439",
  storageBucket: "gestion-taller-2a439.firebasestorage.app",
  messagingSenderId: "498579673950",
  appId: "1:498579673950:web:eb626781a5b509957db5cf"
};

// ====== DB LOCAL (TU MISMO SISTEMA) ======
const DB_KEY="taller_stock_v3_data", SNOOZE_KEY="taller_stock_snooze_until";

// === Sync local entre pesta√±as/ventanas (LocalStorage) ===
// IMPORTANTE: si abres los HTML con file://, cada archivo tiene un origen distinto y NO comparte localStorage.
// Para probar sincronizaci√≥n local, abre con un servidor (http://localhost) o en GitHub Pages.
function __reloadStockFromLS(){
  try{
    const raw = localStorage.getItem(DB_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      if(parsed && typeof parsed==='object'){
        materials = Array.isArray(parsed.materials) ? parsed.materials : (materials||[]);
        movements = Array.isArray(parsed.movements) ? parsed.movements : (movements||[]);
      }
    }
  }catch(e){}
  try{ if(typeof renderTree==='function') renderTree(); }catch(e){}
  try{ if(typeof renderMovements==='function') renderMovements(); }catch(e){}
  try{ if(typeof renderStats==='function') renderStats(); }catch(e){}
}
window.addEventListener('storage', (ev)=>{
  if(ev && ev.key===DB_KEY){
    __reloadStockFromLS();
  }
});
let materials=[], movements=[], currentFilter={cat:null,grp:null,status:null};
let categoryOrder = [];

// ====== FIRESTORE HELPERS ======
let fbApp=null, fbAuth=null, fbDb=null;
let fsUnsub=null;
let fsReady=false;
let ignoreNextLocalSave=false;
let pendingSaveTimer=null;

function fbEnsure(){
  if(fbApp) return;
  fbApp = firebase.initializeApp(firebaseConfig);
  fbAuth = firebase.auth();
  fbDb   = firebase.firestore();
}

async function fsLoginHidden(){
  // Intento con login an√≥nimo (si reglas lo permiten)
  // Si tu regla permite lectura sin auth, igualmente funciona.
  try{
    if(!fbAuth.currentUser){
      await fbAuth.signInAnonymously();
    }
  }catch(e){
    // No bloqueamos el stock si auth falla; Firestore igual puede permitir lectura p√∫blica.
    console.warn("Auth an√≥nimo no disponible:", e);
  }
}

function fsDocRef(){
  return fbDb.collection(FIRESTORE_DOC_PATH.col).doc(FIRESTORE_DOC_PATH.doc);
}

async function fsLoadOnceToLocal(){
  const snap = await fsDocRef().get();
  if(!snap.exists) return false;
  const data = snap.data() || {};
  if(!Array.isArray(data.materials) || !Array.isArray(data.movements)) return false;

  ignoreNextLocalSave = true;
  localStorage.setItem(DB_KEY, JSON.stringify({
    materials: data.materials || [],
    movements: data.movements || [],
    categoryOrder: data.categoryOrder || []
  }));
  ignoreNextLocalSave = false;

  materials = data.materials || [];
  movements = data.movements || [];
  categoryOrder = data.categoryOrder || [];
  return true;
}

function fsStartRealtimeListener(){
  if(fsUnsub) fsUnsub();
  fsUnsub = fsDocRef().onSnapshot((snap)=>{
    if(!snap.exists) return;
    const data = snap.data() || {};
    if(!Array.isArray(data.materials) || !Array.isArray(data.movements)) return;

    ignoreNextLocalSave = true;
    localStorage.setItem(DB_KEY, JSON.stringify({
      materials: data.materials || [],
      movements: data.movements || [],
      categoryOrder: data.categoryOrder || []
    }));
    ignoreNextLocalSave = false;

    materials = data.materials || [];
    movements = data.movements || [];
    categoryOrder = data.categoryOrder || [];

    // Repintado sin cambiar tu UI/flujo
    renderTree();
    updateSummary();
    renderGrid();
    checkAlerts();
  }, (err)=>{
    console.warn("Firestore onSnapshot error:", err);
  });
}

function scheduleFsSave(){
  if(!USE_FIRESTORE || !fsReady) return;
  if(ignoreNextLocalSave) return;

  clearTimeout(pendingSaveTimer);
  pendingSaveTimer = setTimeout(async ()=>{
    try{
      const payload = {
        materials,
        movements,
        categoryOrder,
        updatedAt: new Date().toISOString()
      };
      await fsDocRef().set(payload, { merge: true });
    }catch(e){
      console.warn("No se pudo guardar en Firestore:", e);
    }
  }, 450);
}

// ====== INIT (mantiene tu init, pero con sync) ======
async function initWithSync(){
  // 1) cargar local (igual que antes)
  const d=localStorage.getItem(DB_KEY);
  if(d){
    try{
      const p=JSON.parse(d);
      materials=p.materials||[];
      movements=p.movements||[];
      categoryOrder=p.categoryOrder||[];
      cleanDuplicates();
    }catch(e){
      materials=[]; movements=[]; categoryOrder=[];
    }
  } else {
    // si no hay local, dejamos que Firestore mande (si existe). Si no existe, usamos tu semilla.
    materials=[]; movements=[]; categoryOrder=[];
  }

  // 2) Firestore: traer remoto (si existe) y escuchar
  if(USE_FIRESTORE){
    try{
      fbEnsure();
      await fsLoginHidden();
      const ok = await fsLoadOnceToLocal();
      fsReady = true;
      fsStartRealtimeListener();

      if(!ok){
        // Si NO existe a√∫n en Firestore, entonces usamos tu semilla original y subimos
        if(!materials.length){
          materials=[
            {id:uuid(),cat:"Soldadura, Corte y Desbaste",grp:"Discos",name:"Disco 115mm",unit:"ud",min:10},
            {id:uuid(),cat:"Soldadura, Corte y Desbaste",grp:"Electrodos",name:"Electrodo 2.5mm",unit:"caja",min:2},
            {id:uuid(),cat:"Hierro",grp:"Tubos",name:"Tubo 40x40",unit:"br",min:5}
          ];
          saveData(); // esto har√° scheduleFsSave
        }else{
          // si hab√≠a local pero no remoto, subimos local al remoto
          await fsDocRef().set({ materials, movements, categoryOrder, createdAt: new Date().toISOString() }, { merge: true });
        }
      }
    }catch(e){
      console.warn("Firestore no disponible, seguimos en local:", e);
      fsReady = false;
    }
  }

  // 3) tu render normal
  renderTree(); updateSummary(); renderGrid(); checkAlerts();

  document.addEventListener('click', (e)=>{
    if(!e.target.closest('#symGrid') && !e.target.closest('.btn.icon')){ $("symGrid").classList.remove('show'); }
  });
}

// ====== TU C√ìDIGO ORIGINAL (sin tocar UI) ======
function cleanDuplicates(){
  const unique = new Map();
  materials.forEach(m => {
    const key = `${m.name.trim().toLowerCase()}|${m.cat.trim().toLowerCase()}|${m.grp.trim().toLowerCase()}`;
    if(!unique.has(key)){ unique.set(key, m); } 
    else { const original = unique.get(key); movements.forEach(mov => { if(mov.matId === m.id) mov.matId = original.id; }); }
  });
  if(materials.length > unique.size){ materials = Array.from(unique.values()); saveData(); }
}

function saveData(){
  localStorage.setItem(DB_KEY, JSON.stringify({materials,movements,categoryOrder}));
  updateSummary();
  scheduleFsSave(); // <<< √öNICO CAMBIO: autosync
}

const $=id=>document.getElementById(id), uuid=()=>Math.random().toString(36).substr(2,9);
const getStock=id=>movements.filter(m=>m.matId===id).reduce((a,m)=>m.type==='in'?a+m.qty:a-m.qty,0);
const getStatus=m=>{ const s=getStock(m.id); return s<=0?'danger':(s<=m.min?'warn':'ok'); };

/* --- SYMBOL PICKER --- */
function toggleSym(){ $("symGrid").classList.toggle('show'); }
function ins(txt){
  const el = $("inpName");
  const start = el.selectionStart; const end = el.selectionEnd; const val = el.value;
  el.value = val.substring(0, start) + txt + val.substring(end);
  el.selectionStart = el.selectionEnd = start + txt.length;
  el.focus();
}

/* --- TREE & DRAG --- */
let draggedCat = null;

function renderTree(){
  const tree=$("categoryTree"); tree.innerHTML="";
  let cats=[...new Set(materials.map(m=>m.cat))];
  
  cats.sort((a,b) => {
    let ia = categoryOrder.indexOf(a); let ib = categoryOrder.indexOf(b);
    if(ia === -1) ia = 9999; if(ib === -1) ib = 9999;
    if(ia === ib) return a.localeCompare(b);
    return ia - ib;
  });

  if(cats.length !== categoryOrder.length || !cats.every((c,i)=>c===categoryOrder[i])){ categoryOrder = [...cats]; saveData(); }

  if(cats.length===0){ tree.innerHTML=`<div style="padding:10px;color:var(--muted);font-size:13px;">Sin datos.</div>`; return; }

  cats.forEach(cat=>{
    const div=document.createElement("div"); 
    div.className="tree-cat";
    div.draggable = true;
    div.dataset.cat = cat;
    div.addEventListener('dragstart', handleCatDragStart);
    div.addEventListener('dragover', handleCatDragOver);
    div.addEventListener('dragleave', handleCatDragLeave);
    div.addEventListener('drop', handleCatDrop);
    div.addEventListener('dragend', handleCatDragEnd);

    const row=document.createElement("div"); row.className="tree-cat-row";
    row.innerHTML=`<div class="tree-cat-content"><span>‚¨¢ ${cat}</span> <span class="tree-arrow">‚Ä∫</span></div> <div class="row-actions"><span class="act-icon edit" title="Renombrar">‚úé</span><span class="act-icon del" title="Borrar">üóë</span><span class="act-icon print" title="Imprimir Categor√≠a">üñ®</span></div>`;
    
    row.onclick=(e)=>{
      if(e.target.classList.contains('edit')){ e.stopPropagation(); renameCategory(cat); return; }
      if(e.target.classList.contains('del')){ e.stopPropagation(); deleteCategory(cat); return; }
      if(e.target.classList.contains('print')){ e.stopPropagation(); printCategory(cat); return; }
      document.querySelectorAll(".tree-cat").forEach(el=>{ if(el!==div) el.classList.remove("open"); });
      const willOpen = div.classList.toggle("open");
      document.querySelectorAll(".tree-cat-row").forEach(b=>b.classList.remove("open-state"));
      if(willOpen){ row.classList.add("open-state"); filterBy(null, null); document.querySelectorAll(".active").forEach(el=>el.classList.remove("active")); } 
      else { if(currentFilter.cat === cat){ filterBy(null, null); document.querySelectorAll(".active").forEach(el=>el.classList.remove("active")); } }
    };

    const list=document.createElement("div"); list.className="tree-group-list";
    const btnAll=document.createElement("div"); btnAll.className="tree-group-row tree-sub-all";
    btnAll.innerHTML=`<span>üëÅ Ver todo ${cat}</span>`;
    btnAll.onclick=(e)=>{ e.stopPropagation(); filterBy(cat,null); markActive(btnAll); };
    list.appendChild(btnAll);

    [...new Set(materials.filter(m=>m.cat===cat).map(m=>m.grp))].sort().forEach(grp=>{
      const bG=document.createElement("div"); bG.className="tree-group-row";
      bG.innerHTML=`<span>‚Ä¢ ${grp}</span> <div class="row-actions"><span class="act-icon edit" title="Renombrar">‚úé</span><span class="act-icon del" title="Borrar">üóë</span></div>`;
      bG.onclick=(e)=>{ 
        if(e.target.classList.contains('edit')){ e.stopPropagation(); renameGroup(cat, grp); return; }
        if(e.target.classList.contains('del')){ e.stopPropagation(); deleteGroup(cat, grp); return; }
        e.stopPropagation(); 
        if(currentFilter.cat===cat && currentFilter.grp===grp){ filterBy(null, null); document.querySelectorAll(".active").forEach(el=>el.classList.remove("active")); }
        else { filterBy(cat,grp); markActive(bG); }
      };
      list.appendChild(bG);
    });
    div.appendChild(row); div.appendChild(list); tree.appendChild(div);
  });
}
function markActive(el){ document.querySelectorAll(".tree-group-row").forEach(b=>b.classList.remove("active")); el.classList.add("active"); }
function handleCatDragStart(e) { e.stopPropagation(); draggedCat = this.dataset.cat; this.classList.add('dragging-cat'); e.dataTransfer.effectAllowed = 'move'; }
function handleCatDragOver(e) { e.preventDefault(); e.stopPropagation(); this.classList.add('drag-over-cat'); e.dataTransfer.dropEffect = 'move'; }
function handleCatDragLeave(e) { this.classList.remove('drag-over-cat'); }
function handleCatDragEnd(e) { this.classList.remove('dragging-cat'); document.querySelectorAll('.drag-over-cat').forEach(el => el.classList.remove('drag-over-cat')); draggedCat = null; }
function handleCatDrop(e) { e.stopPropagation(); const targetCat = this.dataset.cat; if(draggedCat && draggedCat !== targetCat) { const fromIdx = categoryOrder.indexOf(draggedCat); const toIdx = categoryOrder.indexOf(targetCat); if(fromIdx > -1 && toIdx > -1) { const [item] = categoryOrder.splice(fromIdx, 1); categoryOrder.splice(toIdx, 0, item); saveData(); renderTree(); } } return false; }

function printCategory(cat){
  const rawItems = materials.filter(m => m.cat === cat);
  if(rawItems.length === 0) return toast("Categor√≠a vac√≠a");
  const uniqueItems = []; const seenNames = new Set();
  rawItems.forEach(item => { const n = item.name.trim().toLowerCase(); if(!seenNames.has(n)){ seenNames.add(n); uniqueItems.push(item); } });
  const isIron = cat.toLowerCase().includes("hierro") || cat.toLowerCase().includes("perfil");
  let headerExtra = isIron ? `<div class="p-checks"><div class="p-chk"><div class="p-box"></div> Galvanizado</div><div class="p-chk"><div class="p-box"></div> Negro</div></div>` : `<div class="p-subtitle">Control de unidades consumidas</div>`;
  let html = `<div class="p-header"><div class="p-title"><h1>Hoja de Control</h1><h2>${cat}</h2>${headerExtra}</div><div class="p-meta"><div>ORDEN: <span class="p-line"></span></div><div style="margin-top:4px;">FECHA: <span class="p-line"></span></div><div style="margin-top:4px;">OPERARIO: <span class="p-line"></span></div></div></div><table class="p-table">`;
  uniqueItems.forEach(m => { html += `<tr class="p-row"><td class="p-cell-name">${m.name} <span>${m.unit}</span></td><td><div class="p-cell-grid">${Array.from({length:20}, (_,i)=> `<div class="p-cb">${i+1}</div>`).join('')}</div></td><td class="p-cell-tot"><span class="tot-label">TOT</span><span class="tot-line"></span></td></tr>`; });
  html += `</table><div class="p-footer"><div class="p-f-col">Observaciones / Material Adicional</div><div class="p-f-col" style="border:none"><div style="border-top:1px solid #000;padding-top:4px;">Firma</div></div></div>`;
  $("printArea").innerHTML = html; window.print();
}

/* --- GRID & DRAG DROP --- */
let draggedId = null;
function renderGrid(){
  const grid=$("grid"), s=$("searchInput").value.toLowerCase();
  grid.innerHTML = ""; 
  const clean=!currentFilter.cat && !currentFilter.grp && !currentFilter.status && !s;
  if(clean){ grid.innerHTML=`<div class="clean-slate"><div style="font-size:40px;margin-bottom:10px;">üëã</div><h2>Panel de Control</h2><p>Selecciona una categor√≠a o revisa las alertas.</p></div>`; return; }
  const f=materials.filter(m=>{
    const txt=!s || (m.name.toLowerCase().includes(s)||m.grp.toLowerCase().includes(s));
    let tree=true; if(currentFilter.cat && m.cat!==currentFilter.cat) tree=false; if(currentFilter.grp && m.grp!==currentFilter.grp) tree=false;
    let st=true; if(currentFilter.status){ const x=getStatus(m); if(currentFilter.status!==x) st=false; }
    return txt&&tree&&st;
  });
  if(f.length===0){ grid.innerHTML=`<div class="clean-slate">Sin resultados.</div>`; return; }
  
  f.forEach(m=>{
    const stk=getStock(m.id), st=getStatus(m);
    const cls=st==='danger'?'st-danger':(st==='warn'?'st-warn':'st-ok'), txt=st==='danger'?'AGOTADO':(st==='warn'?'BAJO':'OK');
    const c=document.createElement("div"); c.className="card"; c.draggable = true; c.dataset.id = m.id;
    c.addEventListener('dragstart', handleDragStart); c.addEventListener('dragover', handleDragOver); c.addEventListener('dragleave', handleDragLeave); c.addEventListener('drop', handleDrop); c.addEventListener('dragend', handleDragEnd);
    
    c.innerHTML=`<div class="card-top"><div class="card-titles"><h3>${m.name}</h3><span>${m.cat} > ${m.grp}</span></div><div class="stock-badge ${cls}">${txt}</div></div>
    <div class="qty-box" onclick="openMove('${m.id}','in')" title="Clic para ajuste manual"><div><span class="qty-val">${stk}</span><span class="qty-unit">${m.unit}</span></div><div class="qty-min">Min: ${m.min}</div></div>
    <div class="actions"><button class="btn-act sub" onclick="quickMov(event, '${m.id}','out')">Ôºç</button><button class="btn-act add" onclick="quickMov(event, '${m.id}','in')">Ôºã</button><button class="btn-act" onclick="editMaterial('${m.id}')" style="max-width:40px">‚öôÔ∏è</button></div>`;
    grid.appendChild(c);
  });
}

function handleDragStart(e) { draggedId = this.dataset.id; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; this.classList.add('drag-over'); }
function handleDragLeave(e) { this.classList.remove('drag-over'); }
function handleDragEnd(e) { this.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); }
function handleDrop(e) { e.stopPropagation(); const targetId = this.dataset.id; if(draggedId && draggedId !== targetId) { const fromIndex = materials.findIndex(m => m.id === draggedId); const toIndex = materials.findIndex(m => m.id === targetId); if(fromIndex > -1 && toIndex > -1){ const [item] = materials.splice(fromIndex, 1); materials.splice(toIndex, 0, item); saveData(); renderGrid(); } } return false; }

function updateSummary(){
  let c={ok:0,warn:0,danger:0}; materials.forEach(m=>c[getStatus(m)]++);
  $("sumTotal").textContent=materials.length; $("sumOk").textContent=c.ok; $("sumLow").textContent=c.warn; $("sumZero").textContent=c.danger;
  document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active-filter"));
  if(currentFilter.status==="ok")$("pillOk").classList.add("active-filter");
  if(currentFilter.status==="warn")$("pillWarn").classList.add("active-filter");
  if(currentFilter.status==="danger")$("pillZero").classList.add("active-filter");
}
function filterBy(c,g){ currentFilter={cat:c,grp:g,status:null}; renderGrid(); updateSummary(); }
function filterByStatus(s){
  if(currentFilter.status===s && s!==null) s=null;
  currentFilter={cat:null,grp:null,status:s};
  document.querySelectorAll(".tree-cat").forEach(e=>e.classList.remove("open"));
  document.querySelectorAll(".active").forEach(e=>e.classList.remove("active"));
  renderGrid(); updateSummary();
}
function checkAlerts(){ const u=localStorage.getItem(SNOOZE_KEY); if(u && new Date()<new Date(u)) return; let p=0; materials.forEach(m=>{if(getStatus(m)!=='ok')p++}); if(p>0){ $("alertMsg").textContent=`Atenci√≥n: ${p} problemas.`; $("alertPanel").classList.add("show"); } }
function dismissAlert(){ $("alertPanel").classList.remove("show"); }
function snoozeAlert(){ const d=parseInt($("snoozeDays").value); if(!d||d<1)return; const f=new Date(); f.setDate(f.getDate()+d); localStorage.setItem(SNOOZE_KEY,f.toISOString()); $("alertPanel").classList.remove("show"); toast(`Pospuesto ${d} d√≠as.`); }

/* --- ACTIONS --- */
let edId=null, movId=null, movT=null;
function openMaterialModal(){ edId=null; $("modalTitle").textContent="Nuevo"; $("btnDeleteMat").style.display="none"; $("inpName").value=""; $("inpUnit").value=""; $("inpMin").value=""; popSel(); $("modalMaterial").classList.add("show"); }
function editMaterial(id){ const m=materials.find(x=>x.id===id); if(!m)return; edId=id; $("modalTitle").textContent="Editar"; $("btnDeleteMat").style.display="block"; $("btnResetQty").style.display="block"; popSel(m.cat,m.grp); $("inpName").value=m.name; $("inpUnit").value=m.unit; $("inpMin").value=m.min; $("modalMaterial").classList.add("show"); }

function saveMaterial(){
  const btn = $("btnSaveMat"); if(btn.disabled) return;
  const c=$("inpCatSelect").value, g=$("inpGrpSelect").value, n=$("inpName").value.trim(), u=$("inpUnit").value, m=parseInt($("inpMin").value)||0;
  if(!c||!g||!n||!u) return alert("Completa los datos");
  const existing = materials.find(mat => mat.cat===c && mat.grp===g && mat.name.toLowerCase()===n.toLowerCase() && mat.id !== edId);
  if(existing) return alert("Ya existe un material con ese nombre en este grupo.");
  btn.disabled = true;
  if(edId){ const i=materials.findIndex(x=>x.id===edId); materials[i]={...materials[i],cat:c,grp:g,name:n,unit:u,min:m}; }
  else{ materials.push({id:uuid(),cat:c,grp:g,name:n,unit:u,min:m}); }
  saveData(); renderTree(); renderGrid(); closeModal('modalMaterial'); toast("Guardado"); setTimeout(checkAlerts,500); setTimeout(()=> btn.disabled = false, 500);
}

function popSel(sc,sg){
  const cats=[...new Set(materials.map(m=>m.cat))].sort();
  $("inpCatSelect").innerHTML=`<option value="" disabled ${!sc?'selected':''}>Select</option>`+cats.map(c=>`<option value="${c}" ${c===sc?'selected':''}>${c}</option>`).join("");
  const c=$("inpCatSelect").value;
  const grps=c?[...new Set(materials.filter(m=>m.cat===c).map(m=>m.grp))].sort():[];
  $("inpGrpSelect").innerHTML=`<option value="" disabled ${!sg?'selected':''}>Select</option>`+grps.map(g=>`<option value="${g}" ${g===sg?'selected':''}>${g}</option>`).join("");
}
function syncCat(el){ popSel(el.value,null); }
function promptNew(t){ const v=prompt("Nuevo nombre:"); if(v){ const s=$(t==='cat'?"inpCatSelect":"inpGrpSelect"), o=document.createElement("option"); o.value=v; o.text=v; o.selected=true; s.appendChild(o); } }

// Accion rapida desde botones
function quickMov(e, id, t){
  e.stopPropagation();
  const m = materials.find(x=>x.id===id);
  if(!m) return;
  if(t==='out' && getStock(id) <= 0){ toast("‚õî El stock ya es 0"); return; }

  movements.push({id:uuid(),matId:id,type:t,qty:1,date:new Date().toISOString()});
  saveData(); 
  renderGrid(); 
  checkAlerts();
  toast(t==='in' ? `+1 ${m.name}` : `-1 ${m.name}`);
}

// Ajuste manual
function openMove(id,t){ movId=id; movT=t; $("moveTitle").textContent="Ajuste Manual"; $("moveSub").textContent=materials.find(x=>x.id===id).name; $("moveQty").value=""; $("modalMove").classList.add("show"); setTimeout(()=>$("moveQty").focus(),100); $("moveQty").onkeydown=(e)=>{if(e.key==="Enter")confMov()}; $("btnConfirmMove").onclick=confMov; }

function confMov(){
  let valRaw = $("moveQty").value, q = parseFloat(valRaw);
  if(!valRaw || isNaN(q) || q === 0){ toast("Indica una cantidad v√°lida"); $("moveQty").focus(); return; }
  let type = q > 0 ? 'in' : 'out'; 
  q = Math.abs(q);
  if(type==='out' && q>getStock(movId)){ if(!confirm("‚ö† El stock quedar√° en NEGATIVO.\n¬øContinuar?")) return; }
  movements.push({id:uuid(),matId:movId,type:type,qty:q,date:new Date().toISOString()});
  saveData(); renderGrid(); closeModal('modalMove'); toast("Ajuste registrado"); checkAlerts();
}


function resetMaterialToZero(){
  if(!edId){ toast("No hay material seleccionado"); return; }
  const m = materials.find(x=>x.id===edId);
  if(!m) return;
  const s = getStock(edId);
  if(s === 0){ toast("Ya est√° a 0"); return; }
  if(!confirm(`‚ö† Reiniciar a 0 la cantidad de "${m.name}" (stock actual: ${Number(s).toLocaleString("es-ES")}).
Se registrar√° un ajuste autom√°tico.`)) return;
  const type = s > 0 ? 'out' : 'in';
  const qty = Math.abs(s);
  movements.push({id:uuid(),matId:edId,type:type,qty:qty,date:new Date().toISOString()});
  saveData();
  renderGrid();
  setTimeout(checkAlerts, 200);
  toast("Reiniciado a 0");
}

function renameCategory(oldName){
  const newName = prompt("Nuevo nombre:", oldName);
  if(newName && newName !== oldName){ materials.forEach(m => { if(m.cat === oldName) m.cat = newName; }); saveData(); renderTree(); renderGrid(); toast("Renombrado"); }
}
function renameGroup(cat, oldName){
  const newName = prompt("Nuevo nombre:", oldName);
  if(newName && newName !== oldName){ materials.forEach(m => { if(m.cat === cat && m.grp === oldName) m.grp = newName; }); saveData(); renderTree(); renderGrid(); toast("Renombrado"); }
}
function deleteCategory(cat){ if(confirm(`‚ö† ¬øBorrar categor√≠a "${cat}" y todo su contenido?`)){ materials = materials.filter(m=>m.cat!==cat); saveData(); renderTree(); if(currentFilter.cat===cat) filterBy(null,null); else renderGrid(); toast("Borrado"); } }
function deleteGroup(cat, grp){ if(confirm(`‚ö† ¬øBorrar grupo "${grp}" y sus materiales?`)){ materials = materials.filter(m=> !(m.cat===cat && m.grp===grp)); saveData(); renderTree(); if(currentFilter.cat===cat && currentFilter.grp===grp) filterBy(null,null); else renderGrid(); toast("Borrado"); } }
function deleteMaterial(){ if(!edId) return; if(confirm(`¬øBorrar material?`)){ materials = materials.filter(x=>x.id!==edId); saveData(); renderTree(); renderGrid(); closeModal('modalMaterial'); toast("Eliminado"); } }

function closeModal(id){ $(id).classList.remove("show"); }
$("searchInput").addEventListener("input", renderGrid);
function toast(msg){ const t=$("toast"); t.textContent=msg; t.classList.add("visible"); setTimeout(()=>t.classList.remove("visible"),3000); }

// ARRANQUE: con sync
initWithSync();
</script>

<script>
/* ========= AUTO CLOUD SYNC (FULL LOCALSTORAGE) - COMPAT =========
   - Login an√≥nimo si existe auth
   - Last-Write-Wins por 'rev' en backups/backup_main
*/
(function(){
  const DOC_ID = "backup_main";
  const REV_KEY = "__cloud_backup_rev";
  const CID_KEY = "__cloud_client_id";
  const DEBOUNCE_MS = 2500;

  let applyingRemote = false;
  let timer = null;
  let currentRev = Number(localStorage.getItem(REV_KEY) || "0") || 0;

  function getClientId(){
    let cid = localStorage.getItem(CID_KEY);
    if(!cid){
      cid = "cid_" + Math.random().toString(16).slice(2) + "_" + Date.now();
      localStorage.setItem(CID_KEY, cid);
    }
    return cid;
  }

  function fbReady(){
    return (window.firebase && firebase.apps && firebase.apps.length);
  }

  function ensureFb(){
    if(!window.firebase) return false;
    // si ya hay init, ok
    if(firebase.apps && firebase.apps.length) return true;
    // si el html tiene firebaseConfig global, inicializamos
    try{
      if(window.firebaseConfig) firebase.initializeApp(window.firebaseConfig);
      return true;
    }catch(e){
      console.warn("AutoSync: no se pudo inicializar firebase", e);
      return false;
    }
  }

  async function ensureAuth(){
    try{
      if(!firebase.auth) return;
      const auth = firebase.auth();
      if(!auth.currentUser){
        await auth.signInAnonymously();
      }
    }catch(e){
      // si reglas permiten sin auth, no bloqueamos
    }
  }

  async function backupAll(reason){
    try{
      const db = firebase.firestore();
      const cid = getClientId();
      const all = {};
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        all[k] = localStorage.getItem(k);
      }
      const json = JSON.stringify(all);
      const CHUNK = 800000;
      const total = Math.ceil(json.length / CHUNK);
      const rev = Date.now();

      const metaRef = db.collection("backups").doc(DOC_ID);
      await metaRef.set({
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        rev: rev,
        updatedBy: cid,
        reason: String(reason||""),
        totalChunks: total,
        totalBytes: json.length,
        totalKeys: Object.keys(all).length
      }, { merge: true });

      const chunksCol = metaRef.collection("chunks");
      const batch = db.batch();
      for(let i=0;i<total;i++){
        const part = json.slice(i*CHUNK, (i+1)*CHUNK);
        const cRef = chunksCol.doc(String(i));
        batch.set(cRef, { i, part });
      }
      await batch.commit();

      currentRev = rev;
      localStorage.setItem(REV_KEY, String(rev));
    }catch(e){
      console.warn("‚ùå AutoSync backup error:", e);
    }
  }

  async function restoreAll(){
    const db = firebase.firestore();
    const metaRef = db.collection("backups").doc(DOC_ID);
    const metaSnap = await metaRef.get();
    if(!metaSnap.exists) return;
    const meta = metaSnap.data() || {};
    const total = meta.totalChunks || 0;
    if(!total) return;

    let json = "";
    for(let i=0;i<total;i++){
      const cSnap = await metaRef.collection("chunks").doc(String(i)).get();
      if(!cSnap.exists) throw new Error("Falta chunk " + i);
      json += (cSnap.data().part || "");
    }
    const all = JSON.parse(json);
    localStorage.clear();
    for(const k in all) localStorage.setItem(k, all[k]);
    currentRev = Number(meta.rev || Date.now());
    localStorage.setItem(REV_KEY, String(currentRev));
  }

  function schedule(reason){
    if(applyingRemote) return;
    clearTimeout(timer);
    timer = setTimeout(()=>backupAll(reason), DEBOUNCE_MS);
  }

  function hookStorage(){
    const _setItem = localStorage.setItem.bind(localStorage);
    const _removeItem = localStorage.removeItem.bind(localStorage);
    const _clear = localStorage.clear.bind(localStorage);

    localStorage.setItem = function(k,v){
      const r=_setItem(k,v);
      if(k!==REV_KEY && k!==CID_KEY) schedule("setItem");
      return r;
    };
    localStorage.removeItem = function(k){
      const r=_removeItem(k);
      if(k!==REV_KEY && k!==CID_KEY) schedule("removeItem");
      return r;
    };
    localStorage.clear = function(){
      const r=_clear();
      schedule("clear");
      return r;
    };
    window.addEventListener("storage", (ev)=>{
      if(!ev) return;
      if(ev.key===REV_KEY || ev.key===CID_KEY) return;
      schedule("storage_event");
    });
  }

  function isLocalEmpty(){
    let n=0;
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k===REV_KEY || k===CID_KEY) continue;
      n++;
      if(n>0) break;
    }
    return n===0;
  }

  async function boot(){
    if(!ensureFb()) return;
    await ensureAuth();
    hookStorage();

    const db = firebase.firestore();
    const cid = getClientId();
    const metaRef = db.collection("backups").doc(DOC_ID);

    // restore inicial si local vac√≠o
    if(isLocalEmpty()){
      try{
        const metaSnap = await metaRef.get();
        if(metaSnap.exists){
          const meta = metaSnap.data() || {};
          const rev = Number(meta.rev||0)||0;
          if(rev > currentRev){
            applyingRemote = true;
            await restoreAll();
            // recargar para rehidratar UI
            setTimeout(()=>location.reload(), 250);
          }
        }
      }catch(e){}
      finally{ applyingRemote = false; }
    }

    // listener remoto continuo
    metaRef.onSnapshot(async (snap)=>{
      if(!snap.exists) return;
      const meta = snap.data() || {};
      const rev = Number(meta.rev||0)||0;
      const updatedBy = String(meta.updatedBy||"");
      if(rev <= currentRev) return;
      if(updatedBy && updatedBy===cid) return;

      applyingRemote = true;
      try{
        await restoreAll();
        setTimeout(()=>location.reload(), 250);
      }catch(e){
        console.warn("‚ùå AutoSync restore error:", e);
      }finally{
        applyingRemote = false;
      }
    });

    // primer backup para crear doc si no existe
    setTimeout(()=>schedule("startup"), 3500);
  }

  // arrancar cuando el resto del script haya inicializado firebaseConfig, etc.
  const iv = setInterval(()=>{
    if(window.firebase && (window.firebaseConfig || (firebase.apps && firebase.apps.length))){
      clearInterval(iv);
      boot();
    }
  }, 500);
})();
</script>

</body>
</html>
