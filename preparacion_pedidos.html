<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Preparaci√≥n de pedidos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* === ESTILOS BASE === */
    body { margin:0; font-family:Segoe UI,Arial; background:#0b1220; color:#e6edf7; padding:24px; }
    .top { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    
    /* === BOTONES CORPORATIVOS === */
    .btn { 
        background:linear-gradient(180deg,#0f3c55,#0b2a3d); 
        border:1px solid rgba(255,255,255,.15); 
        color:#6dd6ff; 
        padding:8px 14px; 
        border-radius:10px; 
        cursor:pointer; 
        font-weight:600; 
        transition: filter 0.2s; 
    }
    .btn:hover { filter:brightness(1.15); }
    
    .btn-danger { background:linear-gradient(180deg,#7f1d1d,#450a0a); border-color:#b91c1c; color:#fecaca; }
    .btn-success { background:linear-gradient(180deg,#14532d,#052e16); border-color:#16a34a; color:#86efac; }
    
    /* === BOT√ìN MINI === */
    .btn-mini {
        background: linear-gradient(180deg, #0f3c55, #0b2a3d);
        border: 1px solid rgba(255,255,255,.15);
        color: #6dd6ff;
        padding: 5px 12px; 
        font-size: 11px; 
        border-radius: 6px;
        cursor: pointer; 
        font-weight: 700; 
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: filter 0.2s, box-shadow 0.2s;
        white-space: nowrap;
    }
    .btn-mini:hover { filter: brightness(1.2); box-shadow: 0 0 8px rgba(109, 214, 255, 0.2); }
    .btn-mini.disabled { background: transparent; border: 1px solid rgba(74, 222, 128, 0.2); color: #4ade80; cursor: default; box-shadow: none; filter: none; }

    /* LAYOUT */
    .card { background:linear-gradient(180deg,#0f172a,#020617); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .hidden { display:none !important; }
    .section-title { margin:18px 0 6px 0; font-size:13px; color:#9fb0c8; letter-spacing:.08em; font-weight: 700; text-transform: uppercase; }
    
    /* TABLAS E INPUTS */
    table { width:100%; border-collapse:collapse; margin-top:6px; }
    th, td { border-bottom:1px solid rgba(255,255,255,.08); padding:8px; vertical-align: middle; }
    th { color:#9fb0c8; font-size:12px; text-align:left; }
    input { background:#020617; border:1px solid rgba(255,255,255,.12); color:#e6edf7; border-radius:8px; padding:6px; }
    input[type=number] { width:70px; text-align: center; }
    input:focus { outline: none; border-color: #6dd6ff; }
    
    /* Input especial Unidades */
    .input-unidades { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 14px; font-weight: bold; width: 60px; text-align: center; border-radius: 6px; padding: 4px; transition: all 0.3s; }
    .input-unidades:focus { border-color: #6dd6ff; background: rgba(0,0,0,0.3); }

    /* Estado Filas */
    tr.ok { background: linear-gradient(180deg, rgba(24,130,72,.28), rgba(12,78,44,.18)); box-shadow: inset 0 0 0 1px rgba(110,255,170,.18); }
    tr.ok td { color: #e9fff1; }
    .flash-limit { animation: clampFlash .5s ease-in-out 1; border-color: #ef4444 !important; }
    @keyframes clampFlash { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } 50% { box-shadow: 0 0 0 4px rgba(239,68,68,0.25); } }

    /* Listado */
    .list { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px; }
    .item { padding:12px; border-radius:12px; background:#020617; border:1px solid rgba(255,255,255,.08); cursor:pointer; transition: border-color 0.2s; }
    .item:hover { border-color:rgba(109,214,255,.35); background: rgba(255,255,255,0.02); }
    .badge { font-size:11px; padding:2px 8px; border-radius:999px; font-weight: bold; text-transform: uppercase; }
    .b-p { background:#f59e0b; color:#111; }
    .b-pa { background:#fb923c; color:#111; }
    .b-c { background:#22c55e; color:#111; }

    /* Control Panel */
    .control-panel { display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:12px; margin: 15px 0; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; }
    .radio-group { display:flex; gap:10px; }
    .radio-btn { display:flex; align-items:center; gap:6px; padding:6px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.3); cursor:pointer; user-select: none; }
    .radio-btn input { margin:0; }
    .actions { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:20px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); }

    /* === MODAL DE CREACI√ìN === */
    .modal-backdrop { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); z-index:1000; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; }
    .modal-backdrop.active { opacity:1; pointer-events:auto; }
    
    .modal-box { width:90%; max-width:450px; background:#0f172a; border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:20px; box-shadow:0 20px 50px rgba(0,0,0,0.5); transform:translateY(20px); transition:transform 0.2s; }
    .modal-backdrop.active .modal-box { transform:translateY(0); }
    
    .modal-title { font-size:16px; font-weight:bold; color:#fff; margin-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; }
    .modal-field { margin-bottom:14px; }
    .modal-label { display:block; font-size:12px; color:#9fb0c8; margin-bottom:5px; font-weight:600; }
    
    .input-group { display:flex; gap:8px; }
    .modal-select { flex:1; background:#020617; border:1px solid rgba(255,255,255,0.15); color:#fff; padding:8px; border-radius:8px; outline:none; font-family:inherit; }
    .modal-input { flex:1; background:#020617; border:1px solid #38bdf8; color:#fff; padding:8px; border-radius:8px; outline:none; }
    .btn-icon { width:36px; padding:0; display:flex; align-items:center; justify-content:center; font-size:18px; }
    
    .modal-info { background:rgba(56,189,248,0.1); border:1px solid rgba(56,189,248,0.2); color:#38bdf8; padding:10px; border-radius:8px; font-size:12px; margin-bottom:16px; }
</style>
</head>
<body>

<div class="top">
  <div style="display:flex;gap:10px">
    <button class="btn" onclick="volverIndex()">‚Üê Volver al index</button>
    <button class="btn" onclick="volverLista()">‚Üê Volver a pedidos</button>
  </div>
  <h2 style="margin:0">Preparaci√≥n</h2>
</div>

<div id="vistaLista" class="card">
  <h3>Pedidos en curso</h3>
  <div id="lista" class="list"></div>
</div>

<div id="vistaDetalle" class="card hidden">
  <div style="display:flex; justify-content:space-between; align-items:flex-end;">
      <div>
        <div style="font-size:12px; color:#9fb0c8;">REFERENCIA</div>
        <div style="font-size:18px; font-weight:bold; color:#fff;" id="ref"></div>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
            <div style="font-size:14px; color:#6dd6ff;" id="concepto"></div>
            <div style="display:flex; align-items:center; gap:5px; background:rgba(0,0,0,0.3); padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.1);">
                <span style="font-size:11px; color:#9fb0c8; text-transform:uppercase; font-weight:bold;">Uds:</span>
                <input type="number" id="inputUnidades" class="input-unidades" min="0" onchange="guardarUnidadesManual()">
            </div>
        </div>
      </div>
      <button class="btn btn-success" onclick="marcarTodoOk()">‚úì OK Todo</button>
  </div>

  <div id="panelHierro" class="hidden control-panel">
      <span style="font-weight:700; color:#cbd5e1;">Tipo de Perfiler√≠a:</span>
      <div class="radio-group">
          <label class="radio-btn"><input type="radio" name="th" value="galvanizado" onchange="guardarTipoHierro()"> Galvanizado</label>
          <label class="radio-btn"><input type="radio" name="th" value="negro" onchange="guardarTipoHierro()"> Negro</label>
      </div>
      <span style="font-size:11px; opacity:0.6; margin-left:auto;">(Requerido para guardar barras)</span>
  </div>

  <div id="bloqueBarras" class="hidden">
    <div class="section-title">PERFILER√çA ¬∑ BARRAS</div>
    <table>
      <thead><tr><th width="30">OK</th><th>Material</th><th>Pedida</th><th>Recibida</th><th width="140">Acci√≥n</th><th>Obs</th></tr></thead>
      <tbody id="tbodyBarras"></tbody>
    </table>
  </div>

  <div id="bloqueUnidades" class="hidden">
    <div class="section-title">ACCESORIOS ¬∑ UNIDADES</div>
    <table>
      <thead><tr><th width="30">OK</th><th>Material</th><th>Pedida</th><th>Recibida</th><th width="140">Acci√≥n</th><th>Obs</th></tr></thead>
      <tbody id="tbodyUnidades"></tbody>
    </table>
  </div>

  <div class="actions">
    <button class="btn-danger btn" onclick="eliminarPedido()">üóë Eliminar pedido</button>
    <button class="btn" onclick="confirmarTodoRecepcion()">üíæ Mandar a fabricaci√≥n</button>
  </div>
</div>

<div id="modalCrear" class="modal-backdrop">
    <div class="modal-box">
        <div class="modal-title">Crear Ficha de Stock</div>
        
        <div class="modal-info">
            El material <strong><span id="modMatName"></span></strong> no existe.<br>
            Def√≠nelo para a√±adirlo al stock.
        </div>

        <div class="modal-field">
            <span class="modal-label">CATEGOR√çA</span>
            <div class="input-group">
                <select id="modCatSelect" class="modal-select" onchange="cargarGruposModal()"></select>
                <input id="modCatInput" class="modal-input hidden" placeholder="Nueva Categor√≠a...">
                <button class="btn btn-icon" onclick="toggleInput('cat')">Ôºã</button>
            </div>
        </div>

        <div class="modal-field">
            <span class="modal-label">GRUPO / FAMILIA</span>
            <div class="input-group">
                <select id="modGrpSelect" class="modal-select"></select>
                <input id="modGrpInput" class="modal-input hidden" placeholder="Nuevo Grupo...">
                <button class="btn btn-icon" onclick="toggleInput('grp')">Ôºã</button>
            </div>
        </div>

        <div style="display:flex; gap:12px;">
            <div class="modal-field" style="flex:1;">
                <span class="modal-label">CANTIDAD A SUMAR</span>
                <input id="modQtyInput" type="number" class="modal-select" style="width:100%; box-sizing:border-box; border-color:#38bdf8; color:#38bdf8; font-weight:bold; text-align:center;">
            </div>
            
            <div class="modal-field" style="flex:1;">
                <span class="modal-label">UNIDAD (Ej: Caja)</span>
                <input id="modUnitInput" class="modal-select" placeholder="ud" style="width:100%; box-sizing:border-box;">
            </div>
            
            <div class="modal-field" style="width:80px;">
                <span class="modal-label">M√çNIMO</span>
                <input id="modMinInput" type="number" class="modal-select" placeholder="0" style="width:100%; box-sizing:border-box; text-align:center;">
            </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="btn" style="background:transparent; border:none; color:#9fb0c8;" onclick="cerrarModalCreacion()">Cancelar</button>
            <button class="btn btn-success" onclick="guardarNuevoMaterial()">Guardar y A√±adir</button>
        </div>
    </div>
</div>

<script>
// === CONSTANTES ===
let currentOrderId = null; 
const LS = localStorage;
const KP = r => "prep_recepcion_" + r;
const KM = r => "prep_meta_" + r; 
const STOCK_DB_KEY = "taller_stock_v3_data"; 
const uuid = () => Math.random().toString(36).substr(2,9);

// Variables Globales
let refActual = "";
let estadoMateriales = [];
let metaActual = {};
let pendingCreation = null; 

// === IMPORTACI√ìN DE DATOS ===
(function verificarImports() {
    const encontrarNumero = (obj) => {
        if (!obj) return null;
        const posiblesKeys = ["cantidad", "unidades", "units", "qty", "quantity", "amount", "totalUnits", "total"];
        for (let key of posiblesKeys) { if (obj[key] !== undefined && obj[key] !== null && obj[key] !== "") return parseFloat(obj[key]); }
        if (obj.vars) { for (let key of posiblesKeys) { if (obj.vars[key] !== undefined && obj.vars[key] !== null && obj.vars[key] !== "") return parseFloat(obj.vars[key]); } }
        return null; 
    };

    const snapRaw = LS.getItem("latest_materials_v1");
    if (snapRaw) {
        try {
            const snap = JSON.parse(snapRaw);
            const ref = String(snap.referencia || "SIN_REF_" + Date.now());
            let qty = encontrarNumero(snap) || 1;

            let metaParaGuardar = JSON.parse(LS.getItem(KM(ref)) || "{}");
            metaParaGuardar.referencia = ref;
            metaParaGuardar.concepto = snap.concepto || metaParaGuardar.concepto || "";
            metaParaGuardar.unidades = qty;
            metaParaGuardar.fecha = Date.now();
            if (!metaParaGuardar.tipo_hierro) metaParaGuardar.tipo_hierro = "";

            LS.setItem(KM(ref), JSON.stringify(metaParaGuardar));
            if (!LS.getItem(KP(ref))) LS.setItem(KP(ref), JSON.stringify(snap.materiales || []));
            
            LS.removeItem("latest_materials_v1");
            LS.removeItem("pedido_en_preparacion"); 
        } catch (e) { console.error("Error importando:", e); }
    }
})();

// === NAVEGACI√ìN Y RENDERIZADO ===
function volverIndex() { location.href = "index.html"; }
function volverLista() {
    document.getElementById("vistaDetalle").classList.add("hidden");
    document.getElementById("vistaLista").classList.remove("hidden");
    refActual = "";
    cargarLista();
}

function cargarLista() {
    const lista = document.getElementById("lista");
    lista.innerHTML = "";
    const keys = Object.keys(LS).filter(k => k.startsWith("prep_recepcion_"));
    if(keys.length === 0) { lista.innerHTML = "<div style='opacity:0.5; padding:20px'>No hay pedidos en preparaci√≥n.</div>"; return; }

    keys.reverse().forEach(k => {
        const ref = k.replace("prep_recepcion_", "");
        const meta = JSON.parse(LS.getItem(KM(ref)) || "{}");
        const lines = JSON.parse(LS.getItem(k) || "[]");
        const totalLines = lines.length;
        const completeLines = lines.filter(l => (l.aplicado_qty || 0) >= (l.qty_pedida || 0)).length;
        
        let badgeClass = "b-p"; let badgeText = "Pendiente";
        if (totalLines > 0 && completeLines > 0 && completeLines < totalLines) { badgeClass = "b-pa"; badgeText = "Parcial"; }
        else if (totalLines > 0 && completeLines === totalLines) { badgeClass = "b-c"; badgeText = "Completo"; }

        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                <span style="font-weight:bold; color:#fff">${ref}</span>
                <span class="badge ${badgeClass}">${badgeText}</span>
            </div>
            <div style="font-size:12px; color:#9fb0c8; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                ${meta.concepto || "Sin concepto"} (${meta.unidades || 1} uds)
            </div>`;
        item.onclick = () => abrirPedido(ref);
        lista.appendChild(item);
    });
}

function abrirPedido(ref) {
    refActual = ref;
    document.getElementById("vistaLista").classList.add("hidden");
    document.getElementById("vistaDetalle").classList.remove("hidden");
    metaActual = JSON.parse(LS.getItem(KM(ref)) || "{}");
    estadoMateriales = JSON.parse(LS.getItem(KP(ref)) || "[]");
    
    document.getElementById("ref").textContent = ref;
    document.getElementById("concepto").textContent = metaActual.concepto || "";
    document.getElementById("inputUnidades").value = (metaActual.unidades || 1);
    
    const radios = document.getElementsByName("th");
    radios.forEach(r => r.checked = (r.value === metaActual.tipo_hierro));
    renderTabla();
}

function guardarUnidadesManual() {
    const val = parseFloat(document.getElementById("inputUnidades").value) || 1;
    metaActual.unidades = val;
    LS.setItem(KM(refActual), JSON.stringify(metaActual));
}

function renderTabla() {
    const tbodyBarras = document.getElementById("tbodyBarras");
    const tbodyUnidades = document.getElementById("tbodyUnidades");
    tbodyBarras.innerHTML = ""; tbodyUnidades.innerHTML = "";
    let hasBarras = false; let hasUnidades = false;

    estadoMateriales.forEach((linea, index) => {
        const pedida = parseFloat(linea.qty_pedida) || 0;
        const recibida = parseFloat(linea.qty_recibida) || 0;
        const yaAplicada = parseFloat(linea.aplicado_qty) || 0;
        const diff = recibida - yaAplicada;
        
        const isComplete = linea.ok || (pedida > 0 && recibida >= pedida) || (pedida > 0 && yaAplicada >= pedida);
        const rowClass = isComplete ? "ok" : "";
        
        let btnHtml = "";
        if (diff > 0) btnHtml = `<button class="btn-mini" onclick="guardarLinea(${index})">A√±adir a stock (+${diff})</button>`;
        else if (yaAplicada > 0) btnHtml = `<button class="btn-mini disabled">‚úÖ OK</button>`;
        else btnHtml = `<span style="opacity:0.2">-</span>`;

        const tr = document.createElement("tr");
        tr.className = rowClass;
        tr.innerHTML = `
            <td><input type="checkbox" ${linea.ok ? "checked" : ""} onchange="toggleOk(${index}, this.checked)"></td>
            <td><div style="font-weight:600">${linea.mat}</div>${yaAplicada > 0 ? `<div style="font-size:10px; opacity:0.6">Sumado: ${yaAplicada}</div>` : ''}</td>
            <td>${pedida} <span style="font-size:10px;opacity:0.5">${linea.unit || 'ud'}</span></td>
            <td><input type="number" value="${recibida}" oninput="updateQty(${index}, this)"></td>
            <td>${btnHtml}</td>
            <td><input type="text" value="${linea.note || ''}" onchange="updateNote(${index}, this.value)" style="width:100%"></td>`;

        if (linea.unit === 'barra') { hasBarras = true; tbodyBarras.appendChild(tr); }
        else { hasUnidades = true; tbodyUnidades.appendChild(tr); }
    });

    document.getElementById("bloqueBarras").classList.toggle("hidden", !hasBarras);
    document.getElementById("bloqueUnidades").classList.toggle("hidden", !hasUnidades);
    document.getElementById("panelHierro").classList.toggle("hidden", !hasBarras);
}

// === L√ìGICA DE STOCK (CORE) ===
function _db() {
    const raw = LS.getItem(STOCK_DB_KEY);
    const db = raw ? JSON.parse(raw) : { materials:[], movements:[] };
    if(!db.materials) db.materials = [];
    if(!db.movements) db.movements = [];
    return db;
}

function _addToRealStock(baseName, qty, ironType, unit) {
    const db = _db();
    
    // L√≥gica de b√∫squeda
    let candidates = [];
    if (ironType && unit && unit.toLowerCase().includes('barra')) {
      const hint = (ironType === 'negro') ? 'negro' : 'galva';
      const preferred = db.materials.find(m => 
        (m.name||'').trim().toLowerCase() === baseName.trim().toLowerCase() &&
        (((m.grp||'').toLowerCase().includes(hint)) || ((m.cat||'').toLowerCase().includes(hint)))
      );
      if (preferred) return { success: true, mat: preferred, db: db };
    }

    if (ironType) {
        candidates.push(baseName + " " + ironType.charAt(0).toUpperCase() + ironType.slice(1)); 
        candidates.push(baseName + " " + ironType.toLowerCase());
    }
    candidates.push(baseName);

    let mat = null;
    for (let candidate of candidates) {
        mat = db.materials.find(m => m.name.trim().toLowerCase() === candidate.trim().toLowerCase());
        if (mat) break;
    }
    
    // Definimos el nombre que se intentar√° crear si falla
    const searchedName = candidates.length > 0 ? candidates[0] : baseName;

    if (!mat) return { success: false, searchedName: searchedName };

    return { success: true, mat: mat, db: db };
}

// === FUNCI√ìN PRINCIPAL DE GUARDADO ===
function guardarLinea(index) {
    const linea = estadoMateriales[index];
    const recibido = parseFloat(linea.qty_recibida) || 0;
    const yaAplicado = parseFloat(linea.aplicado_qty) || 0;
    const diff = recibido - yaAplicado;

    if (diff <= 0) return; 

    // Validaci√≥n Hierro
    let tipoHierro = null;
    if (linea.unit === 'barra') {
        tipoHierro = metaActual.tipo_hierro; 
        if (!tipoHierro) {
            alert("‚ö†Ô∏è Selecciona el tipo de perfiler√≠a (Galvanizado/Negro) arriba.");
            const p = document.getElementById("panelHierro");
            p.style.boxShadow = "0 0 0 2px #ef4444";
            setTimeout(()=>p.style.boxShadow="none", 2000);
            return;
        }
    }

    // 1. Intentar encontrar y sumar
    const check = _addToRealStock(linea.mat, diff, tipoHierro, linea.unit);

    if (!check.success) {
        // NO EXISTE -> ABRIR MODAL
        abrirModalCreacion({
            name: check.searchedName,
            unit: linea.unit, // Pasamos la unidad original
            diff: diff,       // Pasamos la cantidad calculada
            index: index
        });
        return;
    }

    // SI EXISTE -> ACTUALIZAR DB
    const db = check.db;
    db.movements.push({ id: uuid(), matId: check.mat.id, type: 'in', qty: diff, date: new Date().toISOString() });
    LS.setItem(STOCK_DB_KEY, JSON.stringify(db));

    const newTotal = db.movements.filter(m => m.matId === check.mat.id).reduce((acc, m) => m.type === 'in' ? acc + m.qty : acc - m.qty, 0);

    // Actualizar UI Local
    linea.aplicado_qty = recibido; 
    guardarEstadoLocal();
    
    let msg = `‚úÖ Stock Actualizado.\nMaterial: ${check.mat.name}\nTotal: ${newTotal}`;
    if (tipoHierro && !check.mat.name.toLowerCase().includes(tipoHierro.toLowerCase())) msg += `\n(Se sum√≥ al gen√©rico)`;
    
    alert(msg);
    renderTabla();
}

// === MODAL INTERACTIVO DE CREACI√ìN ===
function abrirModalCreacion(data) {
    pendingCreation = data; // Guardamos contexto
    document.getElementById("modMatName").textContent = data.name;
    
    // Cargar Selects desde DB
    const db = _db();
    const cats = [...new Set(db.materials.map(m => m.cat))].sort();
    
    const selCat = document.getElementById("modCatSelect");
    selCat.innerHTML = `<option value="" disabled selected>-- Elige Categor√≠a --</option>` + 
                       cats.map(c => `<option value="${c}">${c}</option>`).join("");
    
    document.getElementById("modGrpSelect").innerHTML = `<option value="" disabled selected>-- Elige Categor√≠a primero --</option>`;
    
    // Configurar valores por defecto
    document.getElementById("modQtyInput").value = data.diff; // Cantidad del pedido
    document.getElementById("modUnitInput").value = data.unit || "ud"; // Unidad del pedido
    document.getElementById("modMinInput").value = "";

    // Resetear inputs de texto
    document.getElementById("modCatInput").value = "";
    document.getElementById("modGrpInput").value = "";
    document.getElementById("modCatInput").classList.add("hidden");
    document.getElementById("modGrpInput").classList.add("hidden");
    document.getElementById("modCatSelect").classList.remove("hidden");
    document.getElementById("modGrpSelect").classList.remove("hidden");

    document.getElementById("modalCrear").classList.add("active");
}

function cerrarModalCreacion() {
    document.getElementById("modalCrear").classList.remove("active");
    pendingCreation = null;
}

function toggleInput(type) {
    const sel = document.getElementById(type === 'cat' ? "modCatSelect" : "modGrpSelect");
    const inp = document.getElementById(type === 'cat' ? "modCatInput" : "modGrpInput");
    
    if (inp.classList.contains("hidden")) {
        sel.classList.add("hidden");
        inp.classList.remove("hidden");
        inp.focus();
    } else {
        inp.classList.add("hidden");
        sel.classList.remove("hidden");
    }
}

function cargarGruposModal() {
    const db = _db();
    const cat = document.getElementById("modCatSelect").value;
    const grps = [...new Set(db.materials.filter(m => m.cat === cat).map(m => m.grp))].sort();
    
    const selGrp = document.getElementById("modGrpSelect");
    selGrp.innerHTML = `<option value="" disabled selected>-- Elige Grupo --</option>` + 
                       grps.map(g => `<option value="${g}">${g}</option>`).join("");
}

function guardarNuevoMaterial() {
    if (!pendingCreation) return;

    // Obtener valores
    const catInput = document.getElementById("modCatInput");
    const catVal = !catInput.classList.contains("hidden") ? catInput.value.trim() : document.getElementById("modCatSelect").value;
    const grpInput = document.getElementById("modGrpInput");
    const grpVal = !grpInput.classList.contains("hidden") ? grpInput.value.trim() : document.getElementById("modGrpSelect").value;
    
    // Nuevos campos: Cantidad, Unidad, M√≠nimo
    const unitVal = document.getElementById("modUnitInput").value.trim() || "ud";
    const minVal = parseInt(document.getElementById("modMinInput").value) || 0;
    const qtyVal = parseFloat(document.getElementById("modQtyInput").value) || 0;

    if (!catVal || !grpVal) { alert("Por favor, indica Categor√≠a y Grupo."); return; }
    if (qtyVal <= 0) { alert("La cantidad a sumar debe ser mayor que 0."); return; }

    // 1. Crear en DB
    const db = _db();
    const newId = uuid();
    db.materials.push({
        id: newId,
        cat: catVal,
        grp: grpVal,
        name: pendingCreation.name,
        unit: unitVal, 
        min: minVal
    });
    
    // 2. A√±adir Movimiento (usando la cantidad definida por el usuario)
    db.movements.push({
        id: uuid(),
        matId: newId,
        type: 'in',
        qty: qtyVal, // Aqu√≠ usamos el valor editado
        date: new Date().toISOString()
    });

    LS.setItem(STOCK_DB_KEY, JSON.stringify(db));

    // 3. Finalizar (Marcamos la l√≠nea como aplicada seg√∫n lo recibido en el pedido, aunque el stock haya sido diferente)
    const linea = estadoMateriales[pendingCreation.index];
    linea.aplicado_qty = parseFloat(linea.qty_recibida);
    guardarEstadoLocal();
    
    alert(`‚úÖ Ficha creada y stock a√±adido.\n\nUbicaci√≥n: ${catVal} > ${grpVal}\nCantidad sumada: ${qtyVal} ${unitVal}`);
    renderTabla();
    cerrarModalCreacion();
}

// === OTROS HELPERS ===
function toggleOk(index, isChecked) {
    const linea = estadoMateriales[index];
    linea.ok = isChecked;
    if (isChecked) {
        const pedida = parseFloat(linea.qty_pedida) || 0;
        if (pedida > 0) linea.qty_recibida = pedida;
    }
    guardarEstadoLocal();
    renderTabla();
}

function updateQty(index, inputEl) {
    let val = parseFloat(inputEl.value);
    if (isNaN(val)) val = 0;
    const linea = estadoMateriales[index];
    const pedida = parseFloat(linea.qty_pedida) || 0;
    if (pedida > 0 && val > pedida) { val = pedida; inputEl.value = val; inputEl.classList.remove("flash-limit"); void inputEl.offsetWidth; inputEl.classList.add("flash-limit"); }
    if (val < 0) { val = 0; inputEl.value = 0; }
    linea.qty_recibida = val;
    linea.ok = (pedida > 0 && val >= pedida);
    LS.setItem(KP(refActual), JSON.stringify(estadoMateriales));
    inputEl.onblur = () => renderTabla();
}

function updateNote(index, txt) { estadoMateriales[index].note = txt; guardarEstadoLocal(); }
function marcarTodoOk() { estadoMateriales.forEach(l => { l.ok = true; const pedida = parseFloat(l.qty_pedida)||0; if(pedida>0) l.qty_recibida=pedida; }); guardarEstadoLocal(); renderTabla(); }
function guardarEstadoLocal() { LS.setItem(KP(refActual), JSON.stringify(estadoMateriales)); }
function guardarTipoHierro() { const radios=document.getElementsByName("th"); let val=""; radios.forEach(r=>{if(r.checked)val=r.value}); metaActual.tipo_hierro=val; LS.setItem(KM(refActual), JSON.stringify(metaActual)); }

function confirmarTodoRecepcion() {
    const hayBarras = estadoMateriales.some(l => l.unit === 'barra');
    if (hayBarras && !metaActual.tipo_hierro) { alert("‚ö†Ô∏è Selecciona el tipo de perfiler√≠a."); return; }
    const val = parseFloat(document.getElementById("inputUnidades").value) || metaActual.unidades || 0;
    if (val <= 0) { alert("‚õî Indica las UNIDADES."); document.getElementById("inputUnidades").focus(); return; }
    if (!confirm(`Mandar a FABRICACI√ìN:\nUnidades: ${val}`)) return;
    mandarAFabricacion();
}

function mandarAFabricacion() {
    if (!refActual) return;
    const inputVal = document.getElementById("inputUnidades").value;
    const cantidadFinal = parseFloat(inputVal) || 0;
    const rawDb = LS.getItem("ldh_db");
    let db = { deliveries: [] };
    if (rawDb) { try { db = JSON.parse(rawDb); if (!Array.isArray(db.deliveries)) db.deliveries = []; } catch (e) {} }

    const idx = db.deliveries.findIndex(d => d.ref === refActual);
    if (idx >= 0) { if (!db.deliveries[idx].id) db.deliveries.splice(idx, 1); else { alert("‚ö†Ô∏è Pedido ya existente."); return; } }

    const notaHierro = metaActual.tipo_hierro ? `[PERFILER√çA: ${metaActual.tipo_hierro.toUpperCase()}] ` : "";
    const notasFinales = notaHierro + (estadoMateriales.length > 0 ? "Procesado desde Preparaci√≥n." : "");

    db.deliveries.push({
        id: "PED-" + Date.now(),
        client: "Taller / Interno",
        ref: refActual,
        concept: metaActual.concepto || "Sin concepto",
        datePed: new Date().toISOString().split('T')[0],
        datePrev: new Date().toISOString().split('T')[0],
        status: "pendiente",
        priority: "normal",
        total: cantidadFinal,
        delivered: 0,
        history: [],
        notes: notasFinales
    });

    LS.setItem("ldh_db", JSON.stringify(db));
    LS.removeItem(KP(refActual)); LS.removeItem(KM(refActual));
    alert(`‚úÖ Enviado a Fabricaci√≥n.\nUds: ${cantidadFinal}`);
    volverLista();
}

function eliminarPedido() { if (confirm("‚õî ¬øEliminar?")) { LS.removeItem(KP(refActual)); LS.removeItem(KM(refActual)); volverLista(); } }
cargarLista();
</script>
</body>
</html>