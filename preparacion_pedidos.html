<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Preparaci√≥n de pedidos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  /* === ESTILOS BASE === */
  body { margin:0; font-family:Segoe UI,Arial; background:#0b1220; color:#e6edf7; padding:24px; }
  .top { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }

  /* === BOTONES CORPORATIVOS === */
  .btn {
    background:linear-gradient(180deg,#0f3c55,#0b2a3d);
    border:1px solid rgba(255,255,255,.15);
    color:#6dd6ff;
    padding:8px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
    transition: filter 0.2s;
  }
  .btn:hover { filter:brightness(1.15); }

  .btn-danger { background:linear-gradient(180deg,#7f1d1d,#450a0a); border-color:#b91c1c; color:#fecaca; }
  .btn-success { background:linear-gradient(180deg,#14532d,#052e16); border-color:#16a34a; color:#86efac; }

  /* === BOT√ìN MINI === */
  .btn-mini {
    background: linear-gradient(180deg, #0f3c55, #0b2a3d);
    border: 1px solid rgba(255,255,255,.15);
    color: #6dd6ff;
    padding: 5px 12px;
    font-size: 11px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: filter 0.2s, box-shadow 0.2s;
    white-space: nowrap;
    margin-right: 6px;
  }
  .btn-mini:hover { filter: brightness(1.2); box-shadow: 0 0 8px rgba(109, 214, 255, 0.2); }
  .btn-mini.disabled { background: transparent; border: 1px solid rgba(74, 222, 128, 0.2); color: #4ade80; cursor: default; box-shadow: none; filter: none; }

  /* LAYOUT */
  .card { background:linear-gradient(180deg,#0f172a,#020617); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
  .hidden { display:none !important; }
  .section-title { margin:18px 0 6px 0; font-size:13px; color:#9fb0c8; letter-spacing:.08em; font-weight: 700; text-transform: uppercase; }

  /* TABLAS E INPUTS */
  table { width:100%; border-collapse:collapse; margin-top:6px; }
  th, td { border-bottom:1px solid rgba(255,255,255,.08); padding:8px; vertical-align: middle; }
  th { color:#9fb0c8; font-size:12px; text-align:left; }
  input { background:#020617; border:1px solid rgba(255,255,255,.12); color:#e6edf7; border-radius:8px; padding:6px; }
  input[type=number] { width:70px; text-align: center; }
  input:focus { outline: none; border-color: #6dd6ff; }

  /* Input especial Unidades */
  .input-unidades { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 14px; font-weight: bold; width: 60px; text-align: center; border-radius: 6px; padding: 4px; transition: all 0.3s; }
  .input-unidades:focus { border-color: #6dd6ff; background: rgba(0,0,0,0.3); }

  /* Estado Filas */
  tr.ok { background: linear-gradient(180deg, rgba(24,130,72,.28), rgba(12,78,44,.18)); box-shadow: inset 0 0 0 1px rgba(110,255,170,.18); }
  tr.ok td { color: #e9fff1; }
  .flash-limit { animation: clampFlash .5s ease-in-out 1; border-color: #ef4444 !important; }
  @keyframes clampFlash { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } 50% { box-shadow: 0 0 0 4px rgba(239,68,68,0.25); } }

  /* Listado */
  .list { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px; }
  .item { padding:12px; border-radius:12px; background:#020617; border:1px solid rgba(255,255,255,.08); cursor:pointer; transition: border-color 0.2s; }
  .item:hover { border-color:rgba(109,214,255,.35); background: rgba(255,255,255,0.02); }
  .badge { font-size:11px; padding:2px 8px; border-radius:999px; font-weight: bold; text-transform: uppercase; display:inline-flex; align-items:center; gap:6px; }
  .b-p { background:#f59e0b; color:#111; }
  .b-pa { background:#fb923c; color:#111; }
  .b-c { background:#22c55e; color:#111; }
  .b-fab { background:#16a34a; color:#06100a; border:1px solid rgba(255,255,255,.25); }
  .dot { width:8px; height:8px; border-radius:50%; background:currentColor; display:inline-block; }

  /* Control Panel */
  .control-panel { display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:12px; margin: 15px 0; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; }
  .radio-group { display:flex; gap:10px; }
  .radio-btn { display:flex; align-items:center; gap:6px; padding:6px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.3); cursor:pointer; user-select: none; }
  .radio-btn input { margin:0; }
  .actions { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:20px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); }

  /* ======= VINCULACI√ìN ======= */
  .link-pill { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; border:1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.25); color:#9fb0c8; margin-right:6px; }
  .link-pill.ok { color:#86efac; border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
  .link-pill.warn { color:#fbbf24; border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }
  .link-pill.danger { color:#fca5a5; border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); }

  .stock-mini { font-size:11px; opacity:.75; margin-top:4px; display:flex; gap:10px; flex-wrap:wrap; }
  .stock-mini b { opacity:1; }

  /* === MODALES === */
  .modal-backdrop { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); z-index:1000; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; }
  .modal-backdrop.active { opacity:1; pointer-events:auto; }

  .modal-box { width:92%; max-width:760px; background:#0f172a; border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:20px; box-shadow:0 20px 50px rgba(0,0,0,0.5); transform:translateY(20px); transition:transform 0.2s; }
  .modal-backdrop.active .modal-box { transform:translateY(0); }

  .modal-title { font-size:16px; font-weight:bold; color:#fff; margin-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:center; }
  .modal-field { margin-bottom:14px; }
  .modal-label { display:block; font-size:12px; color:#9fb0c8; margin-bottom:5px; font-weight:600; }

  .input-group { display:flex; gap:8px; }
  .modal-select { flex:1; background:#020617; border:1px solid rgba(255,255,255,0.15); color:#fff; padding:8px; border-radius:8px; outline:none; font-family:inherit; }
  .modal-input { flex:1; background:#020617; border:1px solid #38bdf8; color:#fff; padding:8px; border-radius:8px; outline:none; }
  .btn-icon { width:36px; padding:0; display:flex; align-items:center; justify-content:center; font-size:18px; }

  .modal-info { background:rgba(56,189,248,0.1); border:1px solid rgba(56,189,248,0.2); color:#38bdf8; padding:10px; border-radius:8px; font-size:12px; margin-bottom:16px; }

  /* Modal Vincular */
  .link-grid { display:grid; grid-template-columns: 260px 1fr; gap:14px; }
  @media(max-width: 820px){ .link-grid{ grid-template-columns:1fr; } }
  .link-panel { background: rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.10); border-radius:12px; padding:12px; }
  .link-search { display:flex; gap:8px; align-items:center; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); border-radius:10px; padding:8px 10px; margin-bottom:10px; }
  .link-search input { width:100%; background:transparent; border:none; color:#e6edf7; outline:none; padding:0; }
  .link-list { max-height: 420px; overflow:auto; border-radius:10px; border:1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.15); }
  .link-item { padding:10px; border-bottom:1px solid rgba(255,255,255,.06); cursor:pointer; }
  .link-item:hover { background: rgba(255,255,255,.04); }
  .link-item .t { font-weight:800; color:#fff; }
  .link-item .s { font-size:11px; color:#9fb0c8; margin-top:2px; display:flex; justify-content:space-between; gap:10px; }
  .link-item.active { outline:2px solid rgba(56,189,248,.35); background: rgba(56,189,248,.08); }
  .small { font-size:11px; opacity:.75; }

</style>
</head>
<body>

<div class="top">
  <div style="display:flex;gap:10px">
    <button class="btn" onclick="volverIndex()">‚Üê Volver al index</button>
    <button class="btn" onclick="volverLista()">‚Üê Volver a pedidos</button>
  </div>
  <h2 style="margin:0">Preparaci√≥n</h2>
</div>

<div id="vistaLista" class="card">
  <h3 style="margin:0 0 10px 0;">Pedidos en curso</h3>
  <div id="lista" class="list"></div>
</div>

<div id="vistaDetalle" class="card hidden">
  <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:14px;">
      <div>
        <div style="font-size:12px; color:#9fb0c8;">REFERENCIA</div>
        <div style="font-size:18px; font-weight:bold; color:#fff;" id="ref"></div>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px; flex-wrap:wrap;">
            <div style="font-size:14px; color:#6dd6ff;" id="concepto"></div>
            <span id="pillFab" class="badge b-fab hidden"><span class="dot"></span> En fabricaci√≥n</span>
            <div style="display:flex; align-items:center; gap:5px; background:rgba(0,0,0,0.3); padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.1);">
                <span style="font-size:11px; color:#9fb0c8; text-transform:uppercase; font-weight:bold;">Uds:</span>
                <input type="number" id="inputUnidades" class="input-unidades" min="0" onchange="guardarUnidadesManual()">
            </div>
        </div>
      </div>
      <button class="btn btn-success" onclick="marcarTodoOk()">‚úì OK Todo</button>
  </div>

  <div id="panelHierro" class="hidden control-panel">
      <span style="font-weight:700; color:#cbd5e1;">Tipo de Perfiler√≠a:</span>
      <div class="radio-group">
          <label class="radio-btn"><input type="radio" name="th" value="galvanizado" onchange="guardarTipoHierro()"> Galvanizado</label>
          <label class="radio-btn"><input type="radio" name="th" value="negro" onchange="guardarTipoHierro()"> Negro</label>
      </div>
      <span style="font-size:11px; opacity:0.6; margin-left:auto;">(Requerido para guardar barras)</span>
  </div>

  <div id="bloqueBarras" class="hidden">
    <div class="section-title">PERFILER√çA ¬∑ BARRAS</div>
    <table>
      <thead><tr>
        <th width="30">OK</th>
        <th>Material</th>
        <th>Pedida</th>
        <th>Recibida</th>
        <th width="220">Acci√≥n</th>
        <th>Obs</th>
      </tr></thead>
      <tbody id="tbodyBarras"></tbody>
    </table>
  </div>

  <div id="bloqueUnidades" class="hidden">
    <div class="section-title">ACCESORIOS ¬∑ UNIDADES</div>
    <table>
      <thead><tr>
        <th width="30">OK</th>
        <th>Material</th>
        <th>Pedida</th>
        <th>Recibida</th>
        <th width="220">Acci√≥n</th>
        <th>Obs</th>
      </tr></thead>
      <tbody id="tbodyUnidades"></tbody>
    </table>
  </div>

  <div class="actions">
    <button class="btn-danger btn" onclick="eliminarPedido()">üóë Eliminar pedido</button>
    <button class="btn btn-success" onclick="marcarEnFabricacion()">üè≠ Marcar en fabricaci√≥n</button>
    <button class="btn" onclick="confirmarTodoRecepcion()">üíæ Mandar a fabricaci√≥n</button>
  </div>
</div>

<!-- MODAL CREACI√ìN MATERIAL (si no existe en Stock) -->
<div id="modalCrear" class="modal-backdrop">
  <div class="modal-box" style="max-width:540px;">
      <div class="modal-title">
        <span>Crear Ficha de Stock</span>
        <button class="btn" style="background:transparent;border:none;color:#9fb0c8;" onclick="cerrarModalCreacion()">‚úï</button>
      </div>

      <div class="modal-info">
          El material <strong><span id="modMatName"></span></strong> no existe.<br>
          Def√≠nelo para a√±adirlo al stock.
      </div>

      <div class="modal-field">
          <span class="modal-label">CATEGOR√çA</span>
          <div class="input-group">
              <select id="modCatSelect" class="modal-select" onchange="cargarGruposModal()"></select>
              <input id="modCatInput" class="modal-input hidden" placeholder="Nueva Categor√≠a...">
              <button class="btn btn-icon" onclick="toggleInput('cat')">Ôºã</button>
          </div>
      </div>

      <div class="modal-field">
          <span class="modal-label">GRUPO / FAMILIA</span>
          <div class="input-group">
              <select id="modGrpSelect" class="modal-select"></select>
              <input id="modGrpInput" class="modal-input hidden" placeholder="Nuevo Grupo...">
              <button class="btn btn-icon" onclick="toggleInput('grp')">Ôºã</button>
          </div>
      </div>

      <div style="display:flex; gap:12px;">
          <div class="modal-field" style="flex:1;">
              <span class="modal-label">CANTIDAD A SUMAR</span>
              <input id="modQtyInput" type="number" class="modal-select" style="width:100%; box-sizing:border-box; border-color:#38bdf8; color:#38bdf8; font-weight:bold; text-align:center;">
          </div>

          <div class="modal-field" style="flex:1;">
              <span class="modal-label">UNIDAD (Ej: Caja)</span>
              <input id="modUnitInput" class="modal-select" placeholder="ud" style="width:100%; box-sizing:border-box;">
          </div>

          <div class="modal-field" style="width:80px;">
              <span class="modal-label">M√çNIMO</span>
              <input id="modMinInput" type="number" class="modal-select" placeholder="0" style="width:100%; box-sizing:border-box; text-align:center;">
          </div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
          <button class="btn" style="background:transparent; border:none; color:#9fb0c8;" onclick="cerrarModalCreacion()">Cancelar</button>
          <button class="btn btn-success" onclick="guardarNuevoMaterial()">Guardar y A√±adir</button>
      </div>
  </div>
</div>

<!-- MODAL VINCULAR -->
<div id="modalVincular" class="modal-backdrop">
  <div class="modal-box">
    <div class="modal-title">
      <span>Vincular material de Stock</span>
      <button class="btn" style="background:transparent;border:none;color:#9fb0c8;" onclick="cerrarModalVincular()">‚úï</button>
    </div>

    <div class="modal-info" style="margin-bottom:12px;">
      L√≠nea de pedido: <strong id="linkLineName"></strong>
      <div class="small" style="margin-top:6px;">
        Consejo: vincula una vez y el sistema lo recordar√° para pr√≥ximos pedidos con el mismo nombre.
      </div>
    </div>

    <div class="link-grid">
      <div class="link-panel">
        <div class="modal-label" style="margin-bottom:6px;">Buscar</div>
        <div class="link-search">
          <span style="opacity:.75">üîé</span>
          <input id="linkSearch" placeholder="Escribe para filtrar..." autocomplete="off" />
        </div>
        <div class="small">Se muestran materiales del Stock (con categor√≠a y grupo).</div>
      </div>

      <div class="link-panel">
        <div class="modal-label" style="margin-bottom:6px;">Resultados</div>
        <div id="linkResults" class="link-list"></div>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; gap:10px; margin-top:14px; align-items:center; flex-wrap:wrap;">
      <button class="btn btn-danger" onclick="desvincularActual()">Desvincular</button>
      <div style="display:flex; gap:10px; margin-left:auto;">
        <button class="btn" onclick="cerrarModalVincular()">Cancelar</button>
        <button class="btn btn-success" onclick="confirmarVinculo()">Vincular</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase (Compat, sin bundlers) PARA SINCRONIZAR STOCK ONLINE IGUAL QUE TU STOCK.html -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* =======================================================================================
   PREPARACI√ìN DE PEDIDOS (vNEXT)
   - Arregla pill Pendiente/Parcial/Completo: se calcula por RECEPCI√ìN (qty_recibida).
   - Auto-cierra (desaparece de Preparaci√≥n) cuando TODO est√° RECIBIDO (qty_recibida>=qty_pedida).
   - Permite ‚ÄúMandar a fabricaci√≥n‚Äù aunque est√© parcial, pero NO desaparece.
   - A√±ade ‚ÄúEn fabricaci√≥n‚Äù (pill) en la ficha del pedido y en la lista.
   - Muestra stock disponible por l√≠nea (del m√≥dulo Stock).
   - Vinculaci√≥n persistente: recuerda que ‚Äú40x40‚Äù -> ‚Äú40x40x1.5‚Äù etc (global, para futuros pedidos).
   - Mantiene tu l√≥gica de sumar a stock con movimientos "in".
   - NUEVO: Permite CONSUMIR de stock (movimiento "out") con confirmaci√≥n si queda negativo.
   - Sin romper Stock online: usa Firestore doc igual que tu stock.html para leer/escribir stock.
======================================================================================= */

/* ========= CONSTANTES ========= */
const LS = localStorage;
let currentOrderId = null;
const KP = r => "prep_recepcion_" + r;
const KM = r => "prep_meta_" + r;

const STOCK_DB_KEY = "taller_stock_v3_data";
const LINK_MAP_KEY = "prep_stock_linkmap_v1";

/* ========= FIRESTORE (igual que stock.html) ========= */
const USE_FIRESTORE_STOCK = true;
const FIRESTORE_DOC_PATH = { col: "taller_stock", doc: "main" };

const firebaseConfig = {
  apiKey: "AIzaSyDGIfICSG_KE6QzmKHj3CzgvYeHaUcgARo",
  authDomain: "gestion-taller-2a439.firebaseapp.com",
  projectId: "gestion-taller-2a439",
  storageBucket: "gestion-taller-2a439.firebasestorage.app",
  messagingSenderId: "498579673950",
  appId: "1:498579673950:web:eb626781a5b509957db5cf"
};

let fbApp=null, fbAuth=null, fbDb=null;
let fsUnsub=null;
let fsReady=false;
let ignoreNextLocalSave=false;
let pendingSaveTimer=null;

/* ========= STATE ========= */
let refActual = "";
let estadoMateriales = [];
let metaActual = {};
let pendingCreation = null;

let stockMaterials = [];
let stockMovements = [];
let stockCategoryOrder = [];

let linkMap = {}; // { "keyNorm|unit": { matId, name, cat, grp, unit } }
let linkModalCtx = null; // { lineIndex, chosenMatId }

/* ========= HELPERS ========= */
const uuid = () => Math.random().toString(36).substr(2,9);

function normName(s){
  return String(s||"")
    .trim()
    .toLowerCase()
    .replace(/\s+/g," ")
    .replace(/[‚Äô'"]/g,"")
    .replace(/√ó/g,"x");
}
function linkKeyFor(line){
  // clave global por nombre+unidad, para recordar v√≠nculos entre pedidos distintos
  const n = normName(line.mat);
  const u = normName(line.unit || "");
  return `${n}|${u}`;
}
function toNum(x){ const n = Number(x); return isNaN(n)?0:n; }

/* ========= FIRESTORE helpers ========= */
function fbEnsure(){
  if(fbApp) return;
  fbApp = firebase.initializeApp(firebaseConfig);
  fbAuth = firebase.auth();
  fbDb   = firebase.firestore();
}
async function fsLoginHidden(){
  try{
    if(!fbAuth.currentUser){
      await fbAuth.signInAnonymously();
    }
  }catch(e){
    console.warn("Auth an√≥nimo no disponible:", e);
  }
}
function fsDocRef(){
  return fbDb.collection(FIRESTORE_DOC_PATH.col).doc(FIRESTORE_DOC_PATH.doc);
}
async function fsLoadOnceToLocal(){
  const snap = await fsDocRef().get();
  if(!snap.exists) return false;
  const data = snap.data() || {};
  if(!Array.isArray(data.materials) || !Array.isArray(data.movements)) return false;

  ignoreNextLocalSave = true;
  LS.setItem(STOCK_DB_KEY, JSON.stringify({
    materials: data.materials || [],
    movements: data.movements || [],
    categoryOrder: data.categoryOrder || []
  }));
  ignoreNextLocalSave = false;

  stockMaterials = data.materials || [];
  stockMovements = data.movements || [];
  stockCategoryOrder = data.categoryOrder || [];
  return true;
}
function fsStartRealtimeListener(){
  if(fsUnsub) fsUnsub();
  fsUnsub = fsDocRef().onSnapshot((snap)=>{
    if(!snap.exists) return;
    const data = snap.data() || {};
    if(!Array.isArray(data.materials) || !Array.isArray(data.movements)) return;

    ignoreNextLocalSave = true;
    LS.setItem(STOCK_DB_KEY, JSON.stringify({
      materials: data.materials || [],
      movements: data.movements || [],
      categoryOrder: data.categoryOrder || []
    }));
    ignoreNextLocalSave = false;

    stockMaterials = data.materials || [];
    stockMovements = data.movements || [];
    stockCategoryOrder = data.categoryOrder || [];

    // Si estamos dentro de un pedido, refresca stocks mostrados
    if(refActual) renderTabla();
  }, (err)=>console.warn("Firestore onSnapshot error:", err));
}
function scheduleFsSaveStock(){
  if(!USE_FIRESTORE_STOCK || !fsReady) return;
  if(ignoreNextLocalSave) return;

  clearTimeout(pendingSaveTimer);
  pendingSaveTimer = setTimeout(async ()=>{
    try{
      const payload = {
        materials: stockMaterials,
        movements: stockMovements,
        categoryOrder: stockCategoryOrder,
        updatedAt: new Date().toISOString()
      };
      await fsDocRef().set(payload, { merge: true });
    }catch(e){
      console.warn("No se pudo guardar en Firestore:", e);
    }
  }, 450);
}

/* ========= STOCK local ========= */
function loadStockLocal(){
  const raw = LS.getItem(STOCK_DB_KEY);
  const db = raw ? JSON.parse(raw) : { materials:[], movements:[], categoryOrder:[] };
  stockMaterials = Array.isArray(db.materials) ? db.materials : [];
  stockMovements = Array.isArray(db.movements) ? db.movements : [];
  stockCategoryOrder = Array.isArray(db.categoryOrder) ? db.categoryOrder : [];
}
function saveStockLocal(){
  LS.setItem(STOCK_DB_KEY, JSON.stringify({
    materials: stockMaterials,
    movements: stockMovements,
    categoryOrder: stockCategoryOrder
  }));
  scheduleFsSaveStock();
}
function getStockQty(matId){
  return stockMovements
    .filter(m => m.matId === matId)
    .reduce((acc, m) => m.type === 'in' ? acc + toNum(m.qty) : acc - toNum(m.qty), 0);
}
function getMatById(id){
  return stockMaterials.find(m => m.id === id) || null;
}

/* ========= LINKMAP ========= */
function loadLinkMap(){
  try { linkMap = JSON.parse(LS.getItem(LINK_MAP_KEY) || "{}") || {}; }
  catch(e){ linkMap = {}; }
}
function saveLinkMap(){
  LS.setItem(LINK_MAP_KEY, JSON.stringify(linkMap || {}));
}

/* ========= IMPORTACI√ìN DE DATOS DESDE CALCULO/OTROS ========= */
(function verificarImports() {
  const encontrarNumero = (obj) => {
    if (!obj) return null;
    const posiblesKeys = ["cantidad", "unidades", "units", "qty", "quantity", "amount", "totalUnits", "total"];
    for (let key of posiblesKeys) {
      if (obj[key] !== undefined && obj[key] !== null && obj[key] !== "") return parseFloat(obj[key]);
    }
    if (obj.vars) {
      for (let key of posiblesKeys) {
        if (obj.vars[key] !== undefined && obj.vars[key] !== null && obj.vars[key] !== "") return parseFloat(obj.vars[key]);
      }
    }
    return null;
  };

  const snapRaw = LS.getItem("latest_materials_v1");
  if (snapRaw) {
    try {
      const snap = JSON.parse(snapRaw);
      const ref = String(snap.referencia || "SIN_REF_" + Date.now());
      let qty = encontrarNumero(snap) || 1;

      let metaParaGuardar = JSON.parse(LS.getItem(KM(ref)) || "{}");
      metaParaGuardar.referencia = ref;
      metaParaGuardar.concepto = snap.concepto || metaParaGuardar.concepto || "";
      metaParaGuardar.unidades = qty;
      metaParaGuardar.fecha = Date.now();
      if (!metaParaGuardar.tipo_hierro) metaParaGuardar.tipo_hierro = "";
      if (metaParaGuardar.en_fabricacion === undefined) metaParaGuardar.en_fabricacion = false;

      LS.setItem(KM(ref), JSON.stringify(metaParaGuardar));
      if (!LS.getItem(KP(ref))) LS.setItem(KP(ref), JSON.stringify(snap.materiales || []));

      LS.removeItem("latest_materials_v1");
      LS.removeItem("pedido_en_preparacion");
    } catch (e) { console.error("Error importando:", e); }
  }
})();

/* ========= NAVEGACI√ìN ========= */
function volverIndex(){ location.href = "index.html"; }
function volverLista(){
  document.getElementById("vistaDetalle").classList.add("hidden");
  document.getElementById("vistaLista").classList.remove("hidden");
  refActual = "";
  cargarLista();
}

/* ========= LISTA DE PEDIDOS (pill por RECEPCI√ìN) ========= */
function cargarLista() {
  const lista = document.getElementById("lista");
  lista.innerHTML = "";
  const keys = Object.keys(LS).filter(k => k.startsWith("prep_recepcion_"));
  if(keys.length === 0) {
    lista.innerHTML = "<div style='opacity:0.5; padding:20px'>No hay pedidos en preparaci√≥n.</div>";
    return;
  }

  keys.reverse().forEach(k => {
    const ref = k.replace("prep_recepcion_", "");
    const meta = JSON.parse(LS.getItem(KM(ref)) || "{}");
    const lines = JSON.parse(LS.getItem(k) || "[]");
    const totalLines = lines.length;

    // COMPLETO / PARCIAL por RECEPCI√ìN
    const completeLines = lines.filter(l => (toNum(l.qty_recibida)) >= (toNum(l.qty_pedida))).length;
    const anyReceived = lines.some(l => (toNum(l.qty_recibida)) > 0);

    let badgeClass = "b-p"; let badgeText = "Pendiente";
    if (totalLines > 0 && completeLines === totalLines) { badgeClass = "b-c"; badgeText = "Completo"; }
    else if (totalLines > 0 && anyReceived) { badgeClass = "b-pa"; badgeText = "Parcial"; }

    const fab = !!meta.en_fabricacion;

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div style="display:flex;justify-content:space-between;margin-bottom:6px; gap:10px; align-items:flex-start;">
        <span style="font-weight:bold; color:#fff">${ref}</span>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
          ${fab ? `<span class="badge b-fab"><span class="dot"></span> En fabricaci√≥n</span>` : ``}
          <span class="badge ${badgeClass}">${badgeText}</span>
        </div>
      </div>
      <div style="font-size:12px; color:#9fb0c8; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
        ${meta.concepto || "Sin concepto"} (${meta.unidades || 1} uds)
      </div>`;
    item.onclick = () => abrirPedido(ref);
    lista.appendChild(item);
  });
}

/* ========= ABRIR PEDIDO ========= */
function abrirPedido(ref) {
  refActual = ref;
  document.getElementById("vistaLista").classList.add("hidden");
  document.getElementById("vistaDetalle").classList.remove("hidden");

  metaActual = JSON.parse(LS.getItem(KM(ref)) || "{}");
  if (metaActual.en_fabricacion === undefined) metaActual.en_fabricacion = false;

  estadoMateriales = JSON.parse(LS.getItem(KP(ref)) || "[]");

  document.getElementById("ref").textContent = ref;
  document.getElementById("concepto").textContent = metaActual.concepto || "";
  document.getElementById("inputUnidades").value = (metaActual.unidades || 1);
  document.getElementById("pillFab").classList.toggle("hidden", !metaActual.en_fabricacion);

  const radios = document.getElementsByName("th");
  radios.forEach(r => r.checked = (r.value === metaActual.tipo_hierro));

  renderTabla();
}

/* ========= GUARDADOS META ========= */
function guardarUnidadesManual() {
  const val = parseFloat(document.getElementById("inputUnidades").value) || 1;
  metaActual.unidades = val;
  LS.setItem(KM(refActual), JSON.stringify(metaActual));
}
function guardarTipoHierro(){
  const radios=document.getElementsByName("th");
  let val=""; radios.forEach(r=>{if(r.checked)val=r.value});
  metaActual.tipo_hierro=val;
  LS.setItem(KM(refActual), JSON.stringify(metaActual));
}
function marcarEnFabricacion(){
  metaActual.en_fabricacion = true;
  metaActual.fabricacion_ts = Date.now();
  LS.setItem(KM(refActual), JSON.stringify(metaActual));
  document.getElementById("pillFab").classList.remove("hidden");
  cargarLista();
  alert("‚úÖ Marcado como EN FABRICACI√ìN (no se elimina hasta que est√© todo recibido).");
}

/* ========= AUTOCIERRE POR RECEPCI√ìN (lo que t√∫ quieres) ========= */
function autoCerrarSiCompletoPorRecepcion(){
  const totalLines = estadoMateriales.length;
  if(totalLines === 0) return;

  const completeLines = estadoMateriales.filter(l =>
    toNum(l.qty_recibida) >= toNum(l.qty_pedida)
  ).length;

  if(completeLines === totalLines){
    LS.removeItem(KP(refActual));
    LS.removeItem(KM(refActual));
    alert("‚úÖ Pedido completo (material recibido): se ha retirado de Preparaci√≥n.");
    volverLista();
  }
}

/* ========= VINCULACI√ìN: elegir matId de stock para una l√≠nea ========= */
function getLinkedMatIdForLine(line){
  // 1) si l√≠nea ya tiene link expl√≠cito, √∫salo
  if(line.linked_matId && getMatById(line.linked_matId)) return line.linked_matId;

  // 2) si existe mapeo global por nombre+unidad, √∫salo
  const k = linkKeyFor(line);
  const rec = linkMap[k];
  if(rec && rec.matId && getMatById(rec.matId)) return rec.matId;

  return null;
}
function setLinkForLine(index, matId){
  const line = estadoMateriales[index];
  const mat = getMatById(matId);
  if(!mat) return;

  line.linked_matId = matId;

  // guarda global
  const k = linkKeyFor(line);
  linkMap[k] = { matId: matId, name: mat.name, cat: mat.cat, grp: mat.grp, unit: mat.unit };
  saveLinkMap();

  guardarEstadoLocal();
  renderTabla();
  cargarLista();
}
function clearLinkForLine(index){
  const line = estadoMateriales[index];
  line.linked_matId = null;
  guardarEstadoLocal();
  renderTabla();
}

/* ========= MODAL VINCULAR ========= */
function abrirModalVincular(index){
  linkModalCtx = { lineIndex: index, chosenMatId: null };

  const line = estadoMateriales[index];
  document.getElementById("linkLineName").textContent = `${line.mat} (${line.unit || "ud"})`;

  // construir lista
  const input = document.getElementById("linkSearch");
  input.value = "";
  input.oninput = () => renderLinkResults();

  renderLinkResults();
  document.getElementById("modalVincular").classList.add("active");
}
function cerrarModalVincular(){
  document.getElementById("modalVincular").classList.remove("active");
  linkModalCtx = null;
}
function desvincularActual(){
  if(!linkModalCtx) return;
  clearLinkForLine(linkModalCtx.lineIndex);
  cerrarModalVincular();
}
function confirmarVinculo(){
  if(!linkModalCtx || !linkModalCtx.chosenMatId){
    alert("Selecciona un material del listado.");
    return;
  }
  setLinkForLine(linkModalCtx.lineIndex, linkModalCtx.chosenMatId);
  cerrarModalVincular();
}
function renderLinkResults(){
  const host = document.getElementById("linkResults");
  host.innerHTML = "";

  const q = normName(document.getElementById("linkSearch").value || "");
  // const line = linkModalCtx ? estadoMateriales[linkModalCtx.lineIndex] : null;

  let arr = stockMaterials.slice();

  if(q){
    arr = arr.filter(m => {
      const t = normName(`${m.name} ${m.cat} ${m.grp}`);
      return t.includes(q);
    });
  }

  // orden simple: categor√≠a > grupo > nombre
  arr.sort((a,b) => {
    const ac = normName(a.cat).localeCompare(normName(b.cat));
    if(ac!==0) return ac;
    const ag = normName(a.grp).localeCompare(normName(b.grp));
    if(ag!==0) return ag;
    return normName(a.name).localeCompare(normName(b.name));
  });

  if(arr.length===0){
    host.innerHTML = `<div style="padding:12px; opacity:.7;">Sin resultados.</div>`;
    return;
  }

  arr.forEach(m => {
    const qty = getStockQty(m.id);
    const el = document.createElement("div");
    el.className = "link-item" + (linkModalCtx && linkModalCtx.chosenMatId===m.id ? " active" : "");
    el.innerHTML = `
      <div class="t">${m.name}</div>
      <div class="s">
        <span>${m.cat} ‚Ä∫ ${m.grp}</span>
        <span><b>${qty}</b> ${m.unit || ""}</span>
      </div>
    `;
    el.onclick = () => {
      linkModalCtx.chosenMatId = m.id;
      renderLinkResults();
    };
    host.appendChild(el);
  });
}

/* ========= RENDER TABLA (muestra stock y v√≠nculo) ========= */
function renderTabla() {
  const tbodyBarras = document.getElementById("tbodyBarras");
  const tbodyUnidades = document.getElementById("tbodyUnidades");
  tbodyBarras.innerHTML = "";
  tbodyUnidades.innerHTML = "";

  let hasBarras = false;
  let hasUnidades = false;

  // pill fabricaci√≥n
  document.getElementById("pillFab").classList.toggle("hidden", !metaActual.en_fabricacion);

  estadoMateriales.forEach((linea, index) => {
    const pedida = toNum(linea.qty_pedida);
    const recibida = toNum(linea.qty_recibida);
    const yaAplicada = toNum(linea.aplicado_qty);

    // criterio de OK de l√≠nea = RECEPCI√ìN (tu uso real)
    const isComplete = linea.ok || (pedida > 0 && recibida >= pedida);
    const rowClass = isComplete ? "ok" : "";

    // link/stock info
    const linkedId = getLinkedMatIdForLine(linea);
    const linkedMat = linkedId ? getMatById(linkedId) : null;
    const stockQty = linkedId ? getStockQty(linkedId) : null;

    let stockPill = "";
    if(linkedMat){
      // estado stock vs pedida (orientativo)
      const s = toNum(stockQty);
      let cls = "ok";
      if(s <= 0) cls = "danger";
      else if(pedida > 0 && s < pedida) cls = "warn";

      stockPill = `<span class="link-pill ${cls}">Stock: <b>${s}</b> ${linkedMat.unit || ""}</span>`;
    } else {
      stockPill = `<span class="link-pill">Sin v√≠nculo</span>`;
    }

    // bot√≥n a√±adir a stock (usa aplicado_qty para evitar duplicados)
    const diff = recibida - yaAplicada;

    // NUEVO: bot√≥n consumir stock (lo que falta para completar la l√≠nea)
    const falta = Math.max(0, pedida - recibida);

    let btnHtml = "";
    if (diff > 0) {
      btnHtml += `<button class="btn-mini" onclick="guardarLinea(${index})">A√±adir a stock (+${diff})</button>`;
    } else if (yaAplicada > 0) {
      btnHtml += `<button class="btn-mini disabled">‚úÖ OK</button>`;
    } else {
      btnHtml += `<span style="opacity:0.2">-</span>`;
    }

    if (falta > 0) {
      btnHtml += `<button class="btn-mini" onclick="consumirDeStock(${index})">Consumir stock (-${falta})</button>`;
    }

    // bot√≥n vincular siempre disponible
    const btnVincular = `<button class="btn-mini" onclick="abrirModalVincular(${index})">Vincular</button>`;

    const tr = document.createElement("tr");
    tr.className = rowClass;

    tr.innerHTML = `
      <td><input type="checkbox" ${linea.ok ? "checked" : ""} onchange="toggleOk(${index}, this.checked)"></td>
      <td>
        <div style="font-weight:700; color:#fff;">${linea.mat}</div>
        <div class="stock-mini">
          ${stockPill}
          ${linkedMat ? `<span class="small">Vinculado a: <b>${linkedMat.name}</b></span>` : `<span class="small">Pulsa ‚ÄúVincular‚Äù para emparejar con Stock</span>`}
          ${yaAplicada > 0 ? `<span class="small">Sumado a stock: <b>${yaAplicada}</b></span>` : ``}
        </div>
      </td>
      <td>${pedida} <span style="font-size:10px;opacity:0.5">${linea.unit || 'ud'}</span></td>
      <td><input type="number" value="${recibida}" oninput="updateQty(${index}, this)"></td>
      <td>${btnHtml}${btnVincular}</td>
      <td><input type="text" value="${linea.note || ''}" onchange="updateNote(${index}, this.value)" style="width:100%"></td>
    `;

    if ((linea.unit || "").toLowerCase() === 'barra') { hasBarras = true; tbodyBarras.appendChild(tr); }
    else { hasUnidades = true; tbodyUnidades.appendChild(tr); }
  });

  document.getElementById("bloqueBarras").classList.toggle("hidden", !hasBarras);
  document.getElementById("bloqueUnidades").classList.toggle("hidden", !hasUnidades);
  document.getElementById("panelHierro").classList.toggle("hidden", !hasBarras);

  // AUTO-CIERRE por RECEPCI√ìN
  autoCerrarSiCompletoPorRecepcion();
}

/* ========= L√ìGICA DE STOCK: localizar material (v√≠nculo o nombre) ========= */
function _addToRealStock_byLinkedOrName(linea, ironType) {
  // 0) si hay v√≠nculo, usarlo
  const linkedId = getLinkedMatIdForLine(linea);
  if(linkedId){
    const mat = getMatById(linkedId);
    if(mat) return { success:true, mat, matId: linkedId };
  }

  // 1) si no, intentar match por nombre con candidatos (incluye ironType en barras)
  const baseName = String(linea.mat||"");
  let candidates = [];
  if (ironType && (String(linea.unit||"").toLowerCase().includes('barra'))) {
    candidates.push(baseName + " " + ironType.charAt(0).toUpperCase() + ironType.slice(1));
    candidates.push(baseName + " " + ironType.toLowerCase());
  }
  candidates.push(baseName);

  let mat = null;
  for (let candidate of candidates) {
    const cn = normName(candidate);
    mat = stockMaterials.find(m => normName(m.name) === cn);
    if (mat) break;
  }
  const searchedName = candidates.length > 0 ? candidates[0] : baseName;
  if (!mat) return { success:false, searchedName };

  return { success:true, mat, matId: mat.id };
}

/* ========= FUNCI√ìN PRINCIPAL: A√ëADIR A STOCK (movimiento "in") ========= */
function guardarLinea(index) {
  const linea = estadoMateriales[index];
  const recibido = toNum(linea.qty_recibida);
  const yaAplicado = toNum(linea.aplicado_qty);
  const diff = recibido - yaAplicado;

  if (diff <= 0) return;

  // Validaci√≥n Hierro
  let tipoHierro = null;
  if ((String(linea.unit||"").toLowerCase() === 'barra')) {
    tipoHierro = metaActual.tipo_hierro;
    if (!tipoHierro) {
      alert("‚ö†Ô∏è Selecciona el tipo de perfiler√≠a (Galvanizado/Negro) arriba.");
      const p = document.getElementById("panelHierro");
      p.style.boxShadow = "0 0 0 2px #ef4444";
      setTimeout(()=>p.style.boxShadow="none", 2000);
      return;
    }
  }

  // Intentar encontrar
  const check = _addToRealStock_byLinkedOrName(linea, tipoHierro);

  if (!check.success) {
    abrirModalCreacion({
      name: check.searchedName,
      unit: linea.unit,
      diff: diff,
      index: index
    });
    return;
  }

  // Guardar movimiento IN
  stockMovements.push({ id: uuid(), matId: check.matId, type: 'in', qty: diff, date: new Date().toISOString() });
  saveStockLocal();

  // Actualizar aplicado_qty incremental (para no duplicar)
  linea.aplicado_qty = yaAplicado + diff;
  guardarEstadoLocal();

  const newTotal = getStockQty(check.matId);
  let msg = `‚úÖ Stock Actualizado.\nMaterial: ${check.mat.name}\nTotal: ${newTotal}`;

  alert(msg);
  renderTabla();
}

/* ========= NUEVO: CONSUMIR DE STOCK (movimiento "out") ========= */
function consumirDeStock(index){
  const linea = estadoMateriales[index];

  const pedida = toNum(linea.qty_pedida);
  const recibida = toNum(linea.qty_recibida);

  // Consumimos SOLO lo que falta para completar la l√≠nea
  const falta = Math.max(0, pedida - recibida);
  if(falta <= 0){
    alert("Esta l√≠nea ya est√° completa.");
    return;
  }

  // Validaci√≥n Hierro (mismo criterio que para guardar)
  let tipoHierro = null;
  if ((String(linea.unit||"").toLowerCase() === 'barra')) {
    tipoHierro = metaActual.tipo_hierro;
    if (!tipoHierro) {
      alert("‚ö†Ô∏è Selecciona el tipo de perfiler√≠a (Galvanizado/Negro) arriba.");
      const p = document.getElementById("panelHierro");
      p.style.boxShadow = "0 0 0 2px #ef4444";
      setTimeout(()=>p.style.boxShadow="none", 2000);
      return;
    }
  }

  // Localiza material en stock (primero por v√≠nculo, luego por nombre)
  const check = _addToRealStock_byLinkedOrName(linea, tipoHierro);
  if(!check.success){
    alert("Este material no est√° vinculado / no existe en Stock.\nPulsa ‚ÄúVincular‚Äù y selecciona el material correcto antes de consumir.");
    return;
  }

  const matId = check.matId;
  const mat = check.mat;

  const disponible = toNum(getStockQty(matId));
  const quedaria = disponible - falta;

  // Permitir negativo con confirmaci√≥n
  if(quedaria < 0){
    const deficit = Math.abs(quedaria);
    const ok = confirm(
      `Stock insuficiente para consumir.\n\n` +
      `Material: ${mat.name}\n` +
      `Disponible: ${disponible}\n` +
      `Necesario: ${falta}\n\n` +
      `Esto dejar√° el stock en NEGATIVO: -${deficit}\n\n` +
      `¬øConfirmas consumir igualmente?`
    );
    if(!ok) return;
  }

  // Movimiento OUT
  stockMovements.push({
    id: uuid(),
    matId: matId,
    type: 'out',
    qty: falta,
    date: new Date().toISOString(),
    ref: refActual,
    concept: metaActual.concepto || ""
  });
  saveStockLocal();

  // Marcar l√≠nea como cubierta por stock (equivalente a recibido para Preparaci√≥n)
  linea.qty_recibida = recibida + falta;
  linea.ok = (toNum(linea.qty_recibida) >= pedida);

  guardarEstadoLocal();

  alert(`‚úÖ Consumido de stock.\nMaterial: ${mat.name}\nCantidad: ${falta}\nStock actual: ${getStockQty(matId)}`);
  renderTabla();
  cargarLista();
}

/* ========= MODAL CREACI√ìN ========= */
function abrirModalCreacion(data) {
  pendingCreation = data;
  document.getElementById("modMatName").textContent = data.name;

  // Cargar selects desde stock
  const cats = [...new Set(stockMaterials.map(m => m.cat).filter(Boolean))].sort();

  const selCat = document.getElementById("modCatSelect");
  selCat.innerHTML = `<option value="" disabled selected>-- Elige Categor√≠a --</option>` +
                     cats.map(c => `<option value="${c}">${c}</option>`).join("");

  document.getElementById("modGrpSelect").innerHTML = `<option value="" disabled selected>-- Elige Categor√≠a primero --</option>`;

  document.getElementById("modQtyInput").value = data.diff;
  document.getElementById("modUnitInput").value = data.unit || "ud";
  document.getElementById("modMinInput").value = "";

  // Reset
  document.getElementById("modCatInput").value = "";
  document.getElementById("modGrpInput").value = "";
  document.getElementById("modCatInput").classList.add("hidden");
  document.getElementById("modGrpInput").classList.add("hidden");
  document.getElementById("modCatSelect").classList.remove("hidden");
  document.getElementById("modGrpSelect").classList.remove("hidden");

  document.getElementById("modalCrear").classList.add("active");
}
function cerrarModalCreacion() {
  document.getElementById("modalCrear").classList.remove("active");
  pendingCreation = null;
}
function toggleInput(type) {
  const sel = document.getElementById(type === 'cat' ? "modCatSelect" : "modGrpSelect");
  const inp = document.getElementById(type === 'cat' ? "modCatInput" : "modGrpInput");

  if (inp.classList.contains("hidden")) {
    sel.classList.add("hidden");
    inp.classList.remove("hidden");
    inp.focus();
  } else {
    inp.classList.add("hidden");
    sel.classList.remove("hidden");
  }
}
function cargarGruposModal() {
  const cat = document.getElementById("modCatSelect").value;
  const grps = [...new Set(stockMaterials.filter(m => m.cat === cat).map(m => m.grp).filter(Boolean))].sort();

  const selGrp = document.getElementById("modGrpSelect");
  selGrp.innerHTML = `<option value="" disabled selected>-- Elige Grupo --</option>` +
                     grps.map(g => `<option value="${g}">${g}</option>`).join("");
}
function guardarNuevoMaterial() {
  if (!pendingCreation) return;

  const catInput = document.getElementById("modCatInput");
  const catVal = !catInput.classList.contains("hidden") ? catInput.value.trim() : document.getElementById("modCatSelect").value;
  const grpInput = document.getElementById("modGrpInput");
  const grpVal = !grpInput.classList.contains("hidden") ? grpInput.value.trim() : document.getElementById("modGrpSelect").value;

  const unitVal = document.getElementById("modUnitInput").value.trim() || "ud";
  const minVal = parseInt(document.getElementById("modMinInput").value) || 0;
  const qtyVal = parseFloat(document.getElementById("modQtyInput").value) || 0;

  if (!catVal || !grpVal) { alert("Por favor, indica Categor√≠a y Grupo."); return; }
  if (qtyVal <= 0) { alert("La cantidad a sumar debe ser mayor que 0."); return; }

  // Crear material en stock
  const newId = uuid();
  stockMaterials.push({
    id: newId,
    cat: catVal,
    grp: grpVal,
    name: pendingCreation.name,
    unit: unitVal,
    min: minVal
  });

  stockMovements.push({
    id: uuid(),
    matId: newId,
    type: 'in',
    qty: qtyVal,
    date: new Date().toISOString()
  });

  saveStockLocal();

  // Vincular esta l√≠nea autom√°ticamente al nuevo material + marcar aplicado incremental
  const linea = estadoMateriales[pendingCreation.index];
  linea.linked_matId = newId;

  const k = linkKeyFor(linea);
  linkMap[k] = { matId: newId, name: pendingCreation.name, cat: catVal, grp: grpVal, unit: unitVal };
  saveLinkMap();

  linea.aplicado_qty = toNum(linea.aplicado_qty) + qtyVal;
  guardarEstadoLocal();

  alert(`‚úÖ Ficha creada y stock a√±adido.\n\nUbicaci√≥n: ${catVal} > ${grpVal}\nCantidad sumada: ${qtyVal} ${unitVal}`);
  cerrarModalCreacion();
  renderTabla();
}

/* ========= OTROS HELPERS ========= */
function toggleOk(index, isChecked) {
  const linea = estadoMateriales[index];
  linea.ok = isChecked;
  if (isChecked) {
    const pedida = toNum(linea.qty_pedida);
    if (pedida > 0) linea.qty_recibida = pedida;
  }
  guardarEstadoLocal();
  renderTabla();
  cargarLista();
}
function updateQty(index, inputEl) {
  let val = parseFloat(inputEl.value);
  if (isNaN(val)) val = 0;
  const linea = estadoMateriales[index];
  const pedida = toNum(linea.qty_pedida);

  if (pedida > 0 && val > pedida) {
    val = pedida;
    inputEl.value = val;
    inputEl.classList.remove("flash-limit"); void inputEl.offsetWidth; inputEl.classList.add("flash-limit");
  }
  if (val < 0) { val = 0; inputEl.value = 0; }

  linea.qty_recibida = val;

  // OK por recepci√≥n
  linea.ok = (pedida > 0 && val >= pedida);

  guardarEstadoLocal();
  inputEl.onblur = () => { renderTabla(); cargarLista(); };
}
function updateNote(index, txt) { estadoMateriales[index].note = txt; guardarEstadoLocal(); }
function marcarTodoOk() {
  estadoMateriales.forEach(l => {
    l.ok = true;
    const pedida = toNum(l.qty_pedida);
    if(pedida > 0) l.qty_recibida = pedida;
  });
  guardarEstadoLocal();
  renderTabla();
  cargarLista();
}
function guardarEstadoLocal() { LS.setItem(KP(refActual), JSON.stringify(estadoMateriales)); }

/* ========= MANDAR A FABRICACI√ìN (NO ELIMINA PREPARACI√ìN) ========= */
function confirmarTodoRecepcion() {
  const hayBarras = estadoMateriales.some(l => (String(l.unit||"").toLowerCase() === 'barra'));
  if (hayBarras && !metaActual.tipo_hierro) { alert("‚ö†Ô∏è Selecciona el tipo de perfiler√≠a."); return; }

  const val = parseFloat(document.getElementById("inputUnidades").value) || metaActual.unidades || 0;
  if (val <= 0) { alert("‚õî Indica las UNIDADES."); document.getElementById("inputUnidades").focus(); return; }

  // Permite mandar aunque no est√© completo
  if (!confirm(`Mandar a FABRICACI√ìN:\nUnidades: ${val}\n\n(El pedido seguir√° en Preparaci√≥n hasta que todo el material est√© recibido.)`)) return;
  mandarAFabricacion();
}

function mandarAFabricacion() {
  if (!refActual) return;

  const cantidadFinal = parseFloat(document.getElementById("inputUnidades").value) || 0;

  // Guardar/actualizar en Fabricaci√≥n (ldh_db) SIN romper tu estructura
  const rawDb = LS.getItem("ldh_db");
  let db = { deliveries: [] };
  if (rawDb) { try { db = JSON.parse(rawDb); if (!Array.isArray(db.deliveries)) db.deliveries = []; } catch (e) {} }

  // Si ya existe, no duplicamos: actualizamos estado y notas
  const idx = db.deliveries.findIndex(d => d.ref === refActual);

  const notaHierro = metaActual.tipo_hierro ? `[PERFILER√çA: ${metaActual.tipo_hierro.toUpperCase()}] ` : "";
  const notasFinales = notaHierro + "Enviado desde Preparaci√≥n.";

  if (idx >= 0) {
    // Actualiza m√≠nimamente sin destruir historial
    db.deliveries[idx].total = cantidadFinal;
    if (!db.deliveries[idx].notes) db.deliveries[idx].notes = "";
    if (!db.deliveries[idx].notes.includes("Enviado desde Preparaci√≥n")) {
      db.deliveries[idx].notes = (db.deliveries[idx].notes ? (db.deliveries[idx].notes + "\n") : "") + notasFinales;
    }
  } else {
    db.deliveries.push({
      id: "PED-" + Date.now(),
      client: "Taller / Interno",
      ref: refActual,
      concept: metaActual.concepto || "Sin concepto",
      datePed: new Date().toISOString().split('T')[0],
      datePrev: new Date().toISOString().split('T')[0],
      status: "pendiente",
      priority: "normal",
      total: cantidadFinal,
      delivered: 0,
      history: [],
      notes: notasFinales
    });
  }

  LS.setItem("ldh_db", JSON.stringify(db));

  // Marcar en fabricaci√≥n (pero NO eliminar preparaci√≥n)
  metaActual.en_fabricacion = true;
  metaActual.fabricacion_ts = metaActual.fabricacion_ts || Date.now();
  LS.setItem(KM(refActual), JSON.stringify(metaActual));

  document.getElementById("pillFab").classList.remove("hidden");
  alert(`‚úÖ Enviado a Fabricaci√≥n.\nUds: ${cantidadFinal}\n\n(Queda en Preparaci√≥n hasta completar recepci√≥n.)`);
  cargarLista();
}

/* ========= ELIMINAR ========= */
function eliminarPedido() {
  if (confirm("‚õî ¬øEliminar?")) {
    LS.removeItem(KP(refActual));
    LS.removeItem(KM(refActual));
    volverLista();
  }
}

/* ========= INIT ========= */
async function init(){
  loadLinkMap();
  loadStockLocal();

  // Firestore stock sync (online)
  if(USE_FIRESTORE_STOCK){
    try{
      fbEnsure();
      await fsLoginHidden();
      await fsLoadOnceToLocal(); // si existe remoto, actualiza local
      fsReady = true;
      fsStartRealtimeListener();
    }catch(e){
      console.warn("Firestore no disponible, seguimos con local stock:", e);
      fsReady = false;
    }
  }

  cargarLista();
}
init();
</script>

</body>
</html>
